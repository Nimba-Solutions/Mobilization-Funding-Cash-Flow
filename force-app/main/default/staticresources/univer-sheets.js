(function(g,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/core"),require("@univerjs/engine-formula"),require("@univerjs/rpc"),require("rxjs"),require("@univerjs/engine-numfmt"),require("rxjs/operators")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/engine-formula","@univerjs/rpc","rxjs","@univerjs/engine-numfmt","rxjs/operators"],i):(g=typeof globalThis<"u"?globalThis:g||self,i(g.UniverSheets={},g.UniverCore,g.UniverEngineFormula,g.UniverRpc,g.rxjs,g.UniverEngineNumfmt,g.rxjs.operators))})(this,function(g,i,z,Ti,A,On,bt){"use strict";var Sd=Object.defineProperty;var Cd=(g,i,z)=>i in g?Sd(g,i,{enumerable:!0,configurable:!0,writable:!0,value:z}):g[i]=z;var f=(g,i,z)=>Cd(g,typeof i!="symbol"?i+"":i,z);var Js=(s=>(s.OthersCanView="othersCanView",s.NoOneElseCanView="noOneElseCanView",s))(Js||{}),Xs=(s=>(s.DesignedUserCanEdit="designedUserCanEdit",s.OnlyMe="onlyMe",s))(Xs||{});class J{constructor(){f(this,"_model",new Map);f(this,"_ruleChange$",new A.Subject);f(this,"ruleChange$",this._ruleChange$.asObservable());f(this,"_ruleRefresh$",new A.Subject);f(this,"ruleRefresh$",this._ruleRefresh$.asObservable());f(this,"_rangeRuleInitStateChange",new A.BehaviorSubject(!1));f(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}dispose(){this._ruleChange$.complete(),this._ruleRefresh$.complete()}ruleRefresh(e){this._ruleRefresh$.next(e)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(e){this._rangeRuleInitStateChange.next(e)}addRule(e,t,n){this._ensureRuleMap(e,t).set(n.id,n),this._ruleChange$.next({unitId:e,subUnitId:t,rule:n,type:"add"})}deleteRule(e,t,n){var r,a,l,u;const o=(a=(r=this._model.get(e))==null?void 0:r.get(t))==null?void 0:a.get(n);o&&((u=(l=this._model.get(e))==null?void 0:l.get(t))==null||u.delete(n),this._ruleChange$.next({unitId:e,subUnitId:t,rule:o,type:"delete"}))}setRule(e,t,n,o){var a,l;const r=this.getRule(e,t,n);r&&((l=(a=this._model.get(e))==null?void 0:a.get(t))==null||l.set(n,o),this._ruleChange$.next({unitId:e,subUnitId:t,oldRule:r,rule:o,type:"set"}))}getRule(e,t,n){var o,r;return(r=(o=this._model.get(e))==null?void 0:o.get(t))==null?void 0:r.get(n)}getSubunitRuleList(e,t){var o;return[...(((o=this._model.get(e))==null?void 0:o.get(t))||new Map).values()]}getSubunitRuleListLength(e,t){var o;const n=(o=this._model.get(e))==null?void 0:o.get(t);return n?n.size:0}_ensureRuleMap(e,t){let n=this._model.get(e);n||(n=new Map,this._model.set(e,n));let o=n.get(t);return o||(o=new Map,n.set(t,o)),o}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n),r=[...o.keys()];e[n]={},r.forEach(a=>{const l=o.get(a);e[n][a]=[...l.values()]})}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const o=e[n],r=new Map;Object.keys(o).forEach(a=>{const l=o[a].reduce((u,d)=>(u.set(d.id,d),u),new Map);r.set(a,l)}),t.set(n,r)}),this._model=t}deleteUnitModel(e){this._model.delete(e)}createRuleId(e,t){let n=i.Tools.generateRandomId(4);const o=this._ensureRuleMap(e,t);for(;o.has(n);)n=i.Tools.generateRandomId(4);return n}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[o,r]of n)for(const a of r.values())if(a.permissionId===t)return[e,o];return null}}const Ui=(s,e)=>{const t=s.get(J),n=e.ruleIds.map(r=>t.getRule(e.unitId,e.subUnitId,r)).filter(r=>!!r);return{id:ue.id,params:{subUnitId:e.subUnitId,unitId:e.unitId,rules:n}}},pe={id:"sheet.mutation.delete-range-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,ruleIds:o}=e,r=s.get(J);return o.forEach(a=>{r.deleteRule(t,n,a)}),!0}},Pi=s=>{const e={...s,ruleIds:s.rules.map(t=>t.id)};return{id:pe.id,params:e}},ue={id:"sheet.mutation.add-range-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,rules:o}=e,r=s.get(J);return o.forEach(a=>{r.addRule(t,n,a)}),!0}},Zs={type:i.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(J),{rule:r,permissionId:a}=e,{unitId:l,subUnitId:u,ranges:d,description:c,viewState:m,editState:h}=r,R=[{ranges:d,permissionId:a,id:o.createRuleId(l,u),description:c,unitType:r.unitType,unitId:l,subUnitId:u,viewState:m,editState:h}];if(await t.executeCommand(ue.id,{unitId:l,subUnitId:u,rules:R})){const C=[{id:ue.id,params:{unitId:l,subUnitId:u,rules:R}}],I=[{id:pe.id,params:{unitId:l,subUnitId:u,ruleIds:R.map(v=>v.id)}}];n.pushUndoRedo({unitID:l,redoMutations:C,undoMutations:I})}return!0}};class we{constructor(){f(this,"_model",new Map);f(this,"_ruleChange",new A.Subject);f(this,"_ruleRefresh",new A.Subject);f(this,"_resetOrder",new A.Subject);f(this,"ruleChange$",this._ruleChange.asObservable());f(this,"ruleRefresh$",this._ruleRefresh.asObservable());f(this,"resetOrder$",this._resetOrder.asObservable());f(this,"_worksheetRuleInitStateChange",new A.BehaviorSubject(!1));f(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(e){this._worksheetRuleInitStateChange.next(e)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(e,t){this._ensureSubUnitMap(e).set(t.subUnitId,t),this._ruleChange.next({unitId:e,rule:t,type:"add",subUnitId:t.subUnitId})}deleteRule(e,t){var o,r,a;const n=(r=(o=this._model)==null?void 0:o.get(e))==null?void 0:r.get(t);n&&((a=this._model.get(e))==null||a.delete(t),this._ruleChange.next({unitId:e,rule:n,type:"delete",subUnitId:t}))}setRule(e,t,n){var r,a;const o=this.getRule(e,t);o&&((a=(r=this._model)==null?void 0:r.get(e))==null||a.set(t,n),this._ruleChange.next({unitId:e,oldRule:o,rule:n,type:"set",subUnitId:t}))}getRule(e,t){var n,o;return(o=(n=this._model)==null?void 0:n.get(e))==null?void 0:o.get(t)}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n);o!=null&&o.size&&(e[n]=[],[...o.keys()].forEach(a=>{const l=o.get(a);l&&e[n].push(l)}))}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const o=e[n];if(o!=null&&o.length){const r=new Map;o.forEach(a=>{r.set(a.subUnitId,a)}),t.set(n,r)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=new Map,this._model.set(e,t)),t}ruleRefresh(e){this._ruleRefresh.next(e)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[o,r]of n)if(r.permissionId===t)return[e,o]}}const Ve={id:"sheet.mutation.add-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,rule:n}=e;return s.get(we).addRule(t,n),!0}},Ge={id:"sheet.mutation.delete-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n}=e;return s.get(we).deleteRule(t,n),!0}},xs={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-protection",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,unitId:r}=e,a=o.subUnitId;if(await t.executeCommand(Ve.id,{unitId:r,rule:o,subUnitId:o.subUnitId})){const u=[{id:Ve.id,params:{unitId:r,rule:o,subUnitId:o.subUnitId}}],d=[{id:Ge.id,params:{unitId:r,subUnitId:a}}];n.pushUndoRedo({unitID:r,redoMutations:u,undoMutations:d})}return!0}},ki=i.createInterceptorKey("CELL_CONTENT"),Oi=i.createInterceptorKey("ROW_FILTERED"),Pe={CELL_CONTENT:ki,ROW_FILTERED:Oi};var Qs=(s=>(s[s.DATA_VALIDATION=9]="DATA_VALIDATION",s[s.NUMFMT=10]="NUMFMT",s[s.CELL_IMAGE=11]="CELL_IMAGE",s))(Qs||{});const eo="sheet.interceptor.range-theme-id",to="sheet.interceptor.ignore-range-theme";var Ni=Object.getOwnPropertyDescriptor,Di=(s,e,t,n)=>{for(var o=n>1?void 0:n?Ni(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ai=(s,e)=>(t,n)=>e(t,n,s);const Nn=i.createInterceptorKey("BEFORE_CELL_EDIT"),Kt=i.createInterceptorKey("AFTER_CELL_EDIT"),Jt=i.createInterceptorKey("VALIDATE_CELL");g.SheetInterceptorService=class extends i.Disposable{constructor(t){super();f(this,"_interceptorsByName",new Map);f(this,"_commandInterceptors",[]);f(this,"_rangeInterceptors",[]);f(this,"_beforeCommandInterceptor",[]);f(this,"_afterCommandInterceptors",[]);f(this,"_workbookDisposables",new Map);f(this,"_worksheetDisposables",new Map);f(this,"_interceptorsDirty",!1);f(this,"_composedInterceptorByKey",new Map);f(this,"writeCellInterceptor",new i.InterceptorManager({BEFORE_CELL_EDIT:Nn,AFTER_CELL_EDIT:Kt,VALIDATE_CELL:Jt}));this._univerInstanceService=t,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._interceptWorkbook(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>this._disposeWorkbookInterceptor(n))),this.intercept(Pe.CELL_CONTENT,{priority:-1,effect:i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value,handler(n,o){const r=o.worksheet.getCellRaw(o.row,o.col);return n?{...r,...n}:r}}),this.disposeWithMe(this.writeCellInterceptor.intercept(Kt,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(Nn,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(Jt,{priority:-1,handler:n=>n}))}dispose(){super.dispose(),this._workbookDisposables.forEach(t=>t.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.clear(),this._interceptorsByName.clear()}interceptCommand(t){if(this._commandInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(t),this._commandInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._commandInterceptors,t)))}onCommandExecute(t){const n=this._commandInterceptors.map(o=>o.getMutations(t));return{preUndos:n.map(o=>{var r;return(r=o.preUndos)!=null?r:[]}).flat(),undos:n.map(o=>o.undos).flat(),preRedos:n.map(o=>{var r;return(r=o.preRedos)!=null?r:[]}).flat(),redos:n.map(o=>o.redos).flat()}}interceptAfterCommand(t){if(this._afterCommandInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._afterCommandInterceptors.push(t),this._afterCommandInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._afterCommandInterceptors,t)))}afterCommandExecute(t){const n=this._afterCommandInterceptors.map(o=>o.getMutations(t));return{undos:n.map(o=>o.undos).flat(),redos:n.map(o=>o.redos).flat()}}interceptBeforeCommand(t){if(this._beforeCommandInterceptor.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(t),this._beforeCommandInterceptor.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._beforeCommandInterceptor,t)))}async beforeCommandExecute(t){return(await Promise.all(this._beforeCommandInterceptor.map(o=>o.performCheck(t)))).every(o=>o)}interceptRanges(t){if(this._rangeInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(t),this._rangeInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._rangeInterceptors,t)))}generateMutationsByRanges(t){const n=this._rangeInterceptors.map(o=>o.getMutations(t));return{preUndos:n.map(o=>{var r;return(r=o.preUndos)!=null?r:[]}).flat(),undos:n.map(o=>o.undos).flat(),preRedos:n.map(o=>{var r;return(r=o.preRedos)!=null?r:[]}).flat(),redos:n.map(o=>o.redos).flat()}}onWriteCell(t,n,o,r,a){const l={subUnitId:n.getSheetId(),unitId:t.getUnitId(),workbook:t,worksheet:n,row:o,col:r,origin:i.Tools.deepClone(a)};return this.writeCellInterceptor.fetchThroughInterceptors(Kt)(a,l)}onValidateCell(t,n,o,r){const a={subUnitId:n.getSheetId(),unitId:t.getUnitId(),workbook:t,worksheet:n,row:o,col:r};return this.writeCellInterceptor.fetchThroughInterceptors(Jt)(Promise.resolve(!0),a)}intercept(t,n){const o=t;this._interceptorsByName.has(o)||this._interceptorsByName.set(o,[]);const r=this._interceptorsByName.get(o);r.push(n);const a=r.sort((l,u)=>{var d,c;return((d=u.priority)!=null?d:0)-((c=l.priority)!=null?c:0)});if(this._interceptorsDirty=!0,o===Pe.CELL_CONTENT){const l=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;this._interceptorsByName.set(`${o}-${l}`,a);const u=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;return this._interceptorsByName.set(`${o}-${i.InterceptorEffectEnum.Style}`,a.filter(d=>((d.effect||u)&i.InterceptorEffectEnum.Style)>0)),this._interceptorsByName.set(`${o}-${i.InterceptorEffectEnum.Value}`,a.filter(d=>((d.effect||u)&i.InterceptorEffectEnum.Value)>0)),this.disposeWithMe(i.toDisposable(()=>{i.remove(this._interceptorsByName.get(o),n),i.remove(this._interceptorsByName.get(`${o}-${l}`),n),i.remove(this._interceptorsByName.get(`${o}-${i.InterceptorEffectEnum.Style}`),n),i.remove(this._interceptorsByName.get(`${o}-${i.InterceptorEffectEnum.Value}`),n)}))}else return this._interceptorsByName.set(o,a),this.disposeWithMe(i.toDisposable(()=>i.remove(this._interceptorsByName.get(o),n)))}fetchThroughInterceptors(t,n,o,r){const a=n===void 0?t:`${t}-${n}`,l=o!=null?o:a;let u=this._composedInterceptorByKey.get(l);if(!u||this._interceptorsDirty){let d=this._interceptorsByName.get(a);d&&r&&(d=d.filter(r)),u=i.composeInterceptors(d||[]),this._composedInterceptorByKey.set(l,u)}return u}_interceptWorkbook(t){const n=new i.DisposableCollection,o=t.getUnitId(),r=this,a=l=>{const u=l.getSheetId();l.__interceptViewModel(d=>{const c=new i.DisposableCollection;r._worksheetDisposables.set(no(o,l),c),c.add(d.registerCellContentInterceptor({getCell(m,h,R,S,C){const I=l.getCellRaw(m,h);return r.fetchThroughInterceptors(Pe.CELL_CONTENT,R,S,C)(I,{unitId:o,subUnitId:u,row:m,col:h,worksheet:l,workbook:t,rawData:I})}})),c.add(d.registerRowFilteredInterceptor({getRowFiltered(m){return!!r.fetchThroughInterceptors(Pe.ROW_FILTERED)(!1,{unitId:o,subUnitId:u,row:m,workbook:t,worksheet:l})}}))})};t.getSheets().forEach(l=>a(l)),n.add(t.sheetCreated$.subscribe(l=>a(l))),n.add(i.toDisposable(()=>t.getSheets().forEach(l=>this._disposeSheetInterceptor(o,l)))),n.add(t.sheetDisposed$.subscribe(l=>this._disposeSheetInterceptor(o,l))),this._workbookDisposables.set(o,n)}_disposeWorkbookInterceptor(t){const n=t.getUnitId(),o=this._workbookDisposables.get(n);o&&(o.dispose(),this._workbookDisposables.delete(n))}_disposeSheetInterceptor(t,n){const o=no(t,n),r=this._worksheetDisposables.get(o);r&&(r.dispose(),this._worksheetDisposables.delete(o))}},g.SheetInterceptorService=Di([Ai(0,i.IUniverInstanceService)],g.SheetInterceptorService);function no(s,e){return`${s}|${e.getSheetId()}`}const X=s=>{const e={};return s.bg&&(e.bg={...s.bg}),s.ol&&(e.ol={...s.ol}),s.bd&&(e.bd={...s.bd}),s.cl&&(e.cl={...s.cl}),s.ht&&(e.ht=s.ht),s.vt&&(e.vt=s.vt),s.bl!==void 0&&(e.bl=s.bl),e};function Wi(s){const e={};if(s.length===1)return s[0];for(const t of s)t.bg&&(e.bg=t.bg),t.ol&&(e.ol=t.ol),t.bd&&(e.bd={...e.bd,...t.bd}),t.cl&&(e.cl=t.cl),t.ht&&(e.ht=t.ht),t.vt&&(e.vt=t.vt),t.bl!==void 0&&(e.bl=t.bl);return e}const Z={wholeStyle:1,headerRowStyle:2,headerColumnStyle:4,firstRowStyle:8,secondRowStyle:16,lastRowStyle:32,firstColumnStyle:128,secondColumnStyle:256,lastColumnStyle:512};class ke{constructor(e,t){f(this,"_name");f(this,"wholeStyle",null);f(this,"headerRowStyle",null);f(this,"headerColumnStyle",null);f(this,"firstRowStyle",null);f(this,"secondRowStyle",null);f(this,"lastRowStyle",null);f(this,"firstColumnStyle",null);f(this,"secondColumnStyle",null);f(this,"lastColumnStyle",null);f(this,"_mergeCacheMap",new Map);t&&this.fromJson({...t,name:e}),this._name=e}getName(){return this._name}getWholeStyle(){return this.wholeStyle}setWholeStyle(e){this.wholeStyle=e,this._resetStyleCache()}getFirstRowStyle(){return this.firstRowStyle}setFirstRowStyle(e){this.firstRowStyle=e,this._resetStyleCache()}getSecondRowStyle(){return this.secondRowStyle}setSecondRowStyle(e){this.secondRowStyle=e,this._resetStyleCache()}getLastRowStyle(){return this.lastRowStyle}setLastRowStyle(e){this.lastRowStyle=e,this._resetStyleCache()}getFirstColumnStyle(){return this.firstColumnStyle}setFirstColumnStyle(e){this.firstColumnStyle=e,this._resetStyleCache()}getSecondColumnStyle(){return this.secondColumnStyle}setSecondColumnStyle(e){this.secondColumnStyle=e,this._resetStyleCache()}getLastColumnStyle(){return this.lastColumnStyle}setLastColumnStyle(e){this.lastColumnStyle=e,this._resetStyleCache()}getHeaderRowStyle(){return this.headerRowStyle}setHeaderRowStyle(e){this.headerRowStyle=e,this._resetStyleCache()}getHeaderColumnStyle(){return this.headerColumnStyle}setHeaderColumnStyle(e){this.headerColumnStyle=e,this._resetStyleCache()}getStyle(e,t,n,o){let r=0;return n&&(r=r|Z.lastRowStyle),o&&(r=r|Z.lastColumnStyle),e>=0&&t>=0&&(r=r|Z.wholeStyle),e%2===1&&(r=r|Z.firstRowStyle),e%2===0&&(r=r|Z.secondRowStyle),e===0&&(r=r|Z.headerRowStyle),t===0&&(r=r|Z.headerColumnStyle),t%2===1&&(r=r|Z.firstColumnStyle),t%2===0&&(r=r|Z.secondColumnStyle),r===0?null:this._getMergeStyle(r)}_getMergeStyle(e){let t=this._mergeCacheMap.get(e);return t||(t=this._mergeStyle(e),this._mergeCacheMap.set(e,t)),t}_mergeStyle(e){const t=[];return this.wholeStyle&&e&Z.wholeStyle&&t.push(this.wholeStyle),this.firstColumnStyle&&e&Z.firstColumnStyle&&t.push(this.firstColumnStyle),this.secondColumnStyle&&e&Z.secondColumnStyle&&t.push(this.secondColumnStyle),this.firstRowStyle&&e&Z.firstRowStyle&&t.push(this.firstRowStyle),this.secondRowStyle&&e&Z.secondRowStyle&&t.push(this.secondRowStyle),this.headerColumnStyle&&e&Z.headerColumnStyle&&t.push(this.headerColumnStyle),this.lastColumnStyle&&e&Z.lastColumnStyle&&t.push(this.lastColumnStyle),this.headerRowStyle&&e&Z.headerRowStyle&&t.push(this.headerRowStyle),this.lastRowStyle&&e&Z.lastRowStyle&&t.push(this.lastRowStyle),Wi(t)}_resetStyleCache(){this._mergeCacheMap.clear()}toJson(){const e={name:this._name};return this.wholeStyle&&(e.wholeStyle=X(this.wholeStyle)),this.headerRowStyle&&(e.headerRowStyle=X(this.headerRowStyle)),this.headerColumnStyle&&(e.headerColumnStyle=X(this.headerColumnStyle)),this.firstRowStyle&&(e.firstRowStyle=X(this.firstRowStyle)),this.secondRowStyle&&(e.secondRowStyle=X(this.secondRowStyle)),this.lastRowStyle&&(e.lastRowStyle=X(this.lastRowStyle)),this.firstColumnStyle&&(e.firstColumnStyle=X(this.firstColumnStyle)),this.secondColumnStyle&&(e.secondColumnStyle=X(this.secondColumnStyle)),this.lastColumnStyle&&(e.lastColumnStyle=X(this.lastColumnStyle)),e}fromJson(e){this._name=e.name,e.wholeStyle&&(this.wholeStyle=X(e.wholeStyle)),e.headerRowStyle&&(this.headerRowStyle=X(e.headerRowStyle)),e.headerColumnStyle&&(this.headerColumnStyle=X(e.headerColumnStyle)),e.firstRowStyle&&(this.firstRowStyle=X(e.firstRowStyle)),e.secondRowStyle&&(this.secondRowStyle=X(e.secondRowStyle)),e.lastRowStyle&&(this.lastRowStyle=X(e.lastRowStyle)),e.firstColumnStyle&&(this.firstColumnStyle=X(e.firstColumnStyle)),e.secondColumnStyle&&(this.secondColumnStyle=X(e.secondColumnStyle)),e.lastColumnStyle&&(this.lastColumnStyle=X(e.lastColumnStyle))}dispose(){this._mergeCacheMap.clear()}}const Vi=(s,e,t)=>new ke(`light-${s}`,{headerRowStyle:{bg:{rgb:e}},firstColumnStyle:{bg:{rgb:"rgb(255, 255, 255)"}},secondColumnStyle:{bg:{rgb:t}},lastRowStyle:{bg:{rgb:e}}}),Li=(s,e,t)=>new ke(`middle-${s}`,{headerRowStyle:{bg:{rgb:e}},headerColumnStyle:{bg:{rgb:t}},secondRowStyle:{bg:{rgb:t}},lastRowStyle:{bg:{rgb:e}},lastColumnStyle:{bg:{rgb:t}}}),$i=(s,e,t,n)=>new ke(`dark-${s}`,{headerRowStyle:{bg:{rgb:e},cl:{rgb:"rgb(255, 255, 255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:t}},secondRowStyle:{bg:{rgb:n}},lastRowStyle:{bg:{rgb:e}}}),Bi=[{baseName:"blue",header:"rgb(164, 202, 254)",color:"rgb(225, 239, 254)"},{baseName:"grey",header:"rgb(205, 208, 216)",color:"rgb(238, 239, 241)"},{baseName:"red",header:"rgb(248, 180, 180)",color:"rgb(253, 232, 232)"},{baseName:"orange",header:"rgb(253, 186, 140)",color:"rgb(254, 236, 220)"},{baseName:"yellow",header:"rgb(250, 200, 21)",color:"rgb(255, 244, 185)"},{baseName:"green",header:"rgb(132, 225, 188)",color:"rgb(222, 247, 236)"},{baseName:"azure",header:"rgb(126, 220, 226)",color:"rgb(213, 245, 246)"},{baseName:"indigo",header:"rgb(186, 198, 248)",color:"rgb(233, 237, 255)"},{baseName:"purple",header:"rgb(202, 191, 253)",color:"rgb(237, 235, 254)"},{baseName:"magenta",header:"rgb(248, 180, 217)",color:"rgb(252, 232, 243)"}],Hi=[{baseName:"blue",rowHeader:"rgb(63, 131, 248)",colHeader:"rgb(195, 221, 253)"},{baseName:"grey",rowHeader:"rgb(95, 101, 116)",colHeader:"rgb(227, 229, 234)"},{baseName:"red",rowHeader:"rgb(240, 82, 82)",colHeader:"rgb(251, 213, 213)"},{baseName:"orange",rowHeader:"rgb(255, 90, 31)",colHeader:"rgb(252, 217, 189)"},{baseName:"yellow",rowHeader:"rgb(212, 157, 15)",colHeader:"rgb(252, 220, 106)"},{baseName:"green",rowHeader:"rgb(13, 164, 113)",colHeader:"rgb(188, 240, 218)"},{baseName:"azure",rowHeader:"rgb(6, 148, 162)",colHeader:"rgb(175, 236, 239)"},{baseName:"indigo",rowHeader:"rgb(70, 106, 247)",colHeader:"rgb(210, 218, 250)"},{baseName:"purple",rowHeader:"rgb(144, 97, 249)",colHeader:"rgb(220, 215, 254)"},{baseName:"magenta",rowHeader:"rgb(231, 70, 148)",colHeader:"rgb(250, 209, 232)"}],ji=[{baseName:"blue",rowHeader:"rgb(30, 66, 159)",firstRow:"rgb(195, 221, 253)",secondRow:"rgb(118, 169, 250)"},{baseName:"grey",rowHeader:"rgb(44, 48, 64)",firstRow:"rgb(227, 229, 234)",secondRow:"rgb(151, 157, 172)"},{baseName:"red",rowHeader:"rgb(155, 28, 28)",firstRow:"rgb(251, 213, 213)",secondRow:"rgb(249, 128, 128)"},{baseName:"orange",rowHeader:"rgb(180, 52, 3)",firstRow:"rgb(252, 217, 189)",secondRow:"rgb(255, 138, 76)"},{baseName:"yellow",rowHeader:"rgb(154, 109, 21)",firstRow:"rgb(252, 220, 106)",secondRow:"rgb(212, 157, 15)"},{baseName:"green",rowHeader:"rgb(4, 108, 78)",firstRow:"rgb(188, 240, 218)",secondRow:"rgb(49, 196, 141)"},{baseName:"azure",rowHeader:"rgb(3, 102, 114)",firstRow:"rgb(175, 236, 239)",secondRow:"rgb(22, 189, 202)"},{baseName:"indigo",rowHeader:"rgb(16, 51, 191)",firstRow:"rgb(210, 218, 250)",secondRow:"rgb(98, 128, 249)"},{baseName:"purple",rowHeader:"rgb(74, 29, 150)",firstRow:"rgb(220, 215, 254)",secondRow:"rgb(172, 148, 250)"},{baseName:"magenta",rowHeader:"rgb(153, 21, 75)",firstRow:"rgb(250, 209, 232)",secondRow:"rgb(241, 126, 184)"}],Fi=Bi.map(({baseName:s,header:e,color:t})=>Vi(s,e,t)),Gi=Hi.map(({baseName:s,rowHeader:e,colHeader:t})=>Li(s,e,t)),zi=ji.map(({baseName:s,rowHeader:e,firstRow:t,secondRow:n})=>$i(s,e,t,n)),qi=[...Fi,...Gi,...zi],so={headerRowStyle:{bg:{rgb:"rgb(68,114,196)"},cl:{rgb:"rgb(255,255,255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:"rgb(217,225,242)"}}},Yi=new ke("default",so),Ki=new ke("default-last-row",{...so,lastRowStyle:{bd:{t:{s:i.BorderStyleTypes.THIN,cl:{rgb:"rgb(68,114,196)"}}},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE}});var Ji=Object.getOwnPropertyDescriptor,Xi=(s,e,t,n)=>{for(var o=n>1?void 0:n?Ji(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},oo=(s,e)=>(t,n)=>e(t,n,s);const Zi="SHEET_RANGE_THEME_MODEL_PLUGIN";g.SheetRangeThemeModel=class extends i.Disposable{constructor(t,n){super();f(this,"_rangeThemeStyleMap",new Map);f(this,"_rangeThemeStyleRuleMap",new Map);f(this,"_rTreeCollection",new Map);f(this,"_defaultRangeThemeMap",new Map);f(this,"_rangeThemeMapChanged$",new A.Subject);f(this,"rangeThemeMapChange$",this._rangeThemeMapChanged$.asObservable());this._sheetInterceptorService=t,this._resourceManagerService=n,this._registerIntercept(),this._initSnapshot(),this._initDefaultTheme()}_initDefaultTheme(){this.registerDefaultRangeTheme(Yi),this.registerDefaultRangeTheme(Ki);for(const t of qi)this.registerDefaultRangeTheme(t)}_ensureRangeThemeStyleMap(t){return this._rangeThemeStyleMap.has(t)||this._rangeThemeStyleMap.set(t,new Map),this._rangeThemeStyleMap.get(t)}_ensureRangeThemeStyleRuleMap(t){return this._rangeThemeStyleRuleMap.has(t)||this._rangeThemeStyleRuleMap.set(t,new Map),this._rangeThemeStyleRuleMap.get(t)}_ensureRTreeCollection(t){return this._rTreeCollection.has(t)||this._rTreeCollection.set(t,new i.RTree),this._rTreeCollection.get(t)}getDefaultRangeThemeStyle(t){return this._defaultRangeThemeMap.get(t)}getCustomRangeThemeStyle(t,n){return this._ensureRangeThemeStyleMap(t).get(n)}registerRangeThemeRule(t,n){const{unitId:o,subUnitId:r,range:a}=n,l=i.generateRandomId(),u=this._ensureRangeThemeStyleRuleMap(o),d=this._ensureRTreeCollection(o);u.set(l,{rangeInfo:n,themeName:t}),d.insert({unitId:o,sheetId:r,range:a,id:l})}getRegisteredRangeThemeStyle(t){const{unitId:n,subUnitId:o,range:r}=t,a=this._ensureRTreeCollection(n),l=Array.from(a.bulkSearch([{unitId:n,sheetId:o,range:r}]));if(l[0]){const d=this._ensureRangeThemeStyleRuleMap(n).get(l[0]);if(d)return d.themeName}}removeRangeThemeRule(t,n){const{unitId:o,subUnitId:r,range:a}=n,l=this._ensureRTreeCollection(o),u=Array.from(l.bulkSearch([{unitId:o,sheetId:r,range:a}])),d=this._ensureRangeThemeStyleRuleMap(o);for(let c=0;c<u.length;c++){const m=d.get(u[c]);if(m&&m.themeName===t){d.delete(u[c]),l.remove({unitId:o,sheetId:r,range:a,id:u[c]});break}}}registerDefaultRangeTheme(t){this._defaultRangeThemeMap.set(t.getName(),t),this._rangeThemeMapChanged$.next({type:"add",styleName:t.getName()})}unRegisterDefaultRangeTheme(t){this._defaultRangeThemeMap.delete(t),this._rangeThemeMapChanged$.next({type:"remove",styleName:t})}getRegisteredRangeThemes(){return Array.from(this._defaultRangeThemeMap.keys())}registerRangeThemeStyle(t,n){this._ensureRangeThemeStyleMap(t).set(n.getName(),n),this._rangeThemeMapChanged$.next({type:"add",styleName:n.getName()})}unregisterRangeThemeStyle(t,n){this._ensureRangeThemeStyleMap(t).delete(n),this._rangeThemeMapChanged$.next({type:"remove",styleName:n})}getALLRegisteredTheme(t){return Array.from(this._ensureRangeThemeStyleMap(t).keys())}getRangeThemeStyle(t,n){return this._defaultRangeThemeMap.has(n)?this._defaultRangeThemeMap.get(n):this._ensureRangeThemeStyleMap(t).get(n)}getCellStyle(t,n,o,r){const a={startRow:o,startColumn:r,endRow:o,endColumn:r},l=this._ensureRTreeCollection(t),u=Array.from(l.bulkSearch([{unitId:t,sheetId:n,range:a}]));if(u[0]){const c=this._ensureRangeThemeStyleRuleMap(t).get(u[0]);if(c){const{rangeInfo:m,themeName:h}=c,R=o-m.range.startRow,S=r-m.range.startColumn,C=this.getRangeThemeStyle(t,h);if(C)return C.getStyle(R,S,o===m.range.endRow,r===m.range.endColumn)}}}_registerIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Pe.CELL_CONTENT,{id:eo,effect:i.InterceptorEffectEnum.Style,handler:(t,n,o)=>{const{row:r,col:a,unitId:l,subUnitId:u}=n,d=this.getCellStyle(l,u,r,a);if(d){const c={...t};return c.themeStyle=d,o(c)}return o(t)}}))}toJson(t){const n=this._ensureRangeThemeStyleRuleMap(t),o=this._ensureRangeThemeStyleMap(t);if(o.size===0&&n.size===0)return"{}";const r={};n.forEach((l,u)=>{r[u]=l});const a={};return o.forEach((l,u)=>{a[u]=l.toJson()}),JSON.stringify({rangeThemeStyleRuleMap:r,rangeThemeStyleMapJson:a})}fromJSON(t,n){const{rangeThemeStyleRuleMap:o,rangeThemeStyleMapJson:r}=n;Object.keys(o).forEach(a=>{const l=o[a],{themeName:u,rangeInfo:d}=l;u.startsWith("table")||(this.registerRangeThemeRule(u,d),this._ensureRTreeCollection(d.unitId).insert({unitId:a,sheetId:d.subUnitId,range:d.range,id:a}))}),r&&Object.keys(r).forEach(a=>{const l=r[a],u=new ke(l.name);u.fromJson(l),this._ensureRangeThemeStyleMap(t).set(u.getName(),u)})}deleteUnitId(t){this._rangeThemeStyleMap.delete(t),this._rangeThemeStyleRuleMap.delete(t),this._rTreeCollection.delete(t)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t=>this.toJson(t),parseJson:t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}},businesses:[i.UniverInstanceType.UNIVER_SHEET],pluginName:Zi,onLoad:(t,n)=>{this.fromJSON(t,n)},onUnLoad:t=>{this.deleteUnitId(t)}}))}dispose(){super.dispose(),this._rangeThemeStyleMap.clear(),this._rangeThemeStyleRuleMap.clear(),this._defaultRangeThemeMap.clear(),this._rTreeCollection.clear()}},g.SheetRangeThemeModel=Xi([oo(0,i.Inject(g.SheetInterceptorService)),oo(1,i.Inject(i.IResourceManagerService))],g.SheetRangeThemeModel);function ro(s,e){const{unitId:t}=e,n=t?s.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);return n?{workbook:n,unitId:n.getUnitId()}:null}function T(s,e={}){const{unitId:t,subUnitId:n}=e,o=t?s.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);if(!o)return null;const r=n?o.getSheetBySheetId(n):o.getActiveSheet(!0);return r?{worksheet:r,workbook:o,unitId:o.getUnitId(),subUnitId:r.getSheetId()}:null}function Se(s,e){const{unitId:t,subUnitId:n}=e,o=s.getUnit(t,i.UniverInstanceType.UNIVER_SHEET);if(!o)return null;const r=o.getSheetBySheetId(n);return r?{worksheet:r,workbook:o}:null}const tt={id:"sheet.mutation.set-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,range:o,themeName:r}=e,a=s.get(i.IUniverInstanceService),l=T(a),u=s.get(g.SheetRangeThemeModel);return l?(u.registerRangeThemeRule(r,{range:o,unitId:t,subUnitId:n}),!0):!1}},io=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetRangeThemeStyleMutation]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),range:e.range,themeName:e.themeName}},nt={id:"sheet.mutation.remove-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,range:o,themeName:r}=e,a=s.get(i.IUniverInstanceService),l=T(a),u=s.get(g.SheetRangeThemeModel);return l?(u.removeRangeThemeRule(r,{range:o,unitId:t,subUnitId:n}),!0):!1}},ao=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[DeleteWorksheetRangeThemeStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),range:e.range,themeName:e.themeName}},lo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-range-theme-style",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=e,r=io(s,e);return t.syncExecuteCommand(tt.id,e)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:nt.id,params:r}],redoMutations:[{id:tt.id,params:e}]}),!0):!1}},Xt=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}},Ce={id:"sheet.mutation.insert-row",type:i.CommandType.MUTATION,handler:(s,e)=>{var S;const{unitId:t,subUnitId:n,range:o,rowInfo:r}=e,l=s.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(l==null)throw new Error("universheet is null error!");const u=l.getSheetBySheetId(n);if(u==null)throw new Error("worksheet is null error!");const d=u.getRowManager().getRowData(),c={h:u.getConfig().defaultRowHeight,hd:0},m=o.startRow,h=o.endRow-o.startRow+1;for(let C=m;C<m+h;C++)r?i.insertMatrixArray(C,(S=r[C-o.startRow])!=null?S:c,d):i.insertMatrixArray(C,c,d);return u.setRowCount(u.getRowCount()+o.endRow-o.startRow+1),u.getCellMatrix().insertRows(o.startRow,h),!0}},Et=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}},de={id:"sheet.mutation.insert-col",type:i.CommandType.MUTATION,handler:(s,e)=>{var S;const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const r=o.getColumnManager(),{range:a,colInfo:l}=e,d=r.getColumnData(),c=a.startColumn,m=a.endColumn-a.startColumn+1,h=o.getConfig().defaultColumnWidth;for(let C=c;C<c+m;C++){const I={w:h,hd:0};l?i.insertMatrixArray(C,(S=l[C-a.startColumn])!=null?S:I,d):i.insertMatrixArray(C,I,d)}return o.setColumnCount(o.getColumnCount()+a.endColumn-a.startColumn+1),o.getCellMatrix().insertColumns(a.startColumn,m),!0}},xi=(s,e)=>{const o=e.getRowManager().getRowData(),r={},a=s.range,l=i.sliceMatrixArray(a.startRow,a.endRow,o),u=i.concatMatrixArray(r,l);return{unitId:s.unitId,subUnitId:s.subUnitId,range:s.range,rowInfo:u}},fe={id:"sheet.mutation.remove-rows",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const r=e.range,l=o.getRowManager().getRowData();for(let c=r.startRow;c<=r.endRow;c++)o.getRowFiltered(c);const u=r.endRow-r.startRow+1;return i.spliceArray(r.startRow,u,l),o.getCellMatrix().removeRows(r.startRow,u),o.setRowCount(o.getRowCount()-u),!0}},Qi=(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(o==null)throw new Error("worksheet is null error!");const l=o.getColumnManager().getColumnData(),u={},d=e.range,c=i.sliceMatrixArray(d.startColumn,d.endColumn,l),m=i.concatMatrixArray(u,c);return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,colInfo:m}},re={id:"sheet.mutation.remove-col",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const r=e.range,l=o.getColumnManager().getColumnData(),u=r.endColumn-r.startColumn+1;return i.spliceArray(r.startColumn,u,l),o.setColumnCount(o.getColumnCount()-u),o.getCellMatrix().removeColumns(r.startColumn,u),!0}};function ea(s,e,t){var a;const n=s.getStyleByCell(e);n==null&&delete e.s,typeof t.s=="string"&&(t.s=s.get(t.s));const o=Zt(n,t.s?t.s:null);o&&(i.Tools.removeNull(o),Object.entries(o).forEach(([l,u])=>{typeof u=="object"&&u!==null&&Object.keys(u).length===0&&delete o[l]})),i.Tools.isEmptyObject(o)?delete e.s:e.s=s.setValue(o);const r=t.v?`${t.v}\r
`:"";!t.p&&e.p&&(r&&r!==((a=e.p.body)==null?void 0:a.dataStream)?delete e.p:sa(e.p,t.s?t.s:null))}function ta(s,e){if(!e||!Object.keys(e).length)return s;const t=i.Tools.deepClone(s!=null?s:{});for(const n in e)n==="bd"?t[n]=na(t[n]||{},e[n]):n in t||(t[n]=null);return t}function na(s,e){if(!e||!Object.keys(e).length)return s;for(const t in e)t in s||(s[t]=null);return s}function Zt(s,e,t=!1){if(e===null)return e;if(e===void 0)return s;const n=i.Tools.deepClone(s)||{};for(const o in e)t&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(o)||(o in n&&o==="bd"?n[o]=Object.assign(n[o],e[o]):n[o]=e[o]);return"cl"in n&&("ul"in n&&n.ul&&(n.ul.cl=n.cl),"ol"in n&&n.ol&&(n.ol.cl=n.cl),"st"in n&&n.st&&(n.st.cl=n.cl)),n}function uo(s,e){return s.some(t=>t.startIndex===e)?uo(s,e+1):e}function sa(s,e){var a;if(s.body==null)return;Array.isArray(s.body.textRuns)||(s.body.textRuns=[]);let t=0;const n=[],o=((a=s.body)==null?void 0:a.paragraphs)||[];for(const l of s.body.textRuns){const{st:u,ed:d,ts:c={}}=l;if(t<u){const h={st:t,ed:u},R=Zt({},e,!0);R&&i.Tools.removeNull(R),i.Tools.isEmptyObject(R)||(h.ts=R),n.push(h)}const m=Zt(c,e,!0);m&&i.Tools.removeNull(m),i.Tools.isEmptyObject(m)?delete l.ts:l.ts=m,n.push(l),t=uo(o,d)}const r=s.body.dataStream.endsWith(`\r
`)?s.body.dataStream.length-2:s.body.dataStream.length;if(t<r){const l={st:t,ed:r},u=Zt({},e,!0);u&&i.Tools.removeNull(u),i.Tools.isEmptyObject(u)||(l.ts=u),n.push(l)}s.body.textRuns=i.normalizeTextRuns(n)}function oa(s,e,t){var r,a,l;if(e.t)return e.t;if(e.v===null)return null;const n=s.getStyleByCell(e),o=s.getStyleByCell(t);if(t.t===i.CellValueType.FORCE_STRING){if(!On.isTextFormat((r=o==null?void 0:o.n)==null?void 0:r.pattern)&&e.v!==void 0){if(i.isRealNum(e.v))return i.CellValueType.NUMBER;if(i.isBooleanString(`${e.v}`))return i.CellValueType.BOOLEAN}return i.CellValueType.FORCE_STRING}return ra(n)?On.isTextFormat((a=n==null?void 0:n.n)==null?void 0:a.pattern)?i.CellValueType.STRING:co(e,t):On.isTextFormat((l=o==null?void 0:o.n)==null?void 0:l.pattern)?i.CellValueType.STRING:co(e,t)}function co(s,e){return s.v!==void 0?Dn(s.v,s.t):Dn(e.v,e.t)}function ra(s){var e;return!!((e=s==null?void 0:s.n)!=null&&e.pattern)}function Dn(s,e){return s===null?null:typeof s=="string"?i.isRealNum(s)?(+s==0||+s==1)&&e===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:i.CellValueType.NUMBER:i.isBooleanString(s)?i.CellValueType.BOOLEAN:i.CellValueType.STRING:typeof s=="number"?(s===0||s===1)&&e===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:i.CellValueType.NUMBER:typeof s=="boolean"?i.CellValueType.BOOLEAN:i.CellValueType.FORCE_STRING}function mo(s,e){return s===i.CellValueType.NUMBER?Number(e.v):s===i.CellValueType.BOOLEAN?ia(e.v)?1:0:s===i.CellValueType.STRING||s===i.CellValueType.FORCE_STRING?`${e.v}`:e.v}function ia(s){if(typeof s=="string"){if(s.toUpperCase()==="TRUE")return!0;if(s.toUpperCase()==="FALSE")return!1;if(i.isSafeNumeric(s)){if(Number(s)===0)return!1;if(Number(s)===1)return!0}}if(typeof s=="number"){if(s===0)return!1;if(s===1)return!0}return typeof s=="boolean"?s:null}function aa(s){return s==null?null:(s.f===void 0&&(s.f=null),s.si===void 0&&(s.si=null),s.p===void 0&&(s.p=null),s.v===void 0&&(s.v=null),s.t===void 0&&(s.t=null),s.s===void 0&&(s.s=null),s.custom===void 0&&(s.custom=null),s)}const ie=(s,e)=>{const{unitId:t,subUnitId:n,cellValue:o}=e,a=s.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(a==null)throw new Error("workbook is null error!");const l=a.getSheetBySheetId(n);if(l==null)throw new Error("worksheet is null error!");const u=l.getCellMatrix(),d=a.getStyles(),c=new i.ObjectMatrix;return new i.ObjectMatrix(o).forValue((h,R,S)=>{const C=i.Tools.deepClone(u==null?void 0:u.getValue(h,R))||{},I=d.getStyleByCell(C),v=d.getStyleByCell(S);C.s=ta(I,v),c.setValue(h,R,aa(C))}),{...e,options:{},cellValue:c.getMatrix()}},B={id:"sheet.mutation.set-range-values",type:i.CommandType.MUTATION,handler:(s,e)=>{const{cellValue:t,subUnitId:n,unitId:o}=e,a=s.get(i.IUniverInstanceService).getUnit(o);if(!a)return!1;const l=a.getSheetBySheetId(n);if(!l)return!1;const u=l.getCellMatrix(),d=a.getStyles();return new i.ObjectMatrix(t).forValue((m,h,R)=>{if(!R)u.realDeleteValue(m,h);else{let S=u.getValue(m,h)||{};S=la(R,S,d),i.Tools.isEmptyObject(S)?u.realDeleteValue(m,h):u.setValue(m,h,S)}}),!0}};function la(s,e,t){const n=new Set(["f","p","si","custom"]),o=oa(t,s,e);return Object.keys(s).forEach(r=>{const a=r;if(n.has(a)){const l=s[a];ua(e,a,l)}else a==="v"?s.v!==void 0&&(e.v=mo(o,s)):a==="s"&&ea(t,e,s)}),e.v!==void 0&&(e.t=o,e.v=mo(o,e)),e.v===null&&(delete e.t,delete e.v),e}function ua(s,e,t){t===void 0||(t===null?delete s[e]:s[e]=t)}const ho={type:i.CommandType.COMMAND,id:"sheet.command.append-row",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o,subUnitId:r,cellValue:a,insertRowNums:l,insertColumnNums:u,maxRows:d,maxColumns:c}=e,m={unitId:o,subUnitId:r,cellValue:a},h=ie(s,m),R=[{id:B.id,params:m}],S=[{id:B.id,params:h}];if(l){const I={unitId:o,subUnitId:r,range:{startRow:d,endRow:d,startColumn:0,endColumn:c-1}},v=Xt(s,I);R.unshift({id:Ce.id,params:I}),S.push({id:fe.id,params:v})}if(u){const I={unitId:o,subUnitId:r,range:{startRow:0,endRow:d-1,startColumn:c,endColumn:c-1+u}},v=Et(s,I);R.unshift({id:de.id,params:I}),S.push({id:re.id,params:v})}return i.sequenceExecute(R,t).result?(n.pushUndoRedo({unitID:o,undoMutations:S,redoMutations:R}),!0):!1}},da=(s,e,t="")=>s.reduce((n,o)=>{const r=o&&o[e];return typeof r!="string"?(console.warn(o,`${e} is not string`),n):(r?(n[r]||(n[r]=[]),n[r].push(o)):n[t].push(o),n)},{}),ca=(s=0)=>{let e=s;return function(){return e++}};function An(s){const e=new i.ObjectMatrix;return s.forEach(t=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=t;for(let l=n;l<=r;l++)for(let u=o;u<=a;u++)e.setValue(l,u,null)}),e.clone()}function go(s){const e=new i.ObjectMatrix;return s.forEach(t=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=t;for(let l=n;l<=r;l++)for(let u=o;u<=a;u++)e.setValue(l,u,{v:null,p:null,f:null,si:null,custom:null})}),e.clone()}function ma(s){const e=new i.ObjectMatrix;return s.forEach(t=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=t;for(let l=n;l<=r;l++)for(let u=o;u<=a;u++)e.setValue(l,u,{s:null})}),e.clone()}function Ro(s,e,t,n,o){const r=e.get(i.IUniverInstanceService),a=t?r.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):r.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),l=n?a==null?void 0:a.getSheetBySheetId(n):a==null?void 0:a.getActiveSheet();if(!l)return null;const{startRow:u,endRow:d,startColumn:c,endColumn:m}=s,h=[],R=[];for(let S=u;S<=d;S++)l.getRowFiltered(S)||(o?l.getRowRawVisible(S)&&h.push(S):h.push(S));for(let S=c;S<=m;S++)o?l.getColVisible(S)&&R.push(S):R.push(S);return{rows:h,cols:R}}function Tt(s,e,t,n){const o=[],r=[];for(const h of s){const R=Ro(h,e,t,n,!0);R&&(o.push(...R.rows),r.push(...R.cols))}const a=Array.from(new Set(o)).sort((h,R)=>h-R),l=Array.from(new Set(r)).sort((h,R)=>h-R),u=[];function d(h){const R=[];let S=h[0];for(let C=1;C<h.length;C++)h[C]!==h[C-1]+1&&(R.push([S,h[C-1]]),S=h[C]);return R.push([S,h[h.length-1]]),R}const c=d(a),m=d(l);for(const[h,R]of c)for(const[S,C]of m)u.push({startRow:h,endRow:R,startColumn:S,endColumn:C});return u}var ee=(s=>(s[s.MOVE_START=0]="MOVE_START",s[s.MOVING=1]="MOVING",s[s.MOVE_END=2]="MOVE_END",s[s.ONLY_SET=3]="ONLY_SET",s))(ee||{});class So extends i.Disposable{constructor(t){super();f(this,"_worksheetSelections",new Map);f(this,"_selectionMoveStart$",new A.Subject);f(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable());f(this,"_selectionMoving$",new A.Subject);f(this,"selectionMoving$",this._selectionMoving$.asObservable());f(this,"_selectionMoveEnd$",new A.BehaviorSubject([]));f(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable());f(this,"_selectionSet$",new A.BehaviorSubject([]));f(this,"selectionSet$",this._selectionSet$.asObservable());f(this,"selectionChanged$");f(this,"_beforeSelectionMoveEnd$",new A.BehaviorSubject([]));f(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable());this._workbook=t,this.selectionChanged$=A.merge(this._selectionMoveEnd$,this._selectionSet$)}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete(),this._selectionSet$.complete()}addSelections(t,n){const o=this.getSelectionsOfWorksheet(t);o.push(...n),this._selectionSet$.next(o)}setSelections(t,n=[],o){switch(this.setSelectionsOfWorksheet(t,n),o){case ee.MOVE_START:this._selectionMoveStart$.next(n);break;case ee.MOVING:this._selectionMoving$.next(n);break;case ee.MOVE_END:this._beforeSelectionMoveEnd$.next(n),this._selectionMoveEnd$.next(n);break;case ee.ONLY_SET:{this._selectionSet$.next(n);break}default:this._selectionSet$.next(n);break}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(t){return this.getSelectionsOfWorksheet(t)}getSelectionsOfWorksheet(t){return this._worksheetSelections.has(t)||this._worksheetSelections.set(t,[]),this._worksheetSelections.get(t)}setSelectionsOfWorksheet(t,n){this._worksheetSelections.set(t,[...n])}deleteSheetSelection(t){this._worksheetSelections.set(t,[])}clear(){this._worksheetSelections.clear(),this._selectionSet$.next([])}_getCurrentSelections(){return this.getSelectionsOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){const t=this._getCurrentSelections();return t[t.length-1]}}var ha=Object.getOwnPropertyDescriptor,ga=(s,e,t,n)=>{for(var o=n>1?void 0:n?ha(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ra=(s,e)=>(t,n)=>e(t,n,s);g.SheetsSelectionsService=class extends i.RxDisposable{constructor(t){super();f(this,"selectionMoveStart$");f(this,"selectionMoving$");f(this,"selectionMoveEnd$");f(this,"selectionSet$");f(this,"selectionChanged$");f(this,"_workbookSelections",new Map);this._instanceSrv=t,this._init()}get _currentSelectionPos(){const t=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!t)return null;const n=t.getActiveSheet();return{unitId:t.getUnitId(),sheetId:n.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){const t=this._instanceSrv.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(A.shareReplay(1),A.takeUntil(this.dispose$));this.selectionMoveStart$=t.pipe(A.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveStart$:A.of())),this.selectionMoving$=t.pipe(A.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoving$:A.of())),this.selectionMoveEnd$=t.pipe(A.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveEnd$:A.of([]))),this.selectionSet$=t.pipe(A.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionSet$:A.of([]))),this.selectionChanged$=t.pipe(A.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionChanged$:A.of([]))).pipe(A.distinctUntilChanged((n,o)=>n.length!==o.length?!1:n.length===0&&o.length===0?!0:n.every((r,a)=>JSON.stringify(r)===JSON.stringify(o[a]))),A.skip(1)),this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(A.takeUntil(this.dispose$)).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId())})}clear(){this._workbookSelections.forEach(t=>t.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){const t=this._getCurrentSelections();return t==null?void 0:t[t.length-1]}addSelections(t,n,o){if(typeof t=="string"){this._ensureWorkbookSelection(t).addSelections(n,o);return}const r=this._currentSelectionPos;if(!r)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:a,sheetId:l}=r;this._ensureWorkbookSelection(a).addSelections(l,t)}setSelections(t,n,o,r){if(typeof t=="string"&&typeof n=="string"){const d=t;this._ensureWorkbookSelection(d).setSelections(n,o||[],r!=null?r:ee.ONLY_SET);return}const a=this._currentSelectionPos;if(!a)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:l,sheetId:u}=a;if(typeof t=="object"){const d=t!=null?t:o,c=n!=null?n:ee.ONLY_SET;this._ensureWorkbookSelection(l).setSelections(u,d,c)}}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){const t=this.getCurrentSelections();return t==null?!1:t.some(({range:n},o)=>t.some(({range:r},a)=>o===a?!1:n.startRow<=r.endRow&&n.endRow>=r.startRow&&n.startColumn<=r.endColumn&&n.endColumn>=r.startColumn))}_getCurrentSelections(){const t=this._currentSelectionPos;if(!t)return[];const{unitId:n,sheetId:o}=t;return this._ensureWorkbookSelection(n).getSelectionsOfWorksheet(o)}getWorkbookSelections(t){return this._ensureWorkbookSelection(t)}_ensureWorkbookSelection(t){let n=this._workbookSelections.get(t);if(!n){const o=this._instanceSrv.getUnit(t);if(!o)throw new Error(`[SheetsSelectionsService]: cannot resolve unit with id "${t}"!`);n=new So(o),this._workbookSelections.set(t,n)}return n}_removeWorkbookSelection(t){this._workbookSelections.delete(t)}},g.SheetsSelectionsService=ga([Ra(0,i.IUniverInstanceService)],g.SheetsSelectionsService);const Sa="DISABLE_NORMAL_SELECTIONS",Ca="SELECTIONS_ENABLED",Co="REF_SELECTIONS_ENABLED",xt={id:"sheet.command.clear-selection-all",type:i.CommandType.COMMAND,handler:(s,e)=>{var p;const t=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),l=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const u=(e==null?void 0:e.unitId)||l.getUnitId(),d=l.getActiveSheet();if(!d)return!1;const c=(e==null?void 0:e.subUnitId)||d.getSheetId(),m=(e==null?void 0:e.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(M=>M.range));if(!(m!=null&&m.length))return!1;const h=Tt(m,s,u,c),R=[],S=[],C={subUnitId:c,unitId:u,cellValue:An(h)},I=ie(s,C);R.push({id:B.id,params:C}),S.push({id:B.id,params:I});const v=a.onCommandExecute({id:xt.id});return R.push(...v.redos),S.unshift(...v.undos),i.sequenceExecute(R,n)?(r.pushUndoRedo({unitID:u,undoMutations:S,redoMutations:R}),!0):!1}},Qt={id:"sheet.command.clear-selection-content",type:i.CommandType.COMMAND,handler:(s,e)=>{var p;const t=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),l=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const u=(e==null?void 0:e.unitId)||l.getUnitId(),d=l.getActiveSheet();if(!d)return!1;const c=(e==null?void 0:e.subUnitId)||d.getSheetId(),m=(e==null?void 0:e.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(M=>M.range));if(!(m!=null&&m.length))return!1;const h=Tt(m,s,u,c),R={subUnitId:c,unitId:u,cellValue:go(h)},S=ie(s,R),C=a.onCommandExecute({id:Qt.id}),I=[{id:B.id,params:R},...C.redos],v=[...C.undos,{id:B.id,params:S}];return i.sequenceExecute(I,n).result?(r.pushUndoRedo({unitID:u,undoMutations:v,redoMutations:I}),!0):!1}},en={id:"sheet.command.clear-selection-format",type:i.CommandType.COMMAND,handler:(s,e)=>{var p;const t=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),l=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const u=(e==null?void 0:e.unitId)||l.getUnitId(),d=l.getActiveSheet();if(!d)return!1;const c=(e==null?void 0:e.subUnitId)||d.getSheetId(),m=(e==null?void 0:e.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(M=>M.range));if(!(m!=null&&m.length))return!1;const h=Tt(m,s,u,c),R=[],S=[],C={subUnitId:c,unitId:u,cellValue:ma(h)},I=ie(s,C);R.push({id:B.id,params:C}),S.push({id:B.id,params:I});const v=a.onCommandExecute({id:en.id});return R.push(...v.redos),S.unshift(...v.undos),i.sequenceExecute(R,n)?(r.pushUndoRedo({unitID:u,undoMutations:S,redoMutations:R}),!0):!1}},Wn=(s,e)=>({subUnitId:e.sheet.id,unitId:e.unitId,subUnitName:e.sheet.name}),st={id:"sheet.mutation.insert-sheet",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService),{sheet:n,index:o,unitId:r}=e,a=t.getUniverSheetInstance(r);return a?a.addWorksheet(n.id,o,n):!1}},fo=(s,e)=>{const t=s.get(i.IUniverInstanceService),{subUnitId:n,unitId:o}=e,r=Se(t,e);if(!r)throw new Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");const{workbook:a,worksheet:l}=r,u=l.getConfig();return{index:a.getConfig().sheetOrder.findIndex(m=>m===n),sheet:u,unitId:o}},ze={id:"sheet.mutation.remove-sheet",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService),{subUnitId:n,unitId:o}=e,r=t.getUniverSheetInstance(o);return r?r.removeSheet(n):!1}},Vn={type:i.CommandType.COMMAND,id:"sheet.command.copy-sheet",handler:(s,e)=>{var M,y;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=s.get(i.LocaleService),l=T(o,e);if(!l)return!1;const{workbook:u,worksheet:d,unitId:c,subUnitId:m}=l,h=i.Tools.deepClone(d.getConfig());h.name=fa(u,a,h.name),h.id=i.Tools.generateRandomId();const S={index:u.getSheetIndex(d)+1,sheet:h,unitId:c},C=Wn(s,S),I=r.onCommandExecute({id:Vn.id,params:{unitId:c,subUnitId:m,targetSubUnitId:h.id}}),v=[...(M=I.preRedos)!=null?M:[],{id:st.id,params:S},...I.redos],w=[...(y=I.preUndos)!=null?y:[],{id:ze.id,params:C},...I.undos];return i.sequenceExecute(v,t).result?(n.pushUndoRedo({unitID:c,undoMutations:w,redoMutations:v}),!0):!1}};function fa(s,e,t){let n=t+e.t("sheets.tabs.sheetCopy",""),o=2;for(;s.checkSheetName(n);)n=t+e.t("sheets.tabs.sheetCopy",`${o}`),o++;return n}const Le={id:"sheet.mutation.move-range",type:i.CommandType.MUTATION,handler:(s,e)=>{const{from:t,to:n}=e;if(!t||!n)return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getSheetBySheetId(e.from.subUnitId),l=r.getSheetBySheetId(e.to.subUnitId);if(!a||!l)return!1;const u=a.getCellMatrix(),d=l.getCellMatrix();return new i.ObjectMatrix(t.value).forValue((c,m,h)=>{u.setValue(c,m,h)}),new i.ObjectMatrix(n.value).forValue((c,m,h)=>{d.setValue(c,m,h)}),!0}};function Ut(s,e,t=!0){const n=e.getMatrixWithMergedCells(...i.selectionToArray(s)),o=[];if(n.forValue((a,l,u)=>{if(u.colSpan!==void 0&&u.rowSpan!==void 0){const d={startRow:a,startColumn:l,endRow:a+u.rowSpan-1,endColumn:l+u.colSpan-1};i.Rectangle.contains(s,d)||o.push(d)}}),o.length===0)return s;const r=i.Rectangle.union(s,...o);return t?Ut(r,e,t):r}function Ia(s,e,t){let n=null;return t.getMatrixWithMergedCells(s,e,s,e).forValue((r,a,l)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:l.rowSpan!==void 0||l.colSpan!==void 0,isMergedMainCell:l.rowSpan!==void 0&&l.colSpan!==void 0,endRow:r+(l.rowSpan!==void 0?l.rowSpan-1:0),endColumn:a+(l.colSpan!==void 0?l.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:e,actualRow:s,startRow:s,startColumn:e,endRow:s,endColumn:e,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}function va(s,e,t){const{startRow:n,startColumn:o,endRow:r,endColumn:a}=s;return Number.isNaN(n)&&(s.startRow=0),Number.isNaN(r)&&(s.endRow=e-1),Number.isNaN(o)&&(s.startColumn=0),Number.isNaN(a)&&(s.endColumn=t-1),s}function te(s,e){const t=Number.isNaN(s.startRow)?0:s.startRow,n=Number.isNaN(s.startColumn)?0:s.startColumn,o=e.getMergedCell(t,n);return o?{...o,actualRow:t,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:t,startColumn:n,endRow:s.startRow,endColumn:s.startColumn,actualRow:t,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}const Me=(s,e,t)=>({id:q.id,params:{unitId:e.getUnitId(),subUnitId:t.getSheetId(),reveal:!0,selections:[{range:s,primary:te(s,t)}]}});function pa(s){if(!s)return!1;const{range:e,primary:t}=s;return i.Rectangle.equals(e,t)}function wa(s){function e(t,n){function o(r){for(let a=r.startRow;a<=r.endRow;a++)if(!s.getRowFiltered(a))for(let l=r.startColumn;l<=r.endColumn;l++)n(a,l,r)}o(t)}return{forOperableEach:e}}const Io=s=>s.id!==eo;function Oe(s,e,t,n,o,r,a){const l={};for(let u=e;u<=t;u++)for(let d=n;d<=o;d++){const c=r?s.getCellWithFilteredInterceptors(a,d,to,Io):s.getCellWithFilteredInterceptors(u,a,to,Io);!c||!c.s||(l[u]||(l[u]={}),l[u][d]={s:c.s})}return l}var Ma=Object.getOwnPropertyDescriptor,ya=(s,e,t,n)=>{for(var o=n>1?void 0:n?Ma(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},_a=(s,e)=>(t,n)=>e(t,n,s);const vo=i.createIdentifier("sheets-formula.ref-selections.service");g.RefSelectionsService=class extends g.SheetsSelectionsService{constructor(e){super(e)}_init(){const e=this._getAliveWorkbooks$().pipe(A.takeUntil(this.dispose$));this.selectionMoveStart$=e.pipe(A.switchMap(t=>A.merge(...t.map(n=>n.selectionMoveStart$)))),this.selectionMoving$=e.pipe(A.switchMap(t=>A.merge(...t.map(n=>n.selectionMoving$)))),this.selectionMoveEnd$=e.pipe(A.switchMap(t=>A.merge(...t.map(n=>n.selectionMoveEnd$)))),this.selectionSet$=e.pipe(A.switchMap(t=>A.merge(...t.map(n=>n.selectionSet$))))}_getAliveWorkbooks$(){const e=this._instanceSrv.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET);e.forEach(n=>this._ensureWorkbookSelection(n.getUnitId()));const t=new A.BehaviorSubject(e);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._ensureWorkbookSelection(n.getUnitId()),t.next([...t.getValue(),n])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId()),t.next(t.getValue().filter(o=>o!==n))})),t.pipe(A.map(n=>n.map(o=>this._ensureWorkbookSelection(o.getUnitId()))))}},g.RefSelectionsService=ya([_a(0,i.IUniverInstanceService)],g.RefSelectionsService);function po(s,e){const n=s.get(i.IContextService).getContextValue(Co);return s.get(n&&!e?vo:g.SheetsSelectionsService)}const q={id:"sheet.operation.set-selections",type:i.CommandType.OPERATION,handler:(s,e)=>{if(!e)return!1;const{selections:t,type:n,unitId:o,subUnitId:r}=e;return po(s).setSelections(o,r,[...t],n),!0}},wo={id:"sheet.command.select-range",type:i.CommandType.COMMAND,handler:(s,e)=>{if(!e)return!1;const{unitId:t,subUnit:n,range:o}=e,r=s.get(i.ICommandService),a=T(s.get(i.IUniverInstanceService),e);if(!a)return!1;const l=[{range:o,primary:te(o,a.worksheet),style:null}];return r.syncExecuteCommand(q.id,{unitId:t,subUnitId:n,selections:l})}},Mo="sheet.command.move-range",qe={type:i.CommandType.COMMAND,id:Mo,handler:async(s,e)=>{var p,M;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(i.ErrorService),a=s.get(i.LocaleService),l=s.get(g.SheetInterceptorService),u=T(o);if(!u||!await l.beforeCommandExecute({id:qe.id,params:e}))return!1;const{worksheet:c,subUnitId:m,unitId:h}=u,R=tn(s,{unitId:h,subUnitId:m,range:e.fromRange},{subUnitId:m,range:e.toRange});if(R===null)return r.emit(a.t("sheets.info.acrossMergedCell")),!1;const S=l.onCommandExecute({id:qe.id,params:{...e}}),C=[...(p=S.preRedos)!=null?p:[],...R.redos,...S.redos,{id:q.id,params:{unitId:h,subUnitId:m,selections:[{range:e.toRange,primary:ba(e.fromRange,e.toRange,c)}],type:ee.MOVE_END}}],I=[...(M=S.preUndos)!=null?M:[],...R.undos,...S.undos,{id:q.id,params:{unitId:h,subUnitId:m,selections:[{range:e.fromRange,primary:te(e.fromRange,c)}],type:ee.MOVE_END}}],v=i.sequenceExecute(C,t).result,w=l.afterCommandExecute({id:qe.id,params:{...e}});return v?(i.sequenceExecute(w.redos,t),n.pushUndoRedo({unitID:h,undoMutations:[...I,...w.undos],redoMutations:[...C,...w.redos]}),!0):!1}};function tn(s,e,t,n=!1){const o=[],r=[],{range:a,subUnitId:l,unitId:u}=e,{range:d,subUnitId:c}=t,h=s.get(i.IUniverInstanceService).getUniverSheetInstance(u),R=h==null?void 0:h.getSheetBySheetId(c),S=h==null?void 0:h.getSheetBySheetId(l),C=R==null?void 0:R.getCellMatrix(),I=S==null?void 0:S.getCellMatrix();if(R&&S&&C&&I){const v=Ut(d,R,!1);if(!i.Rectangle.equals(d,v)&&!n)return null;const w=new i.ObjectMatrix,p=new i.ObjectMatrix,M=new i.ObjectMatrix;i.Range.foreach(a,(P,E)=>{const O=I.getValue(P,E);if(w.setValue(P,E,i.Tools.deepClone(O)),O){const W=h==null?void 0:h.getStyles().get(O.s);M.setValue(P,E,i.Tools.deepClone(W))}p.setValue(P,E,null)});const y=new i.ObjectMatrix,b=new i.ObjectMatrix;i.Range.foreach(d,(P,E)=>{y.setValue(P,E,i.Tools.deepClone(C.getValue(P,E)))}),i.Range.foreach(a,(P,E)=>{const O=i.cellToRange(P,E),W=i.Rectangle.getRelativeRange(O,a),L=i.Rectangle.getPositionRange(W,d),H=i.Tools.deepClone(M.getValue(P,E)),j=i.Tools.deepClone(w.getValue(P,E));j&&H&&(j.s=H),b.setValue(L.startRow,L.startColumn,j)});const k={fromRange:e.range,toRange:t.range,from:{value:p.getMatrix(),subUnitId:l},to:{value:b.getMatrix(),subUnitId:c},unitId:u},U={fromRange:t.range,toRange:e.range,from:{value:w.getMatrix(),subUnitId:l},to:{value:y.getMatrix(),subUnitId:c},unitId:u};o.push({id:Le.id,params:k}),r.push({id:Le.id,params:U})}return{redos:o,undos:r}}function ba(s,e,t){const n=s.startRow,o=s.startColumn,r=t.getMergedCell(n,o),a=te(e,t);if(r){const l=r.endRow-r.startRow+1,u=r.endColumn-r.startColumn+1;a.endRow=a.startRow+l-1,a.endColumn=a.startColumn+u-1,a.actualRow=a.startRow,a.actualColumn=a.startColumn,a.isMerged=!1,a.isMergedMainCell=!0}return a}var nn=(s=>(s[s.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",s[s.UNIVER_DOC=1]="UNIVER_DOC",s[s.UNIVER_SHEET=2]="UNIVER_SHEET",s[s.UNIVER_SLIDE=3]="UNIVER_SLIDE",s[s.UNIVER_PROJECT=4]="UNIVER_PROJECT",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(nn||{}),_=(s=>(s[s.View=0]="View",s[s.Edit=1]="Edit",s[s.ManageCollaborator=2]="ManageCollaborator",s[s.Print=3]="Print",s[s.Duplicate=4]="Duplicate",s[s.Comment=5]="Comment",s[s.Copy=6]="Copy",s[s.Share=7]="Share",s[s.Export=8]="Export",s[s.MoveWorksheet=9]="MoveWorksheet",s[s.DeleteWorksheet=10]="DeleteWorksheet",s[s.HideWorksheet=11]="HideWorksheet",s[s.RenameWorksheet=12]="RenameWorksheet",s[s.CreateWorksheet=13]="CreateWorksheet",s[s.SetWorksheetStyle=14]="SetWorksheetStyle",s[s.EditWorksheetCell=15]="EditWorksheetCell",s[s.InsertHyperlink=16]="InsertHyperlink",s[s.Sort=17]="Sort",s[s.Filter=18]="Filter",s[s.PivotTable=19]="PivotTable",s[s.FloatImg=20]="FloatImg",s[s.History=21]="History",s[s.RwHgtClWdt=22]="RwHgtClWdt",s[s.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",s[s.ViewFilter=24]="ViewFilter",s[s.MoveSheet=25]="MoveSheet",s[s.DeleteSheet=26]="DeleteSheet",s[s.HideSheet=27]="HideSheet",s[s.CopySheet=28]="CopySheet",s[s.RenameSheet=29]="RenameSheet",s[s.CreateSheet=30]="CreateSheet",s[s.SelectProtectedCells=31]="SelectProtectedCells",s[s.SelectUnProtectedCells=32]="SelectUnProtectedCells",s[s.SetCellStyle=33]="SetCellStyle",s[s.SetCellValue=34]="SetCellValue",s[s.SetRowStyle=35]="SetRowStyle",s[s.SetColumnStyle=36]="SetColumnStyle",s[s.InsertRow=37]="InsertRow",s[s.InsertColumn=38]="InsertColumn",s[s.DeleteRow=39]="DeleteRow",s[s.DeleteColumn=40]="DeleteColumn",s[s.EditExtraObject=41]="EditExtraObject",s[s.Delete=42]="Delete",s[s.RecoverHistory=43]="RecoverHistory",s[s.ViewHistory=44]="ViewHistory",s[s.CreatePermissionObject=45]="CreatePermissionObject",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(_||{}),N=(s=>(s[s.Unkonwn=0]="Unkonwn",s[s.Workbook=1]="Workbook",s[s.Worksheet=2]="Worksheet",s[s.SelectRange=3]="SelectRange",s[s.Document=4]="Document",s[s.Slide=5]="Slide",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(N||{});class ce{constructor(e,t,n){f(this,"type",N.SelectRange);f(this,"subType",_.Edit);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${_.Edit}.${n}`}}class sn{constructor(e,t,n){f(this,"type",N.SelectRange);f(this,"subType",_.View);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${_.View}.${n}`}}class Ln{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Comment);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Comment}_${e}`}}class $n{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Copy);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Copy}_${e}`}}class yo{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"subType",_.CopySheet);f(this,"status",i.PermissionStatus.INIT);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.CopySheet}_${e}`}}class Bn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.CreatePermissionObject);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.CreatePermissionObject}_${e}`}}class Hn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.CreateSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.CreateSheet}_${e}`}}class jn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.DeleteSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.DeleteSheet}_${e}`}}class Fn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Duplicate);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Duplicate}_${e}`}}class ae{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Edit);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Edit}_${e}`}}class Gn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Export);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Export}_${e}`}}class on{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.HideSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.HideSheet}_${e}`}}class _o{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.History);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.History}_${e}`}}class rn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.ManageCollaborator);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.ManageCollaborator}_${e}`}}class an{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.MoveSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.MoveSheet}_${e}`}}class zn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Print);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Print}_${e}`}}class qn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.RecoverHistory);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.RecoverHistory}_${e}`}}class ln{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.RenameSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.RenameSheet}_${e}`}}class Yn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Share);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.Share}_${e}`}}class Kn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.View);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.View}_${e}`}}class Jn{constructor(e){f(this,"id");f(this,"value",!0);f(this,"type",N.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.ViewHistory);this.unitId=e,this.unitId=e,this.id=`${this.type}.${_.ViewHistory}_${e}`}}class Xn{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Copy);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.Copy}_${e}_${t}`}}class Zn{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteColumn);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.DeleteColumn}_${e}_${t}`}}class xn{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Delete);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.Delete}_${e}_${t}`}}class Qn{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteRow);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.DeleteRow}_${e}_${t}`}}class me{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Edit);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.Edit}_${e}_${t}`}}class es{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.EditExtraObject);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.EditExtraObject}_${e}_${t}`}}class ts{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Filter);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.Filter}_${e}_${t}`}}class ns{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertColumn);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.InsertColumn}_${e}_${t}`}}class ss{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertHyperlink);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.InsertHyperlink}_${e}_${t}`}}class os{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertRow);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.InsertRow}_${e}_${t}`}}class rs{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.ManageCollaborator);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.ManageCollaborator}_${e}_${t}`}}class is{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.PivotTable);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.PivotTable}_${e}_${t}`}}class Ea{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SelectProtectedCells);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SelectProtectedCells}_${e}_${t}`}}class Ta{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SelectUnProtectedCells);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SelectUnProtectedCells}_${e}_${t}`}}class as{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetCellStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SetCellStyle}_${e}_${t}`}}class Pt{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetCellValue);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SetCellValue}_${e}_${t}`}}class ot{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetColumnStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SetColumnStyle}_${e}_${t}`}}class rt{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetRowStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.SetRowStyle}_${e}_${t}`}}class ls{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Sort);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.Sort}_${e}_${t}`}}class kt{constructor(e,t){f(this,"value",!0);f(this,"type",N.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.View);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${_.View}_${e}_${t}`}}const it={id:"sheet.command.set-range-values",type:i.CommandType.COMMAND,handler:(s,e)=>{var P;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),l=s.get(i.IPermissionService),u=T(o,e);if(!u)return!1;const{subUnitId:d,unitId:c,workbook:m,worksheet:h}=u,{value:R,range:S,redoUndoId:C}=e,I=S?[S]:(P=r.getCurrentSelections())==null?void 0:P.map(E=>E.range);if(!I||!I.length||!l.getPermissionPoint(new me(c,d).id))return!1;const v=new i.ObjectMatrix;let w;if(i.Tools.isArray(R))for(let E=0;E<I.length;E++){const{startRow:O,startColumn:W,endRow:L,endColumn:H}=I[E];for(let j=0;j<=L-O;j++)for(let Y=0;Y<=H-W;Y++)v.setValue(j+O,Y+W,R[j][Y])}else if(i.isICellData(R))for(let E=0;E<I.length;E++){const{startRow:O,startColumn:W,endRow:L,endColumn:H}=I[E];for(let j=O;j<=L;j++)for(let Y=W;Y<=H;Y++)v.setValue(j,Y,R)}else w=R;const p={subUnitId:d,unitId:c,cellValue:w!=null?w:v.getMatrix()},M=ie(s,p);if(!t.syncExecuteCommand(B.id,p))return!1;const{undos:b,redos:k}=a.onCommandExecute({id:it.id,params:{...p,range:I}});if(i.sequenceExecute([...k],t).result){const E=Me(S!=null?S:v.getRange(),m,h);return n.pushUndoRedo({unitID:c,undoMutations:[{id:B.id,params:M},...b,E],redoMutations:[{id:B.id,params:p},...k,i.Tools.deepClone(E)],id:C}),!0}return!1}};function us(s,e){const t=[],n=[],{unitId:o,subUnitId:r,range:a,shiftDimension:l,cellValue:u={}}=e,d=s.get(i.IUniverInstanceService),c=s.get(g.SheetInterceptorService),m=d.getUniverSheetInstance(o),h=m==null?void 0:m.getSheetBySheetId(r);if(h){const R=h.getCellMatrix(),S=R.getDataRange();if(a.startColumn<=S.endColumn||a.startRow<=S.endRow){let p,M;if(l===i.Dimension.COLUMNS){const b=Math.min(a.endRow,S.endRow);let k=0;for(let P=a.startRow;P<=b;P++){const E=R.getRow(P),O=E?i.getArrayLength(E)-1:0;k=Math.max(k,O)}p={startRow:a.startRow,startColumn:a.startColumn,endRow:b,endColumn:k};const U=a.endColumn-a.startColumn+1;M={startRow:a.startRow,startColumn:p.startColumn+U,endRow:b,endColumn:p.endColumn+U}}else{const b=Math.min(a.endColumn,S.endColumn),k=S.endRow;p={startRow:a.startRow,startColumn:a.startColumn,endRow:k,endColumn:b};const U=a.endRow-a.startRow+1;M={startRow:p.startRow+U,startColumn:a.startColumn,endRow:p.endRow+U,endColumn:b}}const y=tn(s,{unitId:o,subUnitId:r,range:p},{subUnitId:r,range:M},!0);y&&(t.push(...y.redos),n.push(...y.undos))}if(Object.entries(u).length===0)for(let p=a.startRow;p<=a.endRow;p++){u[p]||(u[p]={});for(let M=a.startColumn;M<=a.endColumn;M++)u[p][M]=null}const C={subUnitId:r,unitId:o,cellValue:u},I=ie(s,C),{undos:v,redos:w}=c.onCommandExecute({id:it.id,params:{...C,range:a}});t.push({id:B.id,params:C},...w),n.push({id:B.id,params:I},...v)}return{redo:t,undo:n}}function ds(s,e){const t=[],n=[],{unitId:o,subUnitId:r,range:a,shiftDimension:l}=e,u=s.get(i.IUniverInstanceService),d=s.get(g.SheetInterceptorService),c=u.getUniverSheetInstance(o),m=c==null?void 0:c.getSheetBySheetId(r);if(m){const h=m.getCellMatrix(),R=h.getDataRange(),S={subUnitId:r,unitId:o,cellValue:An([a])},C=ie(s,S),I=d.onCommandExecute({id:it.id,params:S});if(t.push({id:B.id,params:S},...I.redos),n.push(...I.undos,{id:B.id,params:C}),a.startColumn<=R.endColumn||a.startRow<=R.endRow){let v=null,w=null;if(l===i.Dimension.COLUMNS&&a.endColumn<R.endColumn){const p=Math.min(a.endRow,R.endRow);let M=0;for(let b=a.startRow;b<=p;b++){const k=h.getRow(b),U=k?i.getArrayLength(k)-1:0;M=Math.max(M,U)}v={startRow:a.startRow,startColumn:a.endColumn+1,endRow:p,endColumn:M};const y=a.endColumn-a.startColumn+1;w={startRow:a.startRow,startColumn:v.startColumn-y,endRow:p,endColumn:v.endColumn-y}}if(l===i.Dimension.ROWS&&a.endRow<R.endRow){const p=Math.min(a.endColumn,R.endColumn),M=R.endRow;v={startRow:a.endRow+1,startColumn:a.startColumn,endRow:M,endColumn:p};const y=a.endRow-a.startRow+1;w={startRow:v.startRow-y,startColumn:a.startColumn,endRow:v.endRow-y,endColumn:p}}if(v&&w){const p=tn(s,{unitId:o,subUnitId:r,range:v},{subUnitId:r,range:w},!0);p&&(t.push(...p.redos),n.push(...p.undos))}}}return{redo:t,undo:n}}function Ua(s,e,t,n,o,r){const{startRow:a,endRow:l,startColumn:u,endColumn:d}=e;if(o===i.Dimension.ROWS){const c=l-a+1;for(let m=t;m>=a;m--)for(let h=u;h<=d;h++){const R=s.getValue(m,h);R==null?s.realDeleteValue(m+c,h):s.setValue(m+c,h,R)}for(let m=l;m>=a;m--)for(let h=u;h<=d;h++)r&&r[m]&&r[m][h]?s.setValue(m,h,r[m][h]):s.realDeleteValue(m,h)}else if(o===i.Dimension.COLUMNS){const c=d-u+1;for(let m=a;m<=l;m++)for(let h=n;h>=u;h--){const R=s.getValue(m,h);R==null?s.realDeleteValue(m,h+c):s.setValue(m,h+c,R)}for(let m=a;m<=l;m++)for(let h=d;h>=u;h--)r&&r[m]&&r[m][h]?s.setValue(m,h,r[m][h]):s.realDeleteValue(m,h)}}function Pa(s,e,t,n,o){const{startRow:r,endRow:a,startColumn:l,endColumn:u}=e,d=a-r+1,c=u-l+1;if(o===i.Dimension.ROWS)for(let m=r;m<=t;m++)for(let h=l;h<=u;h++){const R=s.getValue(m+d,h);R==null?s.realDeleteValue(m,h):s.setValue(m,h,R)}else if(o===i.Dimension.COLUMNS)for(let m=r;m<=a;m++)for(let h=l;h<=n;h++){const R=s.getValue(m,h+c);R==null?s.realDeleteValue(m,h):s.setValue(m,h,R)}}const bo="sheet.command.delete-range-move-left",Ye={type:i.CommandType.COMMAND,id:bo,handler:async(s,e)=>{var M,y,b;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),l=T(o);if(!l)return!1;const{worksheet:u,workbook:d,subUnitId:c,unitId:m}=l;let h=e==null?void 0:e.range;if(h||(h=(M=r.getCurrentLastSelection())==null?void 0:M.range),!h)return!1;const R={range:h,subUnitId:c,unitId:m,shiftDimension:i.Dimension.COLUMNS},S=a.onCommandExecute({id:Ye.id,params:{range:h}}),{redo:C,undo:I}=ds(s,R),v=[...(y=S.preRedos)!=null?y:[],...C],w=[...S.undos,...I];return v.push(...S.redos),v.push(Me(h,d,u)),w.push(...(b=S.preUndos)!=null?b:[]),i.sequenceExecute(v,t).result?(n.pushUndoRedo({unitID:m,undoMutations:w.reverse(),redoMutations:v}),!0):!1}},Eo="sheet.command.delete-range-move-up",Ke={type:i.CommandType.COMMAND,id:Eo,handler:async(s,e)=>{var M,y,b;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),l=T(o);if(!l)return!1;const{unitId:u,subUnitId:d,workbook:c,worksheet:m}=l;let h=e==null?void 0:e.range;if(h||(h=(M=r.getCurrentLastSelection())==null?void 0:M.range),!h)return!1;const R={range:h,subUnitId:d,unitId:u,shiftDimension:i.Dimension.ROWS},S=a.onCommandExecute({id:Ke.id,params:{range:h}}),{redo:C,undo:I}=ds(s,R),v=[...(y=S.preRedos)!=null?y:[],...C],w=[...S.undos,...I];return v.push(...S.redos),v.push(Me(h,c,m)),w.push(...(b=S.preUndos)!=null?b:[]),i.sequenceExecute(v,t).result?(n.pushUndoRedo({unitID:u,undoMutations:w.reverse(),redoMutations:v}),!0):!1}},To={type:i.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o,subUnitId:r,rule:a}=e,l={unitId:o,subUnitId:r,ruleIds:[a.id]};return await t.executeCommand(pe.id,l)&&n.pushUndoRedo({unitID:o,redoMutations:[{id:pe.id,params:l}],undoMutations:[{id:ue.id,params:{unitId:o,subUnitId:r,rules:[a]}}]}),!0}},Uo={type:i.CommandType.COMMAND,id:"sheet.command.delete-worksheet-protection",handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,unitId:r,subUnitId:a}=e;t.executeCommand(Ge.id,{unitId:r,subUnitId:a});const l=[{id:Ge.id,params:{unitId:r,subUnitId:a}}],u=[{id:Ve.id,params:{unitId:r,rule:o,subUnitId:a}}];return n.pushUndoRedo({unitID:r,redoMutations:l,undoMutations:u}),!0}},Po={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-range-theme-style",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=e,r=ao(s,e);return t.syncExecuteCommand(nt.id,e)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:tt.id,params:r}],redoMutations:[{id:nt.id,params:e}]}),!0):!1}},ko={id:"sheet.command.insert-defined-name",type:i.CommandType.COMMAND,handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService);if(!e)return!1;const o={...e};return t.syncExecuteCommand(z.SetDefinedNameMutation.id,o)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:[{id:z.RemoveDefinedNameMutation.id,params:o}],redoMutations:[{id:z.SetDefinedNameMutation.id,params:o}]}),!0):!1}},ka="sheet.command.insert-range-move-down",at={type:i.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:async(s,e)=>{var W,L,H;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),l=s.get(i.ErrorService),u=s.get(i.LocaleService);if(r.isOverlapping())return l.emit(u.t("sheets.info.overlappingSelections")),!1;const d=T(o);if(!d)return!1;const{unitId:c,subUnitId:m,worksheet:h,workbook:R}=d;let S=e==null?void 0:e.range;if(S||(S=(W=r.getCurrentLastSelection())==null?void 0:W.range),!S)return!1;const C=[],I=[],v=h.getCellMatrix(),w=v.getDataRange(),M=v.getSlice(w.startRow,w.endRow,S.startColumn,S.endColumn).getDataRange().endRow,y=Math.max(M+(S.endRow-S.startRow+1)-w.endRow,0);if(y>0){const j=S.startRow-1,Y=h.getRowHeight(j),K={unitId:c,subUnitId:m,range:{startRow:w.endRow+1,endRow:w.endRow+y,startColumn:w.startColumn,endColumn:w.endColumn},rowInfo:new Array(y).fill(void 0).map(()=>({h:Y,hd:i.BooleanNumber.FALSE}))};C.push({id:Ce.id,params:K});const Ue=Xt(s,K);I.push({id:fe.id,params:Ue})}const b={};i.Range.foreach(S,(j,Y)=>{const K=h.getCell(j,Y);K&&(b[j]||(b[j]={}),b[j][Y]={s:K.s})});const k={range:S,subUnitId:m,unitId:c,shiftDimension:i.Dimension.ROWS,cellValue:b},{redo:U,undo:P}=us(s,k);C.push(...U),I.push(...P);const E=a.onCommandExecute({id:at.id,params:{range:S}});return C.push(...E.redos),C.push(Me(S,R,h)),I.push(...(L=E.preUndos)!=null?L:[]),C.unshift(...(H=E.preRedos)!=null?H:[]),I.unshift(...E.undos),i.sequenceExecute(C,t)?(n.pushUndoRedo({unitID:c,undoMutations:I.reverse(),redoMutations:C}),!0):!1}},cs="sheet.command.insert-range-move-right",Ot={type:i.CommandType.COMMAND,id:cs,handler:async(s,e)=>{var W,L,H;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),l=s.get(i.ErrorService),u=s.get(i.LocaleService);if(r.isOverlapping())return l.emit(u.t("sheets.info.overlappingSelections")),!1;const d=T(o);if(!d)return!1;const{workbook:c,worksheet:m,unitId:h,subUnitId:R}=d;let S=e==null?void 0:e.range;if(S||(S=(W=r.getCurrentLastSelection())==null?void 0:W.range),!S)return!1;const C=[],I=[],v=m.getCellMatrix(),w=v.getDataRange(),M=v.getSlice(S.startRow,S.endRow,w.startColumn,w.endColumn).getDataRange().endColumn,y=Math.max(M+(S.endColumn-S.startColumn+1)-w.endColumn,0);if(y>0){const j=S.startColumn-1,Y=m.getColumnWidth(j),K={unitId:h,subUnitId:R,range:{startRow:w.startRow+1,endRow:w.endRow,startColumn:w.endColumn+1,endColumn:w.endColumn+y},colInfo:new Array(y).fill(void 0).map(()=>({w:Y,hd:i.BooleanNumber.FALSE}))};C.push({id:de.id,params:K});const Ue=Et(s,K);I.push({id:re.id,params:Ue})}const b={};i.Range.foreach(S,(j,Y)=>{const K=m.getCell(j,Y);!K||!K.s||(b[j]||(b[j]={}),b[j][Y]={s:K.s})});const k={range:S,subUnitId:R,unitId:h,shiftDimension:i.Dimension.COLUMNS,cellValue:b},{redo:U,undo:P}=us(s,k);C.push(...U),I.push(...P);const E=a.onCommandExecute({id:Ot.id,params:{range:S}});return C.push(...E.redos),C.push(Me(S,c,m)),I.push(...(L=E.preUndos)!=null?L:[]),C.unshift(...(H=E.preRedos)!=null?H:[]),I.unshift(...E.undos),i.sequenceExecute(C,t).result?(n.pushUndoRedo({unitID:h,undoMutations:I.reverse(),redoMutations:C}),!0):!1}},Oo="sheet.command.insert-row",ye={type:i.CommandType.COMMAND,id:Oo,handler:async(s,e)=>{const t=s.get(i.ICommandService),n=s.get(g.SheetInterceptorService),{range:o,direction:r,unitId:a,subUnitId:l,cellValue:u}=e;return await n.beforeCommandExecute({id:ye.id,params:e})?t.syncExecuteCommand(ms.id,{range:o,direction:r,unitId:a,subUnitId:l,cellValue:u}):!1}},ms={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-by-range",handler:(s,e)=>{var U,P,E,O;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=T(o,e);if(!a)return!1;const{workbook:l,worksheet:u}=a,{range:d,direction:c,unitId:m,subUnitId:h,cellValue:R}=e,{startRow:S,endRow:C}=d;d.rangeType=i.RANGE_TYPE.ROW;const I=c===i.Direction.UP?S:S-1,v=u.getRowHeight(I),w={unitId:m,subUnitId:h,range:d,rowInfo:new Array(C-S+1).fill(void 0).map(()=>({h:v,hd:i.BooleanNumber.FALSE}))},p=Xt(s,w),M=[{id:Ce.id,params:w}],y=[{id:fe.id,params:p}];R&&M.push({id:B.id,params:{unitId:m,subUnitId:h,cellValue:R}});const b=r.onCommandExecute({id:ye.id,params:e});return M.unshift(...(U=b.preRedos)!=null?U:[]),M.push(...(P=b.redos)!=null?P:[]),M.push(Me(d,l,u)),y.unshift(...(E=b.preUndos)!=null?E:[]),y.push(...(O=b.undos)!=null?O:[]),i.sequenceExecute(M,t).result?(n.pushUndoRedo({unitID:e.unitId,undoMutations:y,redoMutations:M}),!0):!1}},No={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:async s=>{var S;const t=(S=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:S.map(C=>C.range);let n;if((t==null?void 0:t.length)===1)n=t[0];else return!1;const o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a,subUnitId:l,unitId:u}=r,{startRow:d,endRow:c}=n,m=0,h=a.getColumnCount()-1,R={unitId:u,subUnitId:l,direction:i.Direction.UP,range:{startRow:d,endRow:c,startColumn:m,endColumn:h},cellValue:Oe(a,d,c,m,h,!0,d-1)};return s.get(i.ICommandService).executeCommand(ye.id,R)}},Do={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:async s=>{var C;const t=(C=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:C.map(I=>I.range);let n;if((t==null?void 0:t.length)===1)n=t[0];else return!1;const o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a,unitId:l,subUnitId:u}=r,d=n.endRow-n.startRow+1,c=n.endRow+1,m=n.endRow+d,h=0,R=a.getColumnCount()-1,S={unitId:l,subUnitId:u,direction:i.Direction.DOWN,range:{startRow:c,endRow:m,startColumn:h,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:Oe(a,c,m,h,R,!0,n.endRow)};return s.get(i.ICommandService).executeCommand(ye.id,S)}},Ao={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-above",handler:async(s,e)=>{var v;const n=(v=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:v.map(w=>w.range);let o;if((n==null?void 0:n.length)===1)o=n[0];else return!1;const r=s.get(i.IUniverInstanceService),a=T(r);if(!a)return!1;const{worksheet:l,unitId:u,subUnitId:d}=a,c=e.value||0,m=o.startRow,h=o.startRow+c-1,R=0,S=l.getColumnCount()-1,C=Oe(l,m,h,R,S,!0,m-1),I={unitId:u,subUnitId:d,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:R,endColumn:S,rangeType:i.RANGE_TYPE.ROW},cellValue:C};return s.get(i.ICommandService).executeCommand(ye.id,I)}},Wo={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-after",handler:async(s,e)=>{var I;const n=(I=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:I.map(v=>v.range);let o;if((n==null?void 0:n.length)===1)o=n[0];else return!1;const r=s.get(i.IUniverInstanceService),a=T(r);if(!a)return!1;const{worksheet:l,unitId:u,subUnitId:d}=a,c=e.value||0,m=o.endRow+1,h=o.endRow+c,R=0,S=l.getColumnCount()-1,C={unitId:u,subUnitId:d,direction:i.Direction.DOWN,range:{startRow:m,endRow:h,startColumn:R,endColumn:S,rangeType:i.RANGE_TYPE.ROW},cellValue:Oe(l,m,h,R,S,!0,o.endRow)};return s.get(i.ICommandService).executeCommand(ye.id,C)}},Vo="sheet.command.insert-col",_e={type:i.CommandType.COMMAND,id:Vo,handler:async(s,e)=>{const t=s.get(i.ICommandService),n=s.get(g.SheetInterceptorService),{range:o,direction:r,subUnitId:a,unitId:l,cellValue:u}=e;return await n.beforeCommandExecute({id:_e.id,params:e})?t.syncExecuteCommand(hs.id,{range:o,direction:r,unitId:l,subUnitId:a,cellValue:u}):!1}},hs={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-by-range",handler:(s,e)=>{var k,U,P,E;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),{range:a,direction:l,subUnitId:u,unitId:d,cellValue:c}=e,{startColumn:m,endColumn:h}=e.range;a.rangeType=i.RANGE_TYPE.COLUMN;const R=o.getUniverSheetInstance(e.unitId),S=R.getSheetBySheetId(e.subUnitId),C=l===i.Direction.LEFT?m:m-1,I=S.getColumnWidth(C),v={unitId:d,subUnitId:u,range:a,colInfo:new Array(h-m+1).fill(void 0).map(()=>({w:I,hd:i.BooleanNumber.FALSE}))},w=Et(s,v),p=[{id:de.id,params:v}],M=[{id:re.id,params:w}];c&&p.push({id:B.id,params:{unitId:d,subUnitId:u,cellValue:c}});const y=r.onCommandExecute({id:_e.id,params:e});return p.unshift(...(k=y.preRedos)!=null?k:[]),p.push(...(U=y.redos)!=null?U:[]),p.push(Me(a,R,S)),M.unshift(...(P=y.preUndos)!=null?P:[]),M.push(...(E=y.undos)!=null?E:[]),i.sequenceExecute(p,t).result?(n.pushUndoRedo({unitID:e.unitId,undoMutations:M.filter(Boolean),redoMutations:p.filter(Boolean)}),!0):!1}},Lo={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:async s=>{const t=s.get(g.SheetsSelectionsService).getCurrentSelections();let n;if((t==null?void 0:t.length)===1)n=t[0].range;else return!1;const o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a,unitId:l,subUnitId:u}=r,{startColumn:d,endColumn:c}=n,m=0,h=a.getRowCount()-1,R={unitId:l,subUnitId:u,direction:i.Direction.LEFT,range:{startColumn:d,endColumn:c,startRow:m,endRow:h,rangeType:i.RANGE_TYPE.COLUMN},cellValue:Oe(a,m,h,d,c,!1,d-1)};return s.get(i.ICommandService).executeCommand(_e.id,R)}},$o={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:async s=>{const t=s.get(g.SheetsSelectionsService).getCurrentSelections();let n;if((t==null?void 0:t.length)===1)n=t[0].range;else return!1;const o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a,unitId:l,subUnitId:u}=r,d=n.endColumn-n.startColumn+1,c=n.endColumn+1,m=n.endColumn+d,h=0,R=a.getRowCount()-1,S={unitId:l,subUnitId:u,direction:i.Direction.RIGHT,range:{startColumn:c,endColumn:m,startRow:h,endRow:R},cellValue:Oe(a,h,R,c,m,!1,n.endColumn)};return s.get(i.ICommandService).executeCommand(_e.id,S)}},Bo={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-before",handler:async(s,e)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();let o;if((n==null?void 0:n.length)===1)o=n[0].range;else return!1;const r=s.get(i.IUniverInstanceService),a=T(r);if(!a)return!1;const{worksheet:l,unitId:u,subUnitId:d}=a,c=e.value||0,m=o.startColumn,h=o.startColumn+c-1,R=0,S=l.getRowCount()-1,C={unitId:u,subUnitId:d,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:R,endRow:S,rangeType:i.RANGE_TYPE.COLUMN},cellValue:Oe(l,R,S,m,h,!1,m-1)};return s.get(i.ICommandService).executeCommand(_e.id,C)}},Ho={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-right",handler:async(s,e)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();let o;if((n==null?void 0:n.length)===1)o=n[0].range;else return!1;const r=s.get(i.IUniverInstanceService),a=T(r);if(!a)return!1;const{worksheet:l,unitId:u,subUnitId:d}=a,c=e.value||0,m=o.endColumn+1,h=o.endColumn+c,R=0,S=l.getRowCount()-1,C={unitId:u,subUnitId:d,direction:i.Direction.RIGHT,range:{startColumn:m,endColumn:h,startRow:R,endRow:S},cellValue:Oe(l,R,S,m,h,!1,o.endColumn)};return s.get(i.ICommandService).executeCommand(_e.id,C)}},jo={id:"sheet.command.insert-sheet",type:i.CommandType.COMMAND,handler:(s,e)=>{var I;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(i.LocaleService),a=ro(o,{unitId:e==null?void 0:e.unitId});if(!a)return!1;const{unitId:l,workbook:u}=a;let d=u.getSheets().length;const c=e==null?void 0:e.sheet,m=c==null?void 0:c.id,h=i.mergeWorksheetSnapshotWithDefault(c||{});e?(d=(I=e.index)!=null?I:d,h.id=m||i.Tools.generateRandomId(),h.name=(c==null?void 0:c.name)||u.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`)):(h.id=i.Tools.generateRandomId(),h.name=u.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`));const R={index:d,sheet:h,unitId:l},S=Wn(s,R);return t.syncExecuteCommand(st.id,R)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:ze.id,params:S}],redoMutations:[{id:st.id,params:R}]}),!0):!1}};function Fo(s,e){const{unitId:t,subUnitId:n,sourceRange:o,targetRange:r}=e,a=o.startRow>r.startRow,l=o.endRow-o.startRow+1;return a?{unitId:t,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...o,endRow:o.endRow+l,startRow:o.startRow+l}}:{unitId:t,subUnitId:n,targetRange:i.Rectangle.clone(o),sourceRange:{...r,endRow:r.endRow-l,startRow:r.startRow-l}}}const Ne={id:"sheet.mutation.move-rows",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,sourceRange:o,targetRange:r}=e,l=s.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(!l)throw new Error("[MoveRowMutation] univerSheet is null!");const u=l.getSheetBySheetId(n);if(!u)throw new Error("[MoveRowMutation] worksheet is null!");const d=o.startRow,c=o.endRow-o.startRow+1,m=r.startRow,h=u.getRowManager().getRowData();return i.moveMatrixArray(d,c,m,h),u.getCellMatrix().moveRows(d,c,m),!0}};function Go(s,e){const{unitId:t,subUnitId:n,sourceRange:o,targetRange:r}=e,a=o.startColumn>r.startColumn,l=o.endColumn-o.startColumn+1;return a?{unitId:t,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...o,endColumn:o.endColumn+l,startColumn:o.startColumn+l}}:{unitId:t,subUnitId:n,targetRange:i.Rectangle.clone(o),sourceRange:{...r,startColumn:r.startColumn-l,endColumn:r.endColumn-l}}}const De={id:"sheet.mutation.move-columns",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,sourceRange:o,targetRange:r}=e,l=s.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(!l)throw new Error("[MoveColumnMutation] univerSheet is null!");const u=l.getSheetBySheetId(n);if(!u)throw new Error("[MoveColumnMutation] worksheet is null!");const d=o.startColumn,c=o.endColumn-o.startColumn+1,m=r.startColumn,h=u.getColumnManager().getColumnData();return i.moveMatrixArray(d,c,m,h),u.getCellMatrix().moveColumns(d,c,m),!0}};function Oa(s,e){return e.getMergeData().some(t=>t.startRow<s&&s<=t.endRow)}function Na(s,e){return e.getMergeData().some(t=>t.startColumn<s&&s<=t.endColumn)}const zo="sheet.command.move-rows",Nt={id:zo,type:i.CommandType.COMMAND,handler:(s,e)=>{var W,L;const t=s.get(g.SheetsSelectionsService),{fromRange:{startRow:n},toRange:{startRow:o},range:r}=e,a=r?[Yo(r)]:t.getCurrentSelections(),l=a==null?void 0:a.filter(H=>H.range.rangeType===i.RANGE_TYPE.ROW&&H.range.startRow<=n&&n<=H.range.endRow);if((l==null?void 0:l.length)!==1)return!1;const u=s.get(g.SheetInterceptorService),d=s.get(i.IUniverInstanceService),c=T(d,e);if(!c)return!1;const{workbook:m,worksheet:h}=c,R=m.getUnitId(),S=h.getSheetId(),C=s.get(i.ErrorService),I=s.get(i.LocaleService),v=l[0].range,w=l[0].primary,p=Ut(v,h,!1);if(!i.Rectangle.equals(v,p))return C.emit(I.t("sheets.info.partOfCell")),!1;if(Oa(o,h))return C.emit(I.t("sheets.info.acrossMergedCell")),!1;const M={...v,startRow:o,endRow:o+v.endRow-v.startRow},y={unitId:R,subUnitId:S,sourceRange:v,targetRange:M},b=Fo(s,y),k=s.get(i.ICommandService),U=u.onCommandExecute({id:Nt.id,params:e}),P=[...(W=U.preRedos)!=null?W:[],{id:Ne.id,params:y}],E=[...(L=U.preUndos)!=null?L:[],{id:Ne.id,params:b}];if(w){const j=o-n<0,Y=v.endRow-v.startRow+1,K=j?M:{...M,startRow:M.startRow-Y,endRow:M.endRow-Y},Ue={unitId:R,subUnitId:S,type:ee.MOVE_END,selections:[{range:K,primary:te(K,h),style:null}]},_t={unitId:R,subUnitId:S,type:ee.MOVE_END,selections:[{range:v,primary:w,style:null}]};P.push({id:q.id,params:Ue}),E.push({id:q.id,params:_t})}return P.push(...U.redos),E.push(...U.undos),i.sequenceExecute(P,k).result?(s.get(i.IUndoRedoService).pushUndoRedo({unitID:R,undoMutations:E,redoMutations:P}),!0):!1}},qo="sheet.command.move-cols",Dt={id:qo,type:i.CommandType.COMMAND,handler:(s,e)=>{var W,L;const t=s.get(g.SheetsSelectionsService),{fromRange:{startColumn:n},toRange:{startColumn:o},range:r}=e,a=r?[Yo(r)]:t.getCurrentSelections(),l=a==null?void 0:a.filter(H=>H.range.rangeType===i.RANGE_TYPE.COLUMN&&H.range.startColumn<=n&&n<=H.range.endColumn);if((l==null?void 0:l.length)!==1)return!1;const u=s.get(g.SheetInterceptorService),d=s.get(i.IUniverInstanceService),c=T(d,e);if(!c)return!1;const{workbook:m,worksheet:h}=c,R=m.getUnitId(),S=h.getSheetId(),C=s.get(i.ErrorService),I=s.get(i.LocaleService),v=l[0].range,w=l[0].primary,p=Ut(v,h,!1);if(!i.Rectangle.equals(v,p))return C.emit(I.t("sheets.info.partOfCell")),!1;if(Na(o,h))return C.emit(I.t("sheets.info.acrossMergedCell")),!1;const M={...v,startColumn:o,endColumn:o+v.endColumn-v.startColumn},y={unitId:R,subUnitId:S,sourceRange:v,targetRange:M},b=Go(s,y),k=s.get(i.ICommandService),U=u.onCommandExecute({id:Dt.id,params:e}),P=[...(W=U.preRedos)!=null?W:[],{id:De.id,params:y}],E=[...(L=U.preUndos)!=null?L:[],{id:De.id,params:b}];if(w){const H=v.endColumn-v.startColumn+1,K=o-n<0?M:{...M,startColumn:M.startColumn-H,endColumn:M.endColumn-H},Ue={unitId:R,subUnitId:S,type:ee.MOVE_END,selections:[{range:K,primary:te(K,h),style:null}]},_t={unitId:R,subUnitId:S,type:ee.MOVE_END,selections:[{range:v,primary:w,style:null}]};P.push({id:q.id,params:Ue}),E.push({id:q.id,params:_t})}return P.push(...U.redos),E.push(...U.undos),i.sequenceExecute(P,k).result&&s.get(i.IUndoRedoService).pushUndoRedo({unitID:R,undoMutations:E,redoMutations:P}),!0}};function Yo(s){return{range:s,primary:null,style:null}}const lt={id:"sheet.mutation.register-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,rangeThemeStyleJson:n,themeName:o}=e,r=s.get(i.IUniverInstanceService),a=T(r),l=s.get(g.SheetRangeThemeModel);if(!a)return!1;const u=new ke(o,n);return l.registerRangeThemeStyle(t,u),!0}},un={id:"sheet.mutation.unregister-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,themeName:n}=e,o=s.get(i.IUniverInstanceService),r=T(o),a=s.get(g.SheetRangeThemeModel);return r?(a.unregisterRangeThemeStyle(t,n),!0):!1}},Ko={id:"sheet.command.register-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(s,e)=>{if(!e)return!1;const{unitId:t,rangeThemeStyle:n}=e,o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService);if(!T(o))return!1;const u={unitId:t,themeName:n.getName(),rangeThemeStyleJson:n.toJson()},d={unitId:t,themeName:n.getName()};return r.syncExecuteCommand(lt.id,u)&&a.pushUndoRedo({unitID:t,undoMutations:[{id:un.id,params:d}],redoMutations:[{id:lt.id,params:u}]}),!0}},gs={id:"sheet.command.remove-defined-name",type:i.CommandType.COMMAND,handler:(s,e)=>{var c,m;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService);if(!e)return!1;const r={...e},a=o.onCommandExecute({id:gs.id,params:e}),l=[...(c=a.preRedos)!=null?c:[],{id:z.RemoveDefinedNameMutation.id,params:r},...a.redos],u=[...(m=a.preUndos)!=null?m:[],{id:z.SetDefinedNameMutation.id,params:r},...a.undos];return i.sequenceExecute(l,t)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:u.filter(Boolean),redoMutations:l.filter(Boolean)}),!0):!1}},Rs="sheet.command.remove-row",Ss={type:i.CommandType.COMMAND,id:"sheet.command.remove-row-by-range",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.IUniverInstanceService),n=T(t,e);if(!n)return!1;const{workbook:o,worksheet:r}=n,a=s.get(g.SheetInterceptorService),{range:l,unitId:u,subUnitId:d}=e,c=Tt([l],s,u,d).reverse(),m=[],h=[];c.forEach(C=>{var k,U,P,E;const I=[],v=[],w={unitId:u,subUnitId:d,range:C},p=xi(w,r),M=r.getCellMatrix().getSlice(C.startRow,C.endRow,0,r.getColumnCount()-1),y={unitId:u,subUnitId:d,cellValue:M.getMatrix()},b=a.onCommandExecute({id:Rs,params:{range:C}});v.push(...(k=b.preRedos)!=null?k:[]),v.push({id:fe.id,params:w}),v.push(...(U=b.redos)!=null?U:[]),I.push(...(P=b.preUndos)!=null?P:[]),I.push({id:Ce.id,params:p}),I.push({id:B.id,params:y}),I.push(...(E=b.undos)!=null?E:[]),h.push(...v),m.unshift(...I)}),h.push(Me(l,o,r));const R=s.get(i.ICommandService);return i.sequenceExecute(h,R).result?(s.get(i.IUndoRedoService).pushUndoRedo({unitID:u,undoMutations:m,redoMutations:h}),!0):!1}},At={type:i.CommandType.COMMAND,id:Rs,handler:async(s,e)=>{var h;const t=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.ICommandService);let r=e==null?void 0:e.range;if(r||(r=(h=t.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=s.get(i.IUniverInstanceService),l=T(a);if(!l)return!1;const{worksheet:u,subUnitId:d,unitId:c}=l;return r={...r,startColumn:0,endColumn:Math.max(u.getMaxColumns()-1,0)},await n.beforeCommandExecute({id:At.id,params:{range:r}})?o.syncExecuteCommand(Ss.id,{range:r,unitId:c,subUnitId:d}):!1}},Cs="sheet.command.remove-col",fs={type:i.CommandType.COMMAND,id:"sheet.command.remove-col-by-range",handler:(s,e)=>{var v,w,p;if(!e)return!1;const t=s.get(i.IUniverInstanceService),n=T(t,e);if(!n)return!1;const{workbook:o,worksheet:r}=n,a=s.get(g.SheetInterceptorService),{range:l,unitId:u,subUnitId:d}=e,c={unitId:u,subUnitId:d,range:l},m=Qi(s,c),h=r.getCellMatrix().getSlice(0,r.getRowCount()-1,l.startColumn,l.endColumn),R={unitId:u,subUnitId:d,cellValue:h.getMatrix()},S=a.onCommandExecute({id:Cs,params:{range:l}}),C=s.get(i.ICommandService);return i.sequenceExecute([...(v=S.preRedos)!=null?v:[],{id:re.id,params:c},...S.redos,Me(l,o,r)],C).result?(s.get(i.IUndoRedoService).pushUndoRedo({unitID:u,undoMutations:[...(w=S.preUndos)!=null?w:[],{id:de.id,params:m},{id:B.id,params:R},...S.undos],redoMutations:[...(p=S.preRedos)!=null?p:[],{id:re.id,params:c},...S.redos]}),!0):!1}},Wt={type:i.CommandType.COMMAND,id:Cs,handler:async(s,e)=>{var h;const t=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.ICommandService);let r=e==null?void 0:e.range;if(r||(r=(h=t.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=s.get(i.IUniverInstanceService),l=T(a);if(!l)return!1;const{worksheet:u,subUnitId:d,unitId:c}=l;return r={...r,startRow:0,endRow:Math.max(u.getMaxRows()-1,0)},await n.beforeCommandExecute({id:Wt.id,params:{range:r}})?o.syncExecuteCommand(fs.id,{range:r,unitId:c,subUnitId:d}):!1}},dn={id:"sheet.command.remove-sheet",type:i.CommandType.COMMAND,handler:(s,e)=>{var v,w;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=T(o,e);if(!a)return!1;const{unitId:l,subUnitId:u,workbook:d,worksheet:c}=a;if(d.getSheets().length<=1)return!1;const m={subUnitId:u,unitId:l,subUnitName:c.getName()},h=fo(s,m),R=r.onCommandExecute({id:dn.id,params:{unitId:l,subUnitId:u}}),S=[...(v=R.preRedos)!=null?v:[],{id:ze.id,params:m},...R.redos],C=[...(w=R.preUndos)!=null?w:[],{id:st.id,params:h},...R.undos];return i.sequenceExecute(S,t).result?(n.pushUndoRedo({unitID:l,undoMutations:C,redoMutations:S}),!0):!1}},he=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:i.Tools.deepClone(e.ranges)}},F={id:"sheet.mutation.add-worksheet-merge",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const a=o.getConfig().mergeData,l=e.ranges;for(let u=0;u<l.length;u++)a.push(l[u]);return o.getSpanModel().rebuild(a),!0}},ne=(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(o==null)throw new Error("worksheet is null error!");const a=o.getConfig().mergeData,l=e.ranges,u=[];for(let d=0;d<l.length;d++)for(let c=a.length-1;c>=0;c--){const m=a[c],h=l[d];i.Rectangle.intersects(m,h)&&u.push(a[c])}return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:u}},G={id:"sheet.mutation.remove-worksheet-merge",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const a=o.getConfig().mergeData,l=e.ranges;for(let u=0;u<l.length;u++)for(let d=a.length-1;d>=0;d--){const c=a[d],m=l[u];i.Rectangle.intersects(c,m)&&a.splice(d,1)}return o.getSpanModel().rebuild(a),!0}},Jo={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:(s,e)=>{var O;const t=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=(e==null?void 0:e.ranges)||((O=t.getCurrentSelections())==null?void 0:O.map(W=>W.range));if(!(a!=null&&a.length))return!1;const l=T(r);if(!l)return!1;const{subUnitId:u,unitId:d,worksheet:c}=l,m={unitId:d,subUnitId:u,ranges:a},R=c.getConfig().mergeData.filter(W=>a.some(L=>i.Rectangle.intersects(L,W)));if(!R.length)return!1;const S=ne(s,m),C=t.getCurrentSelections();if(!(C!=null&&C.length))return!1;const I=i.Tools.deepClone(C),v=i.Tools.deepClone(C),w=v[v.length-1],{startRow:p,startColumn:M}=w.range;w.primary={startRow:p,startColumn:M,endRow:p,endColumn:M,actualRow:p,actualColumn:M,isMerged:!1,isMergedMainCell:!1};const y=Da(c,R),b={unitId:d,subUnitId:u,cellValue:y.redoParams.getMatrix()},k={unitId:d,subUnitId:u,cellValue:y.undoParams.getMatrix()},U=[{id:G.id,params:S},{id:B.id,params:b},{id:q.id,params:{selections:v}}],P=[{id:F.id,params:S},{id:B.id,params:k},{id:q.id,params:{selections:I}}];return i.sequenceExecute(U,n)?(o.pushUndoRedo({unitID:d,undoMutations:P,redoMutations:U}),!0):!1}};function Da(s,e){const t=new i.ObjectMatrix,n=new i.ObjectMatrix;return e.forEach(o=>{const{startRow:r,startColumn:a,endColumn:l,endRow:u}=o,d=s.getCellMatrix().getValue(r,a);if(d!=null&&d.s)for(let c=r;c<=u;c++)for(let m=a;m<=l;m++)(c!==r||m!==a)&&(t.setValue(c,m,{s:d.s}),n.setValue(c,m,null))}),{redoParams:t,undoParams:n}}const Xo=s=>{const{order:e}=s,t={};return Object.keys(e).forEach(n=>{t[e[Number(n)]]=Number(n)}),{...s,order:t}},Vt={id:"sheet.mutation.reorder-range",type:i.CommandType.MUTATION,handler:(s,e)=>{const{subUnitId:t,unitId:n,range:o,order:r}=e,u=s.get(i.IUniverInstanceService).getUnit(n).getSheetBySheetId(t);if(!u)return!1;const d=new i.ObjectMatrix;i.Range.foreach(o,(m,h)=>{if(r.hasOwnProperty(m)){const R=r[m],S=i.Tools.deepClone(u.getCellRaw(R,h));d.setValue(m,h,S)}});const c=u.getCellMatrix();return d.forValue((m,h,R)=>{c.setValue(m,h,R)}),!0}},Zo="sheet.command.reorder-range",cn={id:Zo,type:i.CommandType.COMMAND,handler:(s,e)=>{var C,I;const{subUnitId:t,unitId:n,range:o,order:r}=e,a=s.get(i.ICommandService),l={id:Vt.id,params:{unitId:n,subUnitId:t,order:r,range:o}},u={id:Vt.id,params:Xo(l.params)},d=s.get(g.SheetInterceptorService),c=d.onCommandExecute({id:cn.id,params:e}),m=[...(C=c.preRedos)!=null?C:[],l,...c.redos],h=[...(I=c.preUndos)!=null?I:[],u,...c.undos],R=i.sequenceExecute(m,a),S=d.afterCommandExecute({id:cn.id,params:e});return R.result?(i.sequenceExecute(S.redos,a),s.get(i.IUndoRedoService).pushUndoRedo({unitID:n,undoMutations:[...h,...S.undos],redoMutations:[...m,...S.redos]}),!0):!1}};class Je{constructor(){f(this,"_borderInfo",{type:i.BorderType.ALL,color:"#000000",style:i.BorderStyleTypes.THIN,activeBorderType:!1});f(this,"_borderInfo$",new A.BehaviorSubject(this._borderInfo));f(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(e){this._borderInfo.type=e,this.setActiveBorderType(!0),this._refresh()}setColor(e){this._borderInfo.color=e,this._refresh()}setStyle(e){this._borderInfo.style=e,this._refresh()}setActiveBorderType(e){this._borderInfo.activeBorderType=e}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}}function mn(s,e){const{startRow:t,startColumn:n,endRow:o,endColumn:r}=s;for(let a=t;a<=o;a++)for(let l=n;l<=r;l++)e(a,l)}const Is=(s,e,t,n)=>{const{mr:o,worksheet:r}=s;e.startRow<0||e.startColumn<0||mn(e,(a,l)=>{var c,m;const u=r.getMergedCell(a,l);let d=t;if(u&&(t.bc_tr||t.ml_tr||t.bl_tr||t.tl_mr||t.tl_bc||t.tl_br)){if(n){const h=i.Tools.deepClone((c=o.getValue(u.startRow,u.startColumn))==null?void 0:c.s);d=h!=null&&h.bd?Object.assign(h.bd,t):t}o.setValue(u.startRow,u.startColumn,{s:{bd:d}})}else{if(n){const h=i.Tools.deepClone((m=o.getValue(a,l))==null?void 0:m.s);d=h!=null&&h.bd?Object.assign(h.bd,t):t}o.setValue(a,l,{s:{bd:d}})}})},Aa=s=>{const e={startRow:s.startRow-1,startColumn:s.startColumn,endRow:s.startRow-1,endColumn:s.endColumn},t={startRow:s.startRow,startColumn:s.startColumn-1,endRow:s.endRow,endColumn:s.startColumn-1},n={startRow:s.endRow+1,startColumn:s.startColumn,endRow:s.endRow+1,endColumn:s.endColumn},o={startRow:s.startRow,startColumn:s.endColumn+1,endRow:s.endRow,endColumn:s.endColumn+1},r={startRow:s.startRow,startColumn:s.startColumn,endRow:s.startRow,endColumn:s.endColumn},a={startRow:s.startRow,startColumn:s.startColumn,endRow:s.endRow,endColumn:s.startColumn},l={startRow:s.endRow,startColumn:s.startColumn,endRow:s.endRow,endColumn:s.endColumn},u={startRow:s.startRow,startColumn:s.endColumn,endRow:s.endRow,endColumn:s.endColumn};return{topRangeOut:e,leftRangeOut:t,bottomRangeOut:n,rightRangeOut:o,topRange:r,leftRange:a,bottomRange:l,rightRange:u}};function Wa(s,e,t){const{style:n,color:o,type:r}=s.getBorderInfo(),a=r===i.BorderType.TOP||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,l=r===i.BorderType.LEFT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,u=r===i.BorderType.BOTTOM||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,d=r===i.BorderType.RIGHT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,c=r===i.BorderType.VERTICAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,m=r===i.BorderType.HORIZONTAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,h=r.indexOf("tlbr")>-1,R=r.indexOf("tlbc")>-1,S=r.indexOf("tlmr")>-1,C=r.indexOf("bltr")>-1,I=r.indexOf("mltr")>-1,v=r.indexOf("bctr")>-1,w=t[0],{topRangeOut:p,leftRangeOut:M,bottomRangeOut:y,rightRangeOut:b,topRange:k,leftRange:U,bottomRange:P,rightRange:E}=Aa(w),O=new i.ObjectMatrix,{worksheet:W,unitId:L,subUnitId:H}=e;return{worksheet:W,unitId:L,subUnitId:H,style:n,color:o,type:r,top:a,left:l,right:d,bottom:u,vertical:c,horizontal:m,tl_br:h,tl_bc:R,tl_mr:S,bl_tr:C,ml_tr:I,bc_tr:v,topRangeOut:p,leftRangeOut:M,bottomRangeOut:y,rightRangeOut:b,topRange:k,leftRange:U,bottomRange:P,rightRange:E,range:w,mr:O,borderStyle:{s:n,cl:{rgb:o}}}}const Va=s=>{const{range:e,mr:t,borderStyle:n,vertical:o,horizontal:r,worksheet:a}=s;o&&mn(e,(l,u)=>{var c,m,h;const d=a.getMergedCell(l,u);if(d){const R=(c=t.getValue(d.startRow,d.startColumn))==null?void 0:c.s;d.startColumn!==e.startColumn&&t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}else{if(u!==e.endColumn){const R=(m=t.getValue(l,u))==null?void 0:m.s;t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{r:i.Tools.deepClone(n)}):{r:i.Tools.deepClone(n)}}})}if(u!==e.startColumn){const R=(h=t.getValue(l,u))==null?void 0:h.s;t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}}}),r&&mn(e,(l,u)=>{var c,m,h;const d=a.getMergedCell(l,u);if(d){const R=(c=t.getValue(d.startRow,d.startColumn))==null?void 0:c.s;d.startRow!==e.startRow&&t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}else{if(l!==e.endRow){const R=(m=t.getValue(l,u))==null?void 0:m.s;t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{b:i.Tools.deepClone(n)}):{b:i.Tools.deepClone(n)}}})}if(l!==e.startRow){const R=(h=t.getValue(l,u))==null?void 0:h.s;t.setValue(l,u,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}}})};function La(s){const{borderStyle:e,tl_br:t,tl_bc:n,tl_mr:o,bl_tr:r,ml_tr:a,bc_tr:l}=s,u=(d,c,m)=>{Is(s,d,c,m)};t&&u(s.range,{tl_br:i.Tools.deepClone(e)},!0),n&&u(s.range,{tl_bc:i.Tools.deepClone(e)},!0),o&&u(s.range,{tl_mr:i.Tools.deepClone(e)},!0),r&&u(s.range,{bl_tr:i.Tools.deepClone(e)},!0),a&&u(s.range,{ml_tr:i.Tools.deepClone(e)},!0),l&&u(s.range,{bc_tr:i.Tools.deepClone(e)},!0)}const $a=s=>{const{top:e,left:t,right:n,bottom:o,borderStyle:r,bottomRange:a,topRange:l,leftRange:u,rightRange:d,bottomRangeOut:c,topRangeOut:m,leftRangeOut:h,rightRangeOut:R}=s,S=(C,I,v)=>{Is(s,C,I,v)};e&&(S(m,{b:null}),S(l,{t:i.Tools.deepClone(r)},!0)),o&&(S(c,{t:null}),S(a,{b:i.Tools.deepClone(r)},!0)),t&&(S(h,{r:null}),S(u,{l:i.Tools.deepClone(r)},!0)),n&&(S(R,{l:null}),S(d,{r:i.Tools.deepClone(r)},!0))},Ba=s=>{const{range:e,worksheet:t,mr:n,top:o,bottom:r,left:a,right:l,vertical:u,horizontal:d,tl_br:c,tl_bc:m,tl_mr:h,bl_tr:R,ml_tr:S,bc_tr:C,topRange:I,bottomRange:v,leftRange:w,rightRange:p,topRangeOut:M,bottomRangeOut:y,leftRangeOut:b,rightRangeOut:k}=s,U=(P,E,O)=>{Is(s,P,E,O)};!o&&!r&&!a&&!l&&!u&&!d&&!c&&!m&&!h&&!R&&!S&&!C&&(mn(e,(P,E)=>{var W,L,H,j,Y,K,Ue,_t;const O=t.getMergedCell(P,E);if(O){if(O.endColumn!==e.endColumn){const $=(W=n.getValue(O.startRow,O.startColumn))==null?void 0:W.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{r:null}):{r:null}}})}if(O.startColumn!==e.startColumn){const $=(L=n.getValue(O.startRow,O.startColumn))==null?void 0:L.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{l:null}):{l:null}}})}if(O.endRow!==e.endRow){const $=(H=n.getValue(O.startRow,O.startColumn))==null?void 0:H.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{b:null}):{b:null}}})}if(O.startRow!==e.startRow){const $=(j=n.getValue(O.startRow,O.startColumn))==null?void 0:j.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{t:null}):{t:null}}})}}else{if(E!==e.endColumn){const $=(Y=n.getValue(P,E))==null?void 0:Y.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{r:null}):{r:null}}})}if(E!==e.startColumn){const $=(K=n.getValue(P,E))==null?void 0:K.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{l:null}):{l:null}}})}if(P!==e.endRow){const $=(Ue=n.getValue(P,E))==null?void 0:Ue.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{b:null}):{b:null}}})}if(P!==e.startRow){const $=(_t=n.getValue(P,E))==null?void 0:_t.s;n.setValue(P,E,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{t:null}):{t:null}}})}}}),U(M,{b:null}),U(I,{t:null},!0),U(y,{t:null}),U(v,{b:null},!0),U(b,{r:null}),U(w,{l:null},!0),U(k,{l:null}),U(p,{r:null},!0),U(e,{tl_br:null},!0),U(e,{tl_bc:null},!0),U(e,{tl_mr:null},!0),U(e,{bl_tr:null},!0),U(e,{ml_tr:null},!0),U(e,{bc_tr:null},!0))},ut={id:"sheet.command.set-border",type:i.CommandType.COMMAND,handler:(s,e)=>{var v;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(Je),l=T(o,e);if(!l)return!1;const u=(e==null?void 0:e.ranges)||((v=r.getCurrentSelections())==null?void 0:v.map(w=>w.range));if(!(u!=null&&u.length))return!1;const{activeBorderType:d}=a.getBorderInfo();if(!d)return!1;const c=Wa(a,l,u);Va(c),$a(c),La(c),Ba(c);const{unitId:m,subUnitId:h,mr:R}=c,S={unitId:m,subUnitId:h,cellValue:R.getData()},C=ie(s,S);return t.syncExecuteCommand(B.id,S)?(n.pushUndoRedo({unitID:m,undoMutations:[{id:B.id,params:C}],redoMutations:[{id:B.id,params:S}]}),!0):!1}},xo={id:"sheet.command.set-border-position",type:i.CommandType.COMMAND,handler:(s,e)=>{if(!e.value)return!1;const t=s.get(i.ICommandService);return s.get(Je).setType(e.value),t.syncExecuteCommand(ut.id)}},Qo={id:"sheet.command.set-border-style",type:i.CommandType.COMMAND,handler:(s,e)=>{const t=s.get(i.ICommandService);return s.get(Je).setStyle(e.value),t.syncExecuteCommand(ut.id)}},er={id:"sheet.command.set-border-color",type:i.CommandType.COMMAND,handler:(s,e)=>{const t=s.get(i.ICommandService);return s.get(Je).setColor(e.value),t.syncExecuteCommand(ut.id)}},tr={id:"sheet.command.set-border-basic",type:i.CommandType.COMMAND,handler:(s,e)=>{const{unitId:t,subUnitId:n,value:o,ranges:r}=e,{type:a,color:l,style:u}=o,d=s.get(i.ICommandService),c=s.get(Je);return c.setType(a),l&&c.setColor(l),c.setStyle(u),d.syncExecuteCommand(ut.id,{unitId:t,subUnitId:n,ranges:r})}};function Ha(s,e){if(s==null)return s;const t=i.Tools.deepClone(s);if(e==null)return t;const n={};return"h"in e&&(n.h=t.h),"ia"in e&&(n.ia=t.ia),"ah"in e&&(n.ah=t.ah),"hd"in e&&(n.hd=t.hd),"s"in e&&(n.s=t.s),"custom"in e&&(n.custom=t.custom),n}function ja(s,e){if(s==null)return s;const t=i.Tools.deepClone(s);if(e==null)return t;const n={};return"w"in e&&(n.w=t.w),"hd"in e&&(n.hd=t.hd),"s"in e&&(n.s=t.s),"custom"in e&&(n.custom=t.custom),n}const nr=(s,e)=>{const{unitId:t,subUnitId:n,columnData:o}=s,r={},a=e.getColumnManager();for(const l in o){const u=o[l],d=a.getColumn(Number(l));r[l]=ja(d,u)}return{unitId:t,subUnitId:n,columnData:r}},dt={id:"sheet.mutation.set-col-data",type:i.CommandType.MUTATION,handler:(s,e)=>{const{columnData:t}=e,n=s.get(i.IUniverInstanceService),o=T(n,e);if(!o)return!1;const{worksheet:r}=o,a=r.getColumnManager();for(const l in t){const u=t[l];if(u==null){a.removeColumn(Number(l));continue}const d=a.getColumnOrCreate(Number(l));Object.assign(d,u)}return!0}},sr={type:i.CommandType.COMMAND,id:"sheet.command.set-col-data",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=T(o,e);if(!r)return!1;const{columnData:a}=e,{unitId:l,subUnitId:u,worksheet:d}=r,c={subUnitId:u,unitId:l,columnData:a},m=nr(c,d);return t.syncExecuteCommand(dt.id,c)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:dt.id,params:m}],redoMutations:[{id:dt.id,params:c}]}),!0):!1}},Fa=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},ct={id:"sheet.mutation.set-col-hidden",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!n)return!1;const o=n.getSheetBySheetId(e.subUnitId).getColumnManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let l=a.startColumn;l<a.endColumn+1;l++){const u=o.getColumnOrCreate(l);u!=null&&(u.hd=i.BooleanNumber.TRUE)}}return!0}},Ga=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},mt={id:"sheet.mutation.set-col-visible",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!n)return!1;const o=n.getSheetBySheetId(e.subUnitId).getColumnManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let l=a.startColumn;l<a.endColumn+1;l++){const u=o.getColumnOrCreate(l);u!=null&&(u.hd=i.BooleanNumber.FALSE)}}return!0}},Lt={type:i.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:(s,e)=>{var v,w;const{unitId:t,subUnitId:n,ranges:o}=e,r=s.get(g.SheetInterceptorService),a=s.get(i.ICommandService),l=s.get(i.IUniverInstanceService),u=T(l,{unitId:t,subUnitId:n});if(!u)return!1;const{worksheet:d}=u,c={unitId:t,subUnitId:n,ranges:o},m={unitId:t,subUnitId:n,reveal:!0,selections:o.map(p=>({range:p,primary:te(p,d),style:null}))},h=Ga(s,c),R={unitId:t,subUnitId:n,selections:or(o).map(p=>({range:p,primary:te(p,d),style:null}))},S=i.sequenceExecute([{id:mt.id,params:c},{id:q.id,params:m}],a),C=r.onCommandExecute({id:Lt.id,params:e}),I=i.sequenceExecute([...C.redos],a);return S.result&&I.result&&s.get(i.IUndoRedoService).pushUndoRedo({unitID:t,undoMutations:[{id:ct.id,params:h},{id:q.id,params:R},...(v=C.undos)!=null?v:[]],redoMutations:[...(w=C.preRedos)!=null?w:[],{id:mt.id,params:c},{id:q.id,params:m},...C.redos]}),!0}},vs={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:s=>{var d;const e=s.get(g.SheetsSelectionsService),t=s.get(i.ICommandService),n=(d=e.getCurrentSelections())==null?void 0:d.map(c=>c.range).filter(c=>c.rangeType===i.RANGE_TYPE.COLUMN);if(!(n!=null&&n.length))return!1;const o=T(s.get(i.IUniverInstanceService));if(!o)return!1;const{worksheet:r,unitId:a,subUnitId:l}=o,u=n.map(c=>r.getHiddenCols(c.startColumn,c.endColumn)).flat();return t.executeCommand(Lt.id,{unitId:a,subUnitId:l,ranges:u})}},ps={type:i.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:(s,e)=>{var w,p,M,y;const t=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService);let a=(w=e==null?void 0:e.ranges)!=null&&w.length?e.ranges:(p=t.getCurrentSelections())==null?void 0:p.map(b=>b.range).filter(b=>b.rangeType===i.RANGE_TYPE.COLUMN);if(!(a!=null&&a.length))return!1;const l=T(o,e);if(!l)return!1;const{worksheet:u,unitId:d,subUnitId:c}=l;a=za(l.worksheet,a);const m={unitId:d,subUnitId:c,ranges:a},h={unitId:d,subUnitId:c,selections:or(a).map(b=>({range:b,primary:te(b,u),style:null}))},R=Fa(s,m),S={unitId:d,subUnitId:c,reveal:!0,selections:a.map(b=>({range:b,primary:te(b,u),style:null}))},C=i.sequenceExecute([{id:ct.id,params:m},{id:q.id,params:h}],r),I=n.onCommandExecute({id:ps.id,params:m}),v=i.sequenceExecute([...I.redos],r);return C.result&&v.result?(s.get(i.IUndoRedoService).pushUndoRedo({unitID:d,undoMutations:[{id:mt.id,params:R},{id:q.id,params:S},...(M=I.undos)!=null?M:[]],redoMutations:[...(y=I.preRedos)!=null?y:[],{id:ct.id,params:m},{id:q.id,params:h},...I.redos]}),!0):!1}};function za(s,e){const t=s.getRowCount()-1,n=s.getHiddenCols(),o=[];return e.forEach(r=>{const a=n.filter(l=>l.startColumn>=r.startColumn&&l.endColumn<=r.endColumn);if(a.length){let l=r.startColumn;a.forEach(u=>{u.startColumn>l&&(o.push({startColumn:l,endColumn:u.startColumn-1,startRow:0,endRow:t}),l=u.endColumn+1)}),l<=r.endColumn&&o.push({startColumn:l,endColumn:r.endColumn,startRow:0,endRow:t})}else o.push(r)}),o}function or(s){return qa(s).map(t=>{const n=t.startColumn===0?t.endColumn+1:t.startColumn-1;return{...t,startColumn:n,endColumn:n}})}function qa(s){const e=[];let t;return s.sort((n,o)=>n.startColumn-o.startColumn).forEach(n=>{if(!t){t=n;return}t.endColumn===n.startColumn-1?t.endColumn=n.endColumn:(e.push(t),t=n)}),e.push(t),e}const ws={id:"sheet.command.set-defined-name",type:i.CommandType.COMMAND,handler:(s,e)=>{var m,h;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService);if(!e)return!1;const r={...e},a=z.SetDefinedNameMutationFactory(s,e),l=o.onCommandExecute({id:ws.id,params:e}),u=[...(m=l.preRedos)!=null?m:[],{id:z.RemoveDefinedNameMutation.id,params:a},{id:z.SetDefinedNameMutation.id,params:r},...l.redos],d=[...(h=l.preUndos)!=null?h:[],{id:z.RemoveDefinedNameMutation.id,params:r},{id:z.SetDefinedNameMutation.id,params:a},...l.undos];return i.sequenceExecute(u,t)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:d.filter(Boolean),redoMutations:u.filter(Boolean)}),!0):!1}},Ms=(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(o==null)throw new Error("worksheet is null error!");const a=o.getConfig().freeze;return{unitId:e.unitId,subUnitId:e.subUnitId,...a}},$e={id:"sheet.mutation.set-frozen",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId);if(!o)return!1;const r=o.getConfig(),{startRow:a,startColumn:l,ySplit:u,xSplit:d}=e;return r.freeze={startRow:a,startColumn:l,ySplit:u,xSplit:d},!0}},rr={type:i.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=T(o,{unitId:e.unitId,subUnitId:e.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:l,worksheet:u}=r,{startColumn:d,startRow:c,xSplit:m,ySplit:h}=e;if(c>=u.getRowCount()||d>=u.getColumnCount()||m>=u.getColumnCount()||h>=u.getRowCount())return!1;const R={unitId:a,subUnitId:l,...e},S=Ms(s,R);return t.syncExecuteCommand($e.id,R)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:$e.id,params:S}],redoMutations:[{id:$e.id,params:R}]}),!0):!1}},ir={type:i.CommandType.COMMAND,id:"sheet.command.cancel-frozen",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUniverInstanceService),o=s.get(i.IUndoRedoService),r=T(n,{unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:l}=r,u={unitId:a,subUnitId:l,startRow:-1,startColumn:-1,xSplit:0,ySplit:0},d=Ms(s,u);return t.syncExecuteCommand($e.id,u)&&o.pushUndoRedo({unitID:a,undoMutations:[{id:$e.id,params:d}],redoMutations:[{id:$e.id,params:u}]}),!0}},ht={id:"sheet.mutation.set-gridlines-color",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=T(s.get(i.IUniverInstanceService),e);if(!t)return!1;const{worksheet:n}=t,o=n.getConfig();return o.gridlinesColor=e.color,!0}},ar={type:i.CommandType.COMMAND,id:"sheet.command.set-gridlines-color",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a}=r,l=a.getConfig().gridlinesColor;if(l===(e==null?void 0:e.color))return!1;const{unitId:u,subUnitId:d}=r,c={color:e==null?void 0:e.color,unitId:u,subUnitId:d},m={color:l,unitId:u,subUnitId:d};return t.syncExecuteCommand(ht.id,c)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:ht.id,params:m}],redoMutations:[{id:ht.id,params:c}]}),!0):!1}},x={id:"sheet.mutation.set-range-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,rule:o,ruleId:r}=e;return s.get(J).setRule(t,n,r,o),!0}},Ya=(s,e)=>{const{unitId:t,subUnitId:n,ruleId:o}=e,a=s.get(J).getRule(t,n,o);return a?{id:x.id,params:{...e,rule:a}}:null},Xe={id:"sheet.mutation.set-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,e)=>{const{unitId:t,subUnitId:n,rule:o}=e;return s.get(we).setRule(t,n,o),!0}},lr={type:i.CommandType.COMMAND,id:"sheet.command.set-protection",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(J),{rule:r,oldRule:a}=e,{unitId:l,subUnitId:u}=r,d=[],c=[];return(a==null?void 0:a.unitType)===r.unitType?r.unitType===N.Worksheet?(d.push({id:Xe.id,params:{unitId:l,subUnitId:u,rule:r}}),c.push({id:Xe.id,params:{unitId:l,subUnitId:u,rule:a}})):(d.push({id:x.id,params:{unitId:l,subUnitId:u,rule:r,ruleId:r.id}}),c.push({id:x.id,params:{unitId:l,subUnitId:u,ruleId:a.id,rule:a}})):(a&&(a.unitType===N.Worksheet?(d.push({id:Ge.id,params:{unitId:l,subUnitId:u}}),c.push({id:Ve.id,params:{unitId:l,rule:a,subUnitId:a.subUnitId}})):a.unitType===N.SelectRange&&(d.push({id:pe.id,params:{unitId:l,subUnitId:u,ruleIds:[a.id]}}),c.push({id:ue.id,params:{unitId:l,subUnitId:u,rules:[a]}}))),r.unitType===N.Worksheet?(d.push({id:Ve.id,params:{unitId:l,rule:r,subUnitId:r.subUnitId}}),c.unshift({id:Ge.id,params:{unitId:l,subUnitId:u}})):r.unitType===N.SelectRange&&(r.id=o.createRuleId(l,u),d.push({id:ue.id,params:{unitId:l,subUnitId:u,rules:[r]}}),c.unshift({id:pe.id,params:{unitId:l,subUnitId:u,ruleIds:[r.id]}}))),i.sequenceExecute(d,t)&&n.pushUndoRedo({unitID:l,undoMutations:c,redoMutations:d}),!0}},ur=(s,e)=>{const{unitId:t,subUnitId:n,rowData:o}=s,r={},a=e.getRowManager();for(const l in o){const u=o[l],d=a.getRow(Number(l));r[l]=Ha(d,u)}return{unitId:t,subUnitId:n,rowData:r}},gt={id:"sheet.mutation.set-row-data",type:i.CommandType.MUTATION,handler:(s,e)=>{const{rowData:t}=e,n=s.get(i.IUniverInstanceService),o=T(n,e);if(!o)return!1;const{worksheet:r}=o,a=r.getRowManager();for(const l in t){const u=t[l];if(u==null){a.removeRow(Number(l));continue}const d=a.getRowOrCreate(Number(l));Object.assign(d,u)}return!0}},dr={type:i.CommandType.COMMAND,id:"sheet.command.set-row-data",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=T(o,e);if(!r)return!1;const{rowData:a}=e,{unitId:l,subUnitId:u,worksheet:d}=r,c={subUnitId:u,unitId:l,rowData:a},m=ur(c,d);return t.syncExecuteCommand(gt.id,c)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:gt.id,params:m}],redoMutations:[{id:gt.id,params:c}]}),!0):!1}},Ka=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},Rt={id:"sheet.mutation.set-row-visible",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId).getRowManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let l=a.startRow;l<a.endRow+1;l++){const u=o.getRowOrCreate(l);u!=null&&(u.hd=0)}}return!0}},Ja=(s,e)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},St={id:"sheet.mutation.set-row-hidden",type:i.CommandType.MUTATION,handler:(s,e)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(e.subUnitId).getRowManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let l=a.startRow;l<a.endRow+1;l++){const u=o.getRowOrCreate(l);u!=null&&(u.hd=1)}}return!0}},$t={type:i.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:(s,e)=>{var v,w,p;const{unitId:t,subUnitId:n,ranges:o}=e,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),l=s.get(g.SheetInterceptorService),u=T(s.get(i.IUniverInstanceService),{unitId:t,subUnitId:n});if(!u)return!1;const{worksheet:d}=u,c={unitId:t,subUnitId:n,ranges:o},m={unitId:t,subUnitId:n,reveal:!0,selections:o.map(M=>({range:M,primary:te(M,d),style:null}))},h=Ka(s,c),R={unitId:t,subUnitId:n,selections:cr(o).map(M=>({range:M,primary:te(M,d),style:null}))},S=i.sequenceExecute([{id:Rt.id,params:c},{id:q.id,params:m}],r),C=l.onCommandExecute({id:$t.id,params:e}),I=i.sequenceExecute([...C.redos],r);return S.result&&I.result&&a.pushUndoRedo({unitID:t,undoMutations:[...(v=C.preUndos)!=null?v:[],{id:St.id,params:h},{id:q.id,params:R},...(w=C.undos)!=null?w:[]],redoMutations:[...(p=C.preRedos)!=null?p:[],{id:Rt.id,params:c},{id:q.id,params:m},...C.redos]}),!0}},ys={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:async s=>{var c;const e=s.get(g.SheetsSelectionsService),t=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=(c=e.getCurrentSelections())==null?void 0:c.map(m=>m.range).filter(m=>m.rangeType===i.RANGE_TYPE.ROW);if(!(o!=null&&o.length))return!1;const r=T(t);if(!r)return!1;const{worksheet:a,unitId:l,subUnitId:u}=r,d=o.map(m=>a.getHiddenRows(m.startRow,m.endRow)).flat();return n.executeCommand($t.id,{unitId:l,subUnitId:u,ranges:d})}},_s={type:i.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:(s,e)=>{var w,p,M,y,b,k;const t=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=s.get(g.SheetInterceptorService);let l=(w=e==null?void 0:e.ranges)!=null&&w.length?e.ranges:(p=t.getCurrentSelections())==null?void 0:p.map(U=>U.range).filter(U=>U.rangeType===i.RANGE_TYPE.ROW);if(!(l!=null&&l.length))return!1;const u=T(r,e);if(!u)return!1;l=Xa(u.worksheet,l);const{unitId:d,subUnitId:c,worksheet:m}=u,h={unitId:d,subUnitId:c,ranges:l},R={unitId:d,subUnitId:c,selections:cr(l).map(U=>({range:U,primary:te(U,m),style:null}))},S=Ja(s,h),C={unitId:d,subUnitId:c,reveal:!0,selections:l.map(U=>({range:U,primary:te(U,m),style:null}))},I=a.onCommandExecute({id:_s.id,params:h});return i.sequenceExecute([...(M=I.preRedos)!=null?M:[],{id:St.id,params:h},{id:q.id,params:R},...I.redos],n).result&&o.pushUndoRedo({unitID:d,undoMutations:[...(y=I.preUndos)!=null?y:[],{id:Rt.id,params:S},{id:q.id,params:C},...(b=I.undos)!=null?b:[]],redoMutations:[...(k=I.preRedos)!=null?k:[],{id:St.id,params:h},{id:q.id,params:R},...I.redos]}),!0}};function Xa(s,e){const t=s.getMaxColumns()-1,n=s.getHiddenRows(),o=[];return e.forEach(r=>{const a=n.filter(l=>l.startRow>=r.startRow&&l.endRow<=r.endRow);if(a.length){let l=r.startRow;a.forEach(u=>{u.startRow>l&&(o.push({startRow:l,endRow:u.startRow-1,startColumn:0,endColumn:t}),l=u.endRow+1)}),l<=r.endRow&&o.push({startRow:l,endRow:r.endRow,startColumn:0,endColumn:t})}else o.push(r)}),o}function cr(s){return Za(s).map(t=>{const n=t.startRow===0?t.endRow+1:t.startRow-1;return{...t,startRow:n,endRow:n}})}function Za(s){const e=[];let t;return s.sort((n,o)=>n.startRow-o.startRow).forEach(n=>{if(!t){t=n;return}n.startRow===t.endRow+1?t.endRow=n.endRow:(e.push(t),t=n)}),e.push(t),e}const Q={type:i.CommandType.COMMAND,id:"sheet.command.set-style",handler:(s,e)=>{var y;const t=s.get(i.IUniverInstanceService),n=T(t,e);if(!n)return!1;const{unitId:o,subUnitId:r,worksheet:a}=n,{range:l,style:u}=e,d=s.get(i.ICommandService),c=s.get(i.IUndoRedoService),m=s.get(g.SheetsSelectionsService),h=l?[l]:(y=m.getCurrentSelections())==null?void 0:y.map(b=>b.range);if(!(h!=null&&h.length))return!1;const R=new i.ObjectMatrix,S=wa(a);if(i.Tools.isArray(u.value))for(let b=0;b<h.length;b++)S.forOperableEach(h[b],(k,U,P)=>{R.setValue(k,U,{s:{[u.type]:u.value[k-P.startRow][U-P.startColumn]}})});else for(let b=0;b<h.length;b++){const k={s:{[u.type]:u.value}};S.forOperableEach(h[b],(U,P)=>R.setValue(U,P,k))}const C={subUnitId:r,unitId:o,cellValue:R.getMatrix()},I=ie(s,C),v=d.syncExecuteCommand(B.id,C),{undos:w,redos:p}=s.get(g.SheetInterceptorService).onCommandExecute({id:Q.id,params:e}),M=i.sequenceExecute([...p],d);return v&&M.result?(c.pushUndoRedo({unitID:C.unitId,undoMutations:[{id:B.id,params:I},...w],redoMutations:[{id:B.id,params:C},...p]}),!0):!1}},xa={type:i.CommandType.COMMAND,id:"sheet.command.set-bold",handler:s=>{const e=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=T(s.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t,{actualRow:o,actualColumn:r}=e.primary,l={style:{type:"bl",value:n.getRange(o,r).getFontWeight()===i.FontWeight.BOLD?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return s.get(i.ICommandService).syncExecuteCommand(Q.id,l)}},Qa={type:i.CommandType.COMMAND,id:"sheet.command.set-italic",handler:s=>{const e=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=T(s.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let o=!0;if(e.primary){const{startRow:a,startColumn:l}=e.primary;o=n.getRange(a,l).getFontStyle()===i.FontItalic.ITALIC}const r={style:{type:"it",value:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return s.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},el={type:i.CommandType.COMMAND,id:"sheet.command.set-underline",handler:s=>{const e=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=T(s.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let o=!0;e.primary&&(o=!!n.getRange(e.primary.startRow,e.primary.startColumn).getUnderline().s);const r={style:{type:"ul",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},tl={type:i.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:s=>{const e=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=T(s.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let o=!0;e.primary&&(o=!!n.getRange(e.primary.actualRow,e.primary.actualColumn).getStrikeThrough().s);const r={style:{type:"st",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},nl={type:i.CommandType.COMMAND,id:"sheet.command.set-overline",handler:s=>{const e=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=T(s.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let o=!0;e.primary&&(o=!!n.getRange(e.primary.startRow,e.primary.startColumn).getOverline().s);const r={style:{type:"ol",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},sl={type:i.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={style:{type:"ff",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},ol={type:i.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={style:{type:"fs",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},mr={type:i.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={style:{type:"cl",value:{rgb:e.value}}};return t.syncExecuteCommand(Q.id,n)}},hr={type:i.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:s=>{const e=s.get(i.ICommandService),t={style:{type:"cl",value:{rgb:null}}};return e.syncExecuteCommand(Q.id,t)}},gr={type:i.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:(s,e)=>{if(!e||!e.value)return!1;const t=s.get(i.ICommandService),n={style:{type:"bg",value:{rgb:e.value}}};return t.syncExecuteCommand(Q.id,n)}},Rr={type:i.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:s=>{const e=s.get(i.ICommandService),t={style:{type:"bg",value:{rgb:null}}};return e.syncExecuteCommand(Q.id,t)}},Sr={type:i.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"vt",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},Cr={type:i.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"ht",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},fr={type:i.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:(s,e)=>{if(!e)return!1;const t=s.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"tb",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},Ir={type:i.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:(s,e)=>{if(!e)return!1;const t=typeof e.value=="number"?{a:e.value}:{a:0,v:i.BooleanNumber.TRUE},n=s.get(i.ICommandService),o={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"tr",value:t}};return n.syncExecuteCommand(Q.id,o)}},rl=(s,e)=>{const r=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId).getSheetBySheetId(e.subUnitId).getConfig().tabColor;return{...i.Tools.deepClone(e),color:r}},Bt={id:"sheet.mutation.set-tab-color",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().tabColor=e.color,!0):!1}},vr={type:i.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=T(s.get(i.IUniverInstanceService));if(!o)return!1;const{unitId:r,subUnitId:a}=o,l={color:e.value,unitId:r,subUnitId:a},u=rl(s,l);return t.syncExecuteCommand(Bt.id,l)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:Bt.id,params:u}],redoMutations:[{id:Bt.id,params:l}]}),!0):!1}},bs={id:"sheet.mutation.set-workbook-name",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUnit(e.unitId,i.UniverInstanceType.UNIVER_SHEET);return t?(t.setName(e.name),!0):!1}},Es={type:i.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:async(s,e)=>{var d;if(!s.get(i.IUniverInstanceService).getUnit(e.unitId,i.UniverInstanceType.UNIVER_SHEET))return!1;const r=s.get(g.SheetInterceptorService).onCommandExecute({id:Es.id,params:e}),a={name:e.name,unitId:e.unitId},l=[...(d=r.preRedos)!=null?d:[],{id:bs.id,params:a},...r.redos],u=s.get(i.ICommandService);return i.sequenceExecute(l,u).result}},Ct={id:"sheet.operation.set-worksheet-active",type:i.CommandType.OPERATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getWorksheets();for(const[,o]of n)if(o.getSheetId()===e.subUnitId)return t.setActiveSheet(o),!0;return!1}},il=4,Ts={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:(s,e,t)=>{const n=s.get(i.ICommandService),o=T(s.get(i.IUniverInstanceService),e);if(!o)return!1;const{unitId:r,subUnitId:a}=o;return new Promise(l=>{setTimeout(()=>{const u=n.syncExecuteCommand(Ct.id,{unitId:r,subUnitId:a},t);l(u)},il)})}},Us=(s,e)=>{const{unitId:t,subUnitId:n,ranges:o}=s,r={},a=e.getColumnManager();for(let l=0;l<o.length;l++){const u=o[l];for(let d=u.startColumn;d<u.endColumn+1;d++){const c=a.getColumnOrCreate(d);r[d]=c.w}}return{unitId:t,subUnitId:n,ranges:o,colWidth:r}},Ae={id:"sheet.mutation.set-worksheet-col-width",type:i.CommandType.MUTATION,handler:(s,e)=>{var u;const t=s.get(i.IUniverInstanceService),n=T(t,e);if(!n)return!1;const{worksheet:o}=n,r=o.getConfig().defaultColumnWidth,a=o.getColumnManager(),l=e.ranges;for(let d=0;d<l.length;d++){const c=l[d];for(let m=c.startColumn;m<c.endColumn+1;m++){if(!o.getColVisible(m))continue;const R=a.getColumnOrCreate(m);typeof e.colWidth=="number"?R.w=e.colWidth:R.w=(u=e.colWidth[m])!=null?u:r}}return!0}},hn={type:i.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:async(s,e)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();if(!(n!=null&&n.length))return!1;const o=s.get(i.ICommandService),r=s.get(i.IUndoRedoService),a=T(s.get(i.IUniverInstanceService));if(!a)return!1;const{worksheet:l,unitId:u,subUnitId:d}=a,{anchorCol:c,deltaX:m}=e,R=l.getColumnWidth(c)+m,S=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,C=n.filter(k=>k.range.rangeType===i.RANGE_TYPE.COLUMN),I=S?i.RANGE_TYPE.ALL:C.some(({range:k})=>{const{startColumn:U,endColumn:P}=k;return U<=c&&c<=P})?i.RANGE_TYPE.COLUMN:i.RANGE_TYPE.NORMAL;let v;if(I===i.RANGE_TYPE.ALL){const k=l.getRowCount(),U=new Array(l.getColumnCount()).fill(void 0).map((P,E)=>({startRow:0,endRow:k-1,startColumn:E,endColumn:E}));v={subUnitId:d,unitId:u,colWidth:R,ranges:U}}else I===i.RANGE_TYPE.COLUMN?v={subUnitId:d,unitId:u,ranges:C.map(k=>i.Rectangle.clone(k.range)),colWidth:R}:v={subUnitId:d,unitId:u,colWidth:R,ranges:[{startRow:0,endRow:l.getMaxRows()-1,startColumn:c,endColumn:c}]};const{undos:w,redos:p}=s.get(g.SheetInterceptorService).onCommandExecute({id:hn.id,params:v}),M=Us(v,l),y=o.syncExecuteCommand(Ae.id,v),b=i.sequenceExecute([...p],o);return y&&b.result&&r.pushUndoRedo({unitID:u,undoMutations:[{id:Ae.id,params:M},...w],redoMutations:[{id:Ae.id,params:v},...p]}),!0}},Ht={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:(s,e)=>{var w,p,M,y;const t=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(g.SheetInterceptorService),a=(w=e==null?void 0:e.ranges)!=null&&w.length?e.ranges:(p=t.getCurrentSelections())==null?void 0:p.map(b=>b.range);if(!(a!=null&&a.length))return!1;const l=T(s.get(i.IUniverInstanceService),e);if(!l)return!1;const{subUnitId:u,unitId:d,worksheet:c}=l,m={subUnitId:u,unitId:d,ranges:a,colWidth:e.value},h=Us(m,c),R=n.syncExecuteCommand(Ae.id,m),{undos:S,redos:C}=s.get(g.SheetInterceptorService).onCommandExecute({id:Ht.id,params:m}),I=r.onCommandExecute({id:Ht.id,params:m}),v=i.sequenceExecute([...C,...I.redos],n);return R&&v.result?(o.pushUndoRedo({unitID:d,undoMutations:[...(M=I.preUndos)!=null?M:[],{id:Ae.id,params:h},...S],redoMutations:[...(y=I.preRedos)!=null?y:[],{id:Ae.id,params:m},...C]}),!0):!1}};i.CommandType.COMMAND;const pr=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetColumnCountUndoMutationFactory]: worksheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,columnCount:t.worksheet.getColumnCount()}},ft={id:"sheet.mutation.set-worksheet-column-count",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService),n=Se(t,e);return n?(n.worksheet.setColumnCount(e.columnCount),!0):!1}},wr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-column-count",handler:(s,e)=>{const{unitId:t,subUnitId:n,columnCount:o}=e,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),l=s.get(i.IUniverInstanceService);if(!T(l,e))return!1;const d={unitId:t,subUnitId:n,columnCount:o},c=pr(s,d);return r.syncExecuteCommand(ft.id,d)?(a.pushUndoRedo({unitID:t,undoMutations:[{id:ft.id,params:c}],redoMutations:[{id:ft.id,params:d}]}),!0):!1}},It={id:"sheet.mutation.set-worksheet-default-style",type:i.CommandType.MUTATION,handler:(s,e)=>{const{defaultStyle:t}=e,n=s.get(i.IUniverInstanceService),o=T(n);if(!o)return!1;const{worksheet:r}=o;return r?(r.setDefaultCellStyle(t),!0):!1}},Mr=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),defaultStyle:n.getDefaultCellStyle()}},yr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=e,r=Mr(s,e);return t.syncExecuteCommand(It.id,e)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:It.id,params:r}],redoMutations:[{id:It.id,params:e}]}),!0):!1}},_r=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{hidden:n.isSheetHidden(),unitId:e.unitId,subUnitId:n.getSheetId()}},Be={id:"sheet.mutation.set-worksheet-hidden",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(t==null)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().hidden=e.hidden,!0):!1}},br={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.ErrorService),r=s.get(i.LocaleService),a=T(s.get(i.IUniverInstanceService),e);if(!a)return!1;const{workbook:l,worksheet:u,unitId:d,subUnitId:c}=a;if(u.getConfig().hidden===i.BooleanNumber.TRUE)return!1;const h={unitId:d,subUnitId:c,hidden:i.BooleanNumber.TRUE},R=_r(s,h);return l.getSheets().filter(v=>v.getConfig().hidden===i.BooleanNumber.FALSE).length===1?(o.emit(r.t("sheets.info.hideSheet")),!1):t.syncExecuteCommand(Be.id,h)?(n.pushUndoRedo({unitID:d,undoMutations:[{id:Be.id,params:R}],redoMutations:[{id:Be.id,params:h}]}),!0):!1}},al=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,name:n.getName(),subUnitId:n.getSheetId()}},jt={id:"sheet.mutation.set-worksheet-name",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(t==null)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().name=e.name,!0):!1}},gn={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:(s,e)=>{var S,C;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService),r=T(s.get(i.IUniverInstanceService),e);if(!r)return!1;const{unitId:a,subUnitId:l}=r,u={subUnitId:l,name:e.name,unitId:a},d=al(s,u),c=o.onCommandExecute({id:gn.id,params:e}),m=[...(S=c.preRedos)!=null?S:[],{id:jt.id,params:u},...c.redos],h=[...(C=c.preUndos)!=null?C:[],{id:jt.id,params:d},...c.undos];return i.sequenceExecute(m,t).result?(n.pushUndoRedo({unitID:a,undoMutations:h,redoMutations:m}),!0):!1}},ll=(s,e)=>({...i.Tools.deepClone(e),toOrder:e.fromOrder,fromOrder:e.toOrder}),Ft={id:"sheet.mutation.set-worksheet-order",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getConfig();return n.sheetOrder.splice(e.fromOrder,1),n.sheetOrder.splice(e.toOrder,0,e.subUnitId),!0}},Ps={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=T(s.get(i.IUniverInstanceService),e);if(!o)return!1;const{workbook:r,unitId:a,subUnitId:l}=o,d={fromOrder:r.getConfig().sheetOrder.indexOf(l),toOrder:e.order,unitId:a,subUnitId:l},c=ll(s,d);return t.syncExecuteCommand(Ft.id,d)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Ft.id,params:c}],redoMutations:[{id:Ft.id,params:d}]}),!0):!1}};class vt{constructor(){f(this,"_model",new Map);f(this,"_pointChange",new A.Subject);f(this,"pointChange$",this._pointChange.asObservable())}addRule(e){this._ensureSubUnitMap(e.unitId).set(e.subUnitId,e),this._pointChange.next(e)}deleteRule(e,t){var o,r,a;const n=(o=this._model.get(e))==null?void 0:o.get(t);n&&((a=(r=this._model)==null?void 0:r.get(e))==null||a.delete(t),this._pointChange.next(n))}getRule(e,t){var n,o;return(o=(n=this._model)==null?void 0:n.get(e))==null?void 0:o.get(t)}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n);o!=null&&o.size&&(e[n]=[],[...o.keys()].forEach(a=>{const l=o.get(a);l&&e[n].push(l)}))}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const o=e[n];if(o!=null&&o.length){const r=new Map;o.forEach(a=>{r.set(a.subUnitId,a)}),t.set(n,r)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=new Map,this._model.set(e,t)),t}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[o,r]of n)if(r.permissionId===t)return[e,o]}}class ks{constructor(e,t,n){f(this,"type",N.SelectRange);f(this,"subType",_.Delete);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${_.Delete}.${n}`}}class Os{constructor(e,t,n){f(this,"type",N.SelectRange);f(this,"subType",_.ManageCollaborator);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${_.ManageCollaborator}.${n}`}}const se=()=>[sn,ce,Os,ks],He=[_.Edit,_.View,_.ManageCollaborator,_.Delete],ul=(s="unitId",e="subUnitId",t="permissionId")=>se().reduce((n,o)=>{const r=new o(s,e,t);return n[r.subType]=r.value,n},{}),pt=()=>[ae,zn,Ln,Kn,$n,Gn,rn,Hn,jn,ln,on,Fn,Yn,an,yo,Jn,qn,Bn],Er=[_.Edit,_.Print,_.Comment,_.View,_.Copy,_.Export,_.ManageCollaborator,_.CreateSheet,_.DeleteSheet,_.RenameSheet,_.HideSheet,_.Duplicate,_.Share,_.MoveSheet,_.CopySheet,_.RecoverHistory,_.ViewHistory,_.CreatePermissionObject],oe=()=>[me,kt,rs,xn],ge=()=>[Xn,Zn,Qn,es,ts,ns,os,ss,is,as,Pt,ot,rt,ls],Rn=[_.Copy,_.DeleteColumn,_.DeleteRow,_.EditExtraObject,_.Filter,_.InsertColumn,_.InsertRow,_.InsertHyperlink,_.PivotTable,_.SetCellStyle,_.SetCellValue,_.SetColumnStyle,_.SetRowStyle,_.Sort];var dl=Object.getOwnPropertyDescriptor,cl=(s,e,t,n)=>{for(var o=n>1?void 0:n?dl(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},je=(s,e)=>(t,n)=>e(t,n,s);const ml="SHEET_WORKSHEET_PROTECTION_PLUGIN",hl="SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN";g.WorksheetPermissionService=class extends i.RxDisposable{constructor(e,t,n,o,r,a,l,u){super(),this._permissionService=e,this._univerInstanceService=t,this._injector=n,this._worksheetProtectionRuleModel=o,this._worksheetProtectionPointRuleModel=r,this._resourceManagerService=a,this._rangeProtectionRuleModel=l,this._logService=u,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){const e=t=>{const n=t.getUnitId(),o=r=>{const a=r.getSheetId();[...oe(),...ge()].forEach(l=>{const u=new l(n,a);this._permissionService.addPermissionPoint(u)}),this._logService.debug("[WorksheetPermissionService]","Initialization completed",n,a)};t.getSheets().forEach(r=>{o(r)}),t.sheetCreated$.subscribe(r=>{o(r)}),t.sheetDisposed$.subscribe(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(n,a).forEach(u=>{[...se()].forEach(d=>{const c=new d(n,a,u.permissionId);this._permissionService.deletePermissionPoint(c.id)})}),[...oe(),...ge()].forEach(u=>{const d=new u(n,a);this._permissionService.deletePermissionPoint(d.id)})})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).pipe(bt.takeUntil(this.dispose$)).subscribe(e),this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(bt.takeUntil(this.dispose$)).subscribe(t=>{t.getSheets().forEach(n=>{const o=t.getUnitId(),r=n.getSheetId();oe().forEach(a=>{const l=new a(o,r);this._permissionService.deletePermissionPoint(l.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":break;case"delete":{oe().forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break}case"set":{oe().forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,e.rule)});break}}}))}_initRuleSnapshot(){const e=()=>{const n=this._worksheetProtectionRuleModel.toObject();return JSON.stringify(n)},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:ml,businesses:[nn.UNIVER_SHEET],onLoad:(n,o)=>{this._worksheetProtectionRuleModel.fromObject(o),Object.keys(o).forEach(r=>{oe().forEach(a=>{const l=new a(n,r);l.value=!1,this._permissionService.addPermissionPoint(l)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},onUnLoad:n=>{const o=this._univerInstanceService.getUnit(n);o&&(o.getSheets().forEach(r=>{const a=r.getSheetId();[...oe(),...ge()].forEach(l=>{const u=new l(n,a);this._permissionService.deletePermissionPoint(u.id)})}),pt().forEach(r=>{const a=new r(n);this._permissionService.deletePermissionPoint(a.id)})),this._worksheetProtectionRuleModel.deleteUnitModel(n)}}))}_initPointSnapshot(){const e=()=>{const n=this._worksheetProtectionPointRuleModel.toObject();return JSON.stringify(n)},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:hl,businesses:[nn.UNIVER_SHEET],onLoad:(n,o)=>{this._worksheetProtectionPointRuleModel.fromObject(o),Object.keys(o).forEach(r=>{ge().forEach(a=>{const l=new a(n,r);this._permissionService.addPermissionPoint(l)})})},onUnLoad:n=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(n)}}))}},g.WorksheetPermissionService=cl([je(0,i.Inject(i.IPermissionService)),je(1,i.Inject(i.IUniverInstanceService)),je(2,i.Inject(i.Injector)),je(3,i.Inject(we)),je(4,i.Inject(vt)),je(5,i.Inject(i.IResourceManagerService)),je(6,i.Inject(J)),je(7,i.Inject(i.ILogService))],g.WorksheetPermissionService);const Sn={id:"sheet.mutation.set-worksheet-permission-points",type:i.CommandType.MUTATION,handler:(s,e)=>{const{rule:t}=e;return s.get(vt).addRule(t),!0}},Tr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),{rule:n}=e;return t.executeCommand(Sn.id,{rule:n,unitId:n.unitId,subUnitId:n.subUnitId}),!0}},Ur={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-protection",async handler(s,e){if(!e)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,permissionId:r,oldRule:a}=e,{unitId:l,subUnitId:u}=o,d={...o,permissionId:r};if(await t.executeCommand(Xe.id,{unitId:l,subUnitId:u,newRule:d})){const m=[{id:Xe.id,params:{unitId:l,subUnitId:u,newRule:d}}],h=[{id:Xe.id,params:{unitId:l,subUnitId:u,rule:a}}];n.pushUndoRedo({unitID:l,redoMutations:m,undoMutations:h})}return!0}},Pr=(s,e)=>{const t=Se(s.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetRowCountUndoMutationFactory]: worksheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,rowCount:t.worksheet.getRowCount()}},wt={id:"sheet.mutation.set-worksheet-row-count",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService),n=Se(t,e);return n?(n.worksheet.setRowCount(e.rowCount),!0):!1}},kr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-row-count",handler:(s,e)=>{const{unitId:t,subUnitId:n,rowCount:o}=e,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),l=s.get(i.IUniverInstanceService);if(!T(l,e))return!1;const d={unitId:t,subUnitId:n,rowCount:o},c=Pr(s,d);return r.syncExecuteCommand(wt.id,d)?(a.pushUndoRedo({unitID:t,undoMutations:[{id:wt.id,params:c}],redoMutations:[{id:wt.id,params:d}]}),!0):!1}},gl=2e3,Or=(s,e)=>{const{unitId:t,subUnitId:n,ranges:o}=s,r={},a=e.getRowManager();for(const{startRow:l,endRow:u}of o)for(let d=l;d<u+1;d++){const c=a.getRowOrCreate(d);r[d]=c.h}return{unitId:t,subUnitId:n,ranges:o,rowHeight:r}},Ns=(s,e)=>{const{unitId:t,subUnitId:n,ranges:o}=s,r={},a=e.getRowManager();for(const{startRow:l,endRow:u}of o)for(let d=l;d<=u;d++){const c=a.getRowOrCreate(d);r[d]=c.ia}return{unitId:t,subUnitId:n,ranges:o,autoHeightInfo:r}},Rl=(s,e)=>{const{unitId:t,subUnitId:n,rowsAutoHeightInfo:o}=s,r=[],a=e.getRowManager();for(const l of o){const{row:u}=l,{ah:d}=a.getRowOrCreate(u);r.push({row:u,autoHeight:d})}return{unitId:t,subUnitId:n,rowsAutoHeightInfo:r}},We={id:"sheet.mutation.set-worksheet-row-height",type:i.CommandType.MUTATION,handler:(s,e)=>{var d;const{ranges:t,rowHeight:n}=e,o=s.get(i.IUniverInstanceService),r=T(o,e);if(!r)return!1;const{worksheet:a}=r,l=a.getRowManager(),u=a.getConfig().defaultRowHeight;for(const{startRow:c,endRow:m}of t)for(let h=c;h<=m;h++){const R=l.getRowOrCreate(h);typeof n=="number"?R.h=n:R.h=(d=n[h])!=null?d:u,R.h=Math.min(gl,R.h)}return!0}},Re={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:i.CommandType.MUTATION,handler:(s,e)=>{var l;const{ranges:t,autoHeightInfo:n}=e,o=s.get(i.IUniverInstanceService),r=T(o,e);if(!r)return!1;const a=r.worksheet.getRowManager();for(const{startRow:u,endRow:d}of t)for(let c=u;c<=d;c++){const m=a.getRowOrCreate(c);typeof n=="number"?m.ia=n:m.ia=(l=n[c])!=null?l:void 0}return!0}},Ds={id:"sheet.mutation.set-worksheet-row-auto-height",type:i.CommandType.MUTATION,handler:(s,e)=>{const{rowsAutoHeightInfo:t}=e,n=s.get(i.IUniverInstanceService),o=T(n,e);if(!o)return!1;const r=o.worksheet.getRowManager();for(const{row:a,autoHeight:l}of t){const u=r.getRowOrCreate(a);u.ah=l}return!0}},Cn={type:i.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:async(s,e)=>{var P,E;const n=s.get(g.SheetsSelectionsService).getCurrentSelections(),o=s.get(g.SheetInterceptorService);if(!(n!=null&&n.length))return!1;const r=T(s.get(i.IUniverInstanceService));if(!r)return!1;const{worksheet:a,subUnitId:l,unitId:u}=r,{anchorRow:d,deltaY:c}=e,h=a.getRowHeight(d)+c,R=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,S=n.filter(O=>O.range.rangeType===i.RANGE_TYPE.ROW),C=R?i.RANGE_TYPE.ALL:S.some(({range:O})=>{const{startRow:W,endRow:L}=O;return W<=d&&d<=L})?i.RANGE_TYPE.ROW:i.RANGE_TYPE.NORMAL;let I;if(C===i.RANGE_TYPE.ALL){const O=a.getColumnCount(),W=new Array(a.getRowCount()).fill(void 0).map((L,H)=>({startRow:H,endRow:H,startColumn:0,endColumn:O-1}));I={subUnitId:l,unitId:u,rowHeight:h,ranges:W}}else C===i.RANGE_TYPE.ROW?I={subUnitId:l,unitId:u,ranges:S.map(O=>i.Rectangle.clone(O.range)),rowHeight:h}:I={subUnitId:l,unitId:u,rowHeight:h,ranges:[{startRow:d,endRow:d,startColumn:0,endColumn:a.getMaxColumns()-1}]};const v=Or(I,a),w={unitId:u,subUnitId:l,ranges:I.ranges,autoHeightInfo:i.BooleanNumber.FALSE},p=Ns(w,a),M=s.get(i.ICommandService),y=s.get(i.IUndoRedoService),b=o.onCommandExecute({id:Cn.id,params:I}),k=i.sequenceExecute([{id:We.id,params:I},{id:Re.id,params:w}],M),U=i.sequenceExecute([...b.redos],M);return k.result&&U.result?(y.pushUndoRedo({unitID:u,undoMutations:[...(P=b.preUndos)!=null?P:[],{id:We.id,params:v},{id:Re.id,params:p},...b.undos],redoMutations:[...(E=b.preRedos)!=null?E:[],{id:We.id,params:I},{id:Re.id,params:w},...b.redos]}),!0):!1}},fn={type:i.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:(s,e)=>{var p,M,y,b;const t=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=s.get(g.SheetInterceptorService),l=(p=e==null?void 0:e.ranges)!=null&&p.length?e.ranges:(M=t.getCurrentSelections())==null?void 0:M.map(k=>k.range);if(!(l!=null&&l.length))return!1;const u=T(r,e);if(!u)return!1;const{unitId:d,subUnitId:c,worksheet:m}=u,h={subUnitId:c,unitId:d,ranges:l,rowHeight:e.value},R=Or(h,m),S={unitId:d,subUnitId:c,ranges:h.ranges,autoHeightInfo:i.BooleanNumber.FALSE},C=Ns(S,m),I=i.sequenceExecute([{id:We.id,params:h},{id:Re.id,params:S}],n),v=a.onCommandExecute({id:fn.id,params:h}),w=i.sequenceExecute([...v.redos],n);return I.result&&w.result?(o.pushUndoRedo({unitID:d,undoMutations:[...(y=v.preRedos)!=null?y:[],{id:We.id,params:R},{id:Re.id,params:C},...v.undos],redoMutations:[...(b=v.preRedos)!=null?b:[],{id:We.id,params:h},{id:Re.id,params:S},...v.redos]}),!0):!1}},In={type:i.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:(s,e)=>{var v,w;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUniverInstanceService),a=T(r,e);if(!a)return!1;const{unitId:l,subUnitId:u,worksheet:d}=a,c=(v=e==null?void 0:e.ranges)!=null&&v.length?e.ranges:(w=o.getCurrentSelections())==null?void 0:w.map(p=>p.range);if(!(c!=null&&c.length))return!1;const m={unitId:l,subUnitId:u,ranges:c,autoHeightInfo:i.BooleanNumber.TRUE},h=Ns(m,d),R=t.syncExecuteCommand(Re.id,m),{undos:S,redos:C}=s.get(g.SheetInterceptorService).onCommandExecute({id:In.id,params:m}),I=i.sequenceExecute([...C],t);return R&&I.result?(n.pushUndoRedo({unitID:l,undoMutations:[{id:Re.id,params:h},...S],redoMutations:[{id:Re.id,params:m},...C]}),!0):!1}},As={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:(s,e)=>{const{unitId:t,subUnitId:n}=e,o=s.get(i.ICommandService),r=s.get(i.IUndoRedoService),a=s.get(i.IUniverInstanceService);if(!T(s.get(i.IUniverInstanceService)))return!1;const u=a.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!u)return!1;const d=u.getSheetBySheetId(n);if(!d||d.getConfig().hidden===i.BooleanNumber.FALSE)return!1;const m={unitId:t,subUnitId:n,hidden:i.BooleanNumber.FALSE},h=_r(s,m),R=o.syncExecuteCommand(Be.id,m),S={unitId:t,subUnitId:n},C=o.syncExecuteCommand(Ct.id,S);return R&&C?(r.pushUndoRedo({unitID:t,undoMutations:[{id:Be.id,params:h}],redoMutations:[{id:Be.id,params:m}]}),!0):!1}};var Nr=(s=>(s[s.Tab=1]="Tab",s[s.Comma=2]="Comma",s[s.Semicolon=4]="Semicolon",s[s.Space=8]="Space",s[s.Custom=16]="Custom",s))(Nr||{});class Sl{constructor(){f(this,"_tabCount",0);f(this,"_commaCount",0);f(this,"_semicolonCount",0);f(this,"_spaceCount",0)}add(e){switch(e){case"	":this._tabCount++;break;case",":this._commaCount++;break;case";":this._semicolonCount++;break;case" ":this._spaceCount++;break}}update(e){e&&typeof e=="string"&&(e.includes("	")&&this._tabCount++,e.includes(",")&&this._commaCount++,e.includes(";")&&this._semicolonCount++,e.trim().includes(" ")&&this._spaceCount++)}getDelimiter(){const e=Math.max(this._tabCount,this._commaCount,this._semicolonCount,this._spaceCount);return e===0||e===this._tabCount?1:e===this._commaCount?2:e===this._semicolonCount?4:e===this._spaceCount?8:1}}function Cl(s,e,t){const n=[];t!==void 0&&(s&16)>0&&n.push(t),(s&1)>0&&n.push("	"),(s&2)>0&&n.push(","),(s&4)>0&&n.push(";"),(s&8)>0&&n.push(" ");let o="";for(const a of n)o+=fl(a);let r="[".concat(o,"]");return e&&(r+="+"),new RegExp(r)}function fl(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const Il=s=>{var t;return((t=s.body)==null?void 0:t.dataStream.replace(/\r\n$/,""))||""};function vl(s){if(s!=null){if(s.p)return Il(s.p);if(s.v&&typeof s.v=="string")return s.v;if(s.t&&(s.t===i.CellValueType.FORCE_STRING||s.t===i.CellValueType.STRING))return String(s.v)}}function Dr(s,e,t,n,o=!1){const r=i.Range.transformRange(e,s),{startColumn:a,startRow:l,endColumn:u,endRow:d}=r;if(a!==u)throw new Error("The range must be in the same column.");if(t&&(t&16)>0&&(n===void 0||n.length!==1))throw new Error("The custom delimiter must a character.");const c=t===void 0,m=c?new Sl:null,h=[];for(let p=l;p<=d;p++){const M=s.getCell(p,a),y=vl(M);h.push(y),m&&m.update(y)}const R=c?m.getDelimiter():t,S=Cl(R,o,n);let C=-1,I=0,v=0;const w=[];for(const p of h){if(p!==void 0){const M=String(p).split(S);C<0?C=M.length:C=Math.max(C,M.length),w.push(M),I=v}else w.push(void 0);v++}return{rs:w,maxLength:C===-1?0:C,lastRow:I}}const Ar={type:i.CommandType.COMMAND,id:"sheet.command.split-text-to-columns",handler:(s,e)=>{const{unitId:t,subUnitId:n,range:o,delimiter:r,customDelimiter:a,treatMultipleDelimitersAsOne:l}=e,u=s.get(i.ICommandService),d=s.get(i.IUniverInstanceService),c=s.get(i.IUndoRedoService);if(!T(s.get(i.IUniverInstanceService)))return!1;const h=d.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!h)return!1;const R=h.getSheetBySheetId(n);if(!R)return!1;const{lastRow:S,rs:C,maxLength:I}=Dr(R,o,r,a,l),v=R.getColumnCount(),{startColumn:w}=i.Range.transformRange(o,R);if(o.startColumn!==o.endColumn)return!1;const p=[],M=[],y=w+I+1-v;if(y>0){const O={unitId:t,subUnitId:n,range:{startRow:0,endRow:R.getRowCount()-1,startColumn:v-1,endColumn:v-1+y}};p.push({id:de.id,params:O});const W=Et(s,O);M.push({id:re.id,params:W})}const b={startRow:o.startRow,endRow:S,startColumn:w,endColumn:w+I},k=new i.ObjectMatrix;for(let O=b.startRow;O<=b.endRow;O++)for(let W=b.startColumn;W<=b.endColumn;W++){const L=C[O-b.startRow];W===0&&(L==null?void 0:L.length)===1?k.setValue(O,W,R.getCell(O,W)):k.setValue(O,W,{v:(L==null?void 0:L[W-b.startColumn])||null,p:null,f:null,si:null,custom:null})}const U={unitId:t,subUnitId:n,cellValue:k.clone()},P=ie(s,U);return p.push({id:B.id,params:U}),M.unshift({id:B.id,params:P}),i.sequenceExecute(p,u).result?(c.pushUndoRedo({unitID:t,undoMutations:M,redoMutations:p}),!0):!1}},Wr={id:"sheet.command.toggle-cell-checkbox",type:i.CommandType.COMMAND,handler:(s,e)=>{if(!e)return!1;const{unitId:t,subUnitId:n,row:o,col:r,paragraphIndex:a}=e,u=s.get(i.IUniverInstanceService).getUnit(t,i.UniverInstanceType.UNIVER_SHEET),d=u==null?void 0:u.getSheetBySheetId(n),c=s.get(i.IUndoRedoService),m=s.get(i.ICommandService);if(!d)return!1;const h=d.getCell(o,r);if(!(h!=null&&h.p))return!1;const R=i.Tools.deepClone(h.p),S=new i.DocumentDataModel(R),C=i.BuildTextUtils.paragraph.bullet.toggleChecklist({document:S,paragraphIndex:a});if(!C)return!1;i.TextX.apply(S.getBody(),C.serialize());const I={unitId:t,subUnitId:n,cellValue:{[o]:{[r]:{p:R,t:i.CellValueType.STRING}}}},v={id:B.id,params:I},w=ie(s,I),p={id:B.id,params:w},M=[v],y=[p];return c.pushUndoRedo({redoMutations:M,undoMutations:y,unitID:t}),m.syncExecuteCommand(v.id,v.params)}},Mt={id:"sheet.mutation.toggle-gridlines",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=T(s.get(i.IUniverInstanceService),e);if(!t)return!1;const{worksheet:n}=t,o=n.getConfig();return o.showGridlines=e.showGridlines,!0}},Vr={type:i.CommandType.COMMAND,id:"sheet.command.toggle-gridlines",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=T(o);if(!r)return!1;const{worksheet:a}=r,l=a.getConfig().showGridlines;if(l===(e==null?void 0:e.showGridlines))return!1;const{unitId:u,subUnitId:d}=r,c={showGridlines:l===i.BooleanNumber.TRUE?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE,unitId:u,subUnitId:d},m={showGridlines:l,unitId:u,subUnitId:d};return t.syncExecuteCommand(Mt.id,c)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:Mt.id,params:m}],redoMutations:[{id:Mt.id,params:c}]}),!0):!1}},Lr={id:"sheet.command.unregister-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(s,e)=>{var h;if(!e)return!1;const{unitId:t,themeName:n}=e,o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),l=s.get(g.SheetRangeThemeModel);if(!T(o))return!1;const d={unitId:t,themeName:n},c={unitId:t,themeName:n,rangeThemeStyleJson:(h=l.getRangeThemeStyle(t,n))==null?void 0:h.toJson()};return r.syncExecuteCommand(lt.id,e)&&a.pushUndoRedo({unitID:t,undoMutations:[{id:lt.id,params:c}],redoMutations:[{id:un.id,params:d}]}),!0}},$r={id:"sheet.mutation.empty",type:i.CommandType.MUTATION,handler:()=>!0},Br=s=>{const e=new i.ObjectMatrix;return s.forEach(t=>{i.Range.foreach(t,(n,o)=>{e.setValue(n,o,1)})}),e.forValue((t,n)=>{const o=e.getValue(t-1,n);o&&e.setValue(t,n,o+1)}),e},Hr=s=>{const e=s;return e.forValue((t,n)=>{const o=s.getValue(t-1,n);o&&e.setValue(t,n,o+1)}),e},jr=s=>{const e={area:0},t=(n,o)=>e.area<n?(e.area=n,e.range=o,!0):!1;return s.forValue((n,o,r)=>{let a=1,l=r;t(a*l,{startRow:n-l+1,endRow:n,startColumn:o,endColumn:o});const u={startRow:n-l+1,endRow:n,startColumn:0,endColumn:o};for(let d=o-1;d>=0&&s.getValue(n,d);d--){l=Math.min(s.getValue(n,d)||0,l),a++;const c=l*a;u.startColumn=d,u.startRow=n-l+1,t(c,u)}}),e},pl=(s,e)=>{i.Range.foreach(e,(t,n)=>{s.realDeleteValue(t,n)});for(let t=e.startColumn;t<=e.endColumn;t++){const n=e.endRow+1;if(s.getValue(n,t)>0){s.setValue(n,t,1);let r=n+1;for(;s.getValue(r,t)>0;)s.setValue(r,t,s.getValue(r-1,t)+1),r++}}return s},Ws=s=>{const e=[];let t=jr(s);for(;t.area>0;)t.range&&(e.push(t.range),pl(s,t.range)),t=jr(s);return e},Vs=s=>{const e=Br(s);return Ws(e)};class wl{constructor(){f(this,"_matrix",new i.ObjectMatrix)}add(...e){return e.forEach(t=>{i.Range.foreach(t,(n,o)=>{this._matrix.setValue(n,o,1)})}),this}subtract(...e){return e.forEach(t=>{i.Range.foreach(t,(n,o)=>{this._matrix.realDeleteValue(n,o)})}),this}merge(){const e=Hr(this._matrix);return Ws(e)}}const Ze=i.createIdentifier("INumfmtService"),Ml=(s,e)=>{const t=s.get(Ze),{values:n,unitId:o,subUnitId:r}=e,a=[],l=[];Object.keys(n).forEach(d=>{n[d].ranges.forEach(m=>{i.Range.foreach(m,(h,R)=>{const S=t.getValue(o,r,h,R);S?a.push({pattern:S.pattern,row:h,col:R}):l.push({startColumn:R,endColumn:R,startRow:h,endRow:h})})})});const u=[];if(a.length){const d=pn(o,r,a);Object.keys(d.values).forEach(c=>{const m=d.values[c];m.ranges=Vs(m.ranges)}),u.push({id:vn.id,params:pn(o,r,a)})}return l.length&&u.push({id:Ls.id,params:{unitId:o,subUnitId:r,ranges:l}}),u},vn={id:"sheet.mutation.set.numfmt",type:i.CommandType.MUTATION,handler:(s,e)=>{if(!e)return!1;const{values:t,refMap:n}=e,o=s.get(Ze),r=e.unitId,a=e.subUnitId,l=Object.keys(t).reduce((u,d)=>{const c=n[d],m=t[d].ranges;return c&&u.push({...c,ranges:m}),u},[]);return o.setValues(r,a,l),!0}},Ls={id:"sheet.mutation.remove.numfmt",type:i.CommandType.MUTATION,handler:(s,e)=>{if(!e)return!1;const{unitId:t,subUnitId:n,ranges:o}=e;return s.get(Ze).deleteValues(t,n,o),!0}},yl=(s,e)=>{const t=s.get(Ze),{ranges:n,unitId:o,subUnitId:r}=e,a=[];if(n.forEach(u=>{i.Range.foreach(u,(d,c)=>{const m=t.getValue(o,r,d,c);m&&a.push({pattern:m.pattern,row:d,col:c})})}),!a.length)return[];const l=pn(o,r,a);return Object.keys(l.values).forEach(u=>{const d=l.values[u];d.ranges=Vs(d.ranges)}),[{id:vn.id,params:l}]},pn=(s,e,t)=>{const n=da(t,"pattern"),o={},r={},a=ca();return Object.keys(n).forEach(l=>{const u=n[l],d=a();o[d]={pattern:l},u.forEach(c=>{r[d]||(r[d]={ranges:[]}),r[d].ranges.push(i.cellToRange(c.row,c.col))})}),{unitId:s,subUnitId:e,refMap:o,values:r}},Fr={id:"sheet.operation.scroll-to-cell",type:i.CommandType.OPERATION,handler:()=>!0},Gr="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY",zr="maxCellsPerSheet",_l=3e6,qr={id:"sheet.mutation.set-range-theme",type:i.CommandType.MUTATION,handler:(s,e)=>{if(!e)return!1;const{unitId:t,styleName:n,style:o}=e,a=s.get(g.SheetRangeThemeModel).getRangeThemeStyle(t,n);return a&&(o.headerRowStyle&&a.setHeaderRowStyle(o.headerRowStyle),o.firstRowStyle&&a.setFirstRowStyle(o.firstRowStyle),o.secondRowStyle&&a.setSecondRowStyle(o.secondRowStyle),o.lastRowStyle&&a.setLastRowStyle(o.lastRowStyle)),!0}},Yr={id:"sheet.mutation.remove-range-theme",type:i.CommandType.MUTATION,handler:(s,e)=>{if(!e)return!1;const{styleName:t,unitId:n}=e;return s.get(g.SheetRangeThemeModel).unregisterRangeThemeStyle(n,t),!0}},Kr={id:"sheet.mutation.add-range-theme",type:i.CommandType.MUTATION,handler:(s,e)=>{if(!e)return!1;const{styleJSON:t,unitId:n}=e,o=s.get(g.SheetRangeThemeModel),r=new ke(t.name);return r.fromJson(t),o.registerRangeThemeStyle(n,r),!0}};var bl=Object.getOwnPropertyDescriptor,El=(s,e,t,n)=>{for(var o=n>1?void 0:n?bl(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},$s=(s,e)=>(t,n)=>e(t,n,s);let wn=class extends i.Disposable{constructor(s,e,t){var o;super(),this._commandService=s,this._configService=e,this._dataSyncPrimaryController=t,[B,de,Ce,st,Le,Ne,De,re,fe,ze,G,Ls,F,bs,jt,vn,Vt,$r,St,Rt].forEach(r=>{var a;this._commandService.registerCommand(r),(a=this._dataSyncPrimaryController)==null||a.registerSyncingMutations(r)}),((o=this._configService.getConfig(Gr))!=null?o:!1)||[ho,xt,Qt,en,Vn,Ye,Ke,hn,Cn,$o,Lo,Bo,Ho,hs,_e,at,Ot,Do,No,Wo,Ao,ms,ye,jo,Dt,qe,Nt,Ss,Wt,fs,At,dn,cn,Jo,Rr,hr,gr,tr,er,ut,xo,Qo,ps,ct,mt,Ht,sr,dt,rr,$e,ir,Cr,it,fn,_s,dr,gt,vs,ys,Lt,$t,Q,vr,Bt,mr,Ir,fr,Sr,Es,Ts,Ct,br,Be,gn,Ps,Ft,Ds,We,In,Re,Ae,kr,wt,wr,ft,wo,q,Fr,ko,gs,ws,As,Vr,Mt,ar,ht,Tr,Ve,Xe,Ge,Sn,Zs,lr,To,xs,Uo,Ur,ue,pe,x,Wr,It,yr,Ar,nt,tt,un,lt,Lr,Ko,lo,Po,Kr,qr,Yr].forEach(r=>this.disposeWithMe(this._commandService.registerCommand(r))),this._configService.setConfig(zr,_l)}};wn=El([$s(0,i.ICommandService),$s(1,i.IConfigService),$s(2,i.Optional(Ti.DataSyncPrimaryController))],wn);var Tl=Object.getOwnPropertyDescriptor,Ul=(s,e,t,n)=>{for(var o=n>1?void 0:n?Tl(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Jr=(s,e)=>(t,n)=>e(t,n,s);let Mn=class extends i.Disposable{constructor(s,e){super(),this._univerInstanceService=s,this._commandService=e,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id!==z.SetFormulaCalculationResultMutation.id)return;const e=s.params,{unitData:t}=e,n=Object.keys(t),o=[];for(let a=0;a<n.length;a++){const l=n[a],u=t[l];if(u==null)continue;const d=Object.keys(u);for(let c=0;c<d.length;c++){const m=d[c],h=u[m];if(h==null)continue;const R=this._getMergedCellData(l,m,h),S={subUnitId:m,unitId:l,cellValue:R};o.push({id:B.id,params:S})}}return o.every(a=>this._commandService.executeCommand(a.id,a.params,{onlyLocal:!0}))}))}_getMergedCellData(s,e,t){const n=this._univerInstanceService.getUniverSheetInstance(s),o=n==null?void 0:n.getStyles(),r=n==null?void 0:n.getSheetBySheetId(e),a=r==null?void 0:r.getCellMatrix(),l=new i.ObjectMatrix(t);return l.forValue((u,d,c)=>{const m=a==null?void 0:a.getValue(u,d),h=z.handleNumfmtInCell(m,c,o);l.setValue(u,d,h)}),l.getMatrix()}};Mn=Ul([Jr(0,i.Inject(i.IUniverInstanceService)),Jr(1,i.ICommandService)],Mn);const Pl="sheets.config",Xr={};var kl=Object.getOwnPropertyDescriptor,Ol=(s,e,t,n)=>{for(var o=n>1?void 0:n?kl(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Zr=(s,e)=>(t,n)=>e(t,n,s);const Nl="SHEET_DEFINED_NAME_PLUGIN",Dl="AllDefaultWorkbook";g.DefinedNameDataController=class extends i.Disposable{constructor(e,t){super(),this._definedNamesService=e,this._resourceManagerService=t,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){const e=n=>{const o=this._definedNamesService.getDefinedNameMap(n);return o?JSON.stringify(o):""},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:Nl,businesses:[i.UniverInstanceType.UNIVER_SHEET],toJson:n=>e(n),parseJson:n=>t(n),onUnLoad:n=>{this._definedNamesService.removeUnitDefinedName(n)},onLoad:(n,o)=>{this._definedNamesService.registerDefinedNames(n,o)}}))}},g.DefinedNameDataController=Ol([Zr(0,z.IDefinedNamesService),Zr(1,i.IResourceManagerService)],g.DefinedNameDataController);const D={MoveRangeCommandId:Mo,InsertRowCommandId:Oo,InsertColCommandId:Vo,RemoveColCommandId:Cs,RemoveRowCommandId:Rs,DeleteRangeMoveLeftCommandId:bo,DeleteRangeMoveUpCommandId:Eo,InsertRangeMoveDownCommandId:ka,InsertRangeMoveRightCommandId:cs,MoveColsCommandId:qo,MoveRowsCommandId:zo,ReorderRangeCommandId:Zo};var V=(s=>(s[s.Set=0]="Set",s[s.Delete=1]="Delete",s[s.HorizontalMove=2]="HorizontalMove",s[s.VerticalMove=3]="VerticalMove",s[s.Unknown=4]="Unknown",s))(V||{});const yn=Number.MAX_SAFE_INTEGER,be=s=>{const e={...s},t=Number.isNaN(e.startRow)&&Number.isNaN(e.endRow)&&!Number.isNaN(e.startColumn)&&!Number.isNaN(e.endColumn),n=Number.isNaN(e.startColumn)&&Number.isNaN(e.endColumn)&&!Number.isNaN(e.startRow)&&!Number.isNaN(e.endRow);return(e.rangeType===i.RANGE_TYPE.COLUMN||t)&&(e.startRow=0,e.endRow=yn),(e.rangeType===i.RANGE_TYPE.ROW||n)&&(e.startColumn=0,e.endColumn=yn),e.rangeType===i.RANGE_TYPE.ALL&&(e.startColumn=0,e.endColumn=yn,e.startRow=0,e.endRow=yn),e},le=s=>{let e=s.rangeType;return s.rangeType===i.RANGE_TYPE.COLUMN?e=i.RANGE_TYPE.ROW:s.rangeType===i.RANGE_TYPE.ROW&&(e=i.RANGE_TYPE.COLUMN),{startRow:s.startColumn,endRow:s.endColumn,startColumn:s.startRow,endColumn:s.endRow,rangeType:e}},Gt=(s,e,t)=>{const n={...t},o={...e},r=(C,I)=>{const v=Math.max(C.start,I.start),w=Math.min(C.end,I.end);return w<v?null:{start:v,end:w}},a=C=>C.end-C.start+1,l=(C,I)=>({start:C.start-I.start,end:C.start-I.start+C.end-C.start}),u=(C,I)=>({start:I.start+C.start,end:I.start+C.start+C.end-C.start}),d=e.start>s.start;if(d){const C=Math.min(s.end,e.start)-s.start+1;o.start-=C,o.end-=C}const c=a(s),m=c,h=r(s,n),R=h&&a(h)>=a(n);if(s.end<n.start)n.start-=c,n.end-=c;else if(h){const C=a(h);if(R){const I=l(n,s),v=u(I,o);n.start=v.start,n.end=v.end}else h.start>s.start?d?(n.end-=C+c,n.start-=c):n.end-=C:d?n.end-=C:n.start>s.start&&n.end>s.end?(n.start-=c,n.end-=c+C):n.end-=C}const S=r(o,n);return R||(o.start<=n.start?(n.start+=m,n.end+=m):S&&(d?o.end<=n.start||o.start<=n.start&&o.end>=n.start?(n.start+=m,n.end+=m):o.start>=n.start&&o.start<=n.end&&(n.end+=m):n.start<o.start&&n.end>o.start?n.end+=m:(n.start>=o.end||n.start>=o.start&&n.start<=o.end)&&(n.end+=m,n.start+=m))),{step:n.start-t.start,length:a(n)-a(t)}},Bs=(s,e)=>{const{fromRange:t,toRange:n}=s.params||{};if(!n||!t)return[];const o=be(t),r=be(n),a=be(e),l=Gt({start:o.startRow,end:o.endRow},{start:r.startRow,end:r.endRow},{start:a.startRow,end:a.endRow});return l===null?[{type:V.Delete}]:[{type:V.VerticalMove,step:l.step||0,length:l.length||0}]},Al=(s,e)=>{const{fromRange:t,toRange:n}=s.params||{};if(!t||!n)return[e];const o=t.startRow,r=t.endRow-t.startRow+1,a=n.startRow,l=new i.ObjectMatrix;return i.Range.foreach(e,(d,c)=>{l.setValue(d,c,1)}),l.moveRows(o,r,a),i.queryObjectMatrix(l,d=>d===1)},Wl=(s,e)=>{const{range:t,order:n}=s.params||{};if(!t||!n)return[e];const o=new i.ObjectMatrix;i.Range.foreach(e,(l,u)=>{o.setValue(l,u,1)});const r=new i.ObjectMatrix;return i.Range.foreach(t,(l,u)=>{var d;if(Object.prototype.hasOwnProperty.call(n,l)){const c=n[l],m=(d=o.getValue(c,u))!=null?d:0;r.setValue(l,u,m)}}),r.forValue((l,u,d)=>{o.setValue(l,u,d)}),i.queryObjectMatrix(o,l=>l===1)},Hs=(s,e)=>{const{fromRange:t,toRange:n}=s.params||{};if(!n||!t)return[];const o=be(t),r=be(n),a=be(e),l=Gt({start:o.startColumn,end:o.endColumn},{start:r.startColumn,end:r.endColumn},{start:a.startColumn,end:a.endColumn});return l===null?[{type:V.Delete}]:[{type:V.HorizontalMove,step:l.step||0,length:l.length||0}]},Vl=(s,e)=>{const{fromRange:t,toRange:n}=s.params||{};if(!t||!n)return[e];const o=t.startColumn,r=t.endColumn-t.startColumn+1,a=n.startColumn,l=new i.ObjectMatrix;return i.Range.foreach(e,(u,d)=>{l.setValue(u,d,1)}),l.moveColumns(o,r,a),i.queryObjectMatrix(l,u=>u===1)},xr=(s,e)=>{var r,a;const t=(r=s.params)==null?void 0:r.toRange,n=(a=s.params)==null?void 0:a.fromRange;if(!t||!n)return[];const o=[];if(i.Rectangle.contains(t,e)&&o.push({type:V.Delete}),i.Rectangle.contains(n,e)){o.push({type:V.Delete});const l=i.Rectangle.getRelativeRange(e,n),u=i.Rectangle.getPositionRange(l,t);return[{type:V.Set,range:u}]}return o},Ll=(s,e)=>{var m,h;const t=(m=s.params)==null?void 0:m.toRange,n=(h=s.params)==null?void 0:h.fromRange;if(!t||!n)return[e];if(!i.Rectangle.intersects(n,e)&&!i.Rectangle.intersects(t,e))return[e];if(i.Rectangle.contains(n,e)){const R=i.Rectangle.getRelativeRange(e,n);return[i.Rectangle.getPositionRange(R,t)]}const o=new i.ObjectMatrix;i.Range.foreach(e,(R,S)=>{o.setValue(R,S,1)});const r=new i.ObjectMatrix,a=i.Rectangle.getIntersects(n,e);a&&i.Range.foreach(a,(R,S)=>{o.getValue(R,S)&&(o.setValue(R,S,void 0),r.setValue(R,S,1))});const l=t.startColumn-n.startColumn,u=t.startRow-n.startRow,d={startColumn:t.startColumn-l,endColumn:t.endColumn-l,startRow:t.startRow-u,endRow:t.endRow-u};return d&&i.Range.foreach(d,(R,S)=>{var v;const C=R+u,I=S+l;o.setValue(C,I,(v=r.getValue(R,S))!=null?v:0)}),i.queryObjectMatrix(o,R=>R===1)},xe=(s,e)=>{const t=be(s),n=be(e),o=a=>a.endColumn-a.startColumn+1,r=a=>a.endRow-a.startRow+1;if(t.startRow<=n.startRow&&t.endRow>=n.endRow){if(n.startColumn<t.startColumn&&n.endColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn<t.startColumn&&n.endColumn>=t.endColumn){const a=i.Rectangle.getIntersects(n,t);if(a)return{step:0,length:-o(a)}}if(n.startColumn>=t.startColumn&&n.endColumn<=t.endColumn&&r(t)>=r(n))return null;if(n.startColumn>=t.startColumn&&n.startColumn<=t.endColumn&&n.endColumn>t.endColumn){const a=i.Rectangle.getIntersects(n,t);if(a){const l=-o(a);return{step:-(o(t)-o(a)),length:l}}}if(n.startColumn>t.endColumn)return{step:-o(t),length:0}}return{step:0,length:0}},js=(s,e)=>{var r;const t=(r=s.params)==null?void 0:r.range;if(!t)return[];const n=[],o=xe(t,e);if(!o)n.push({type:V.Delete});else{const{step:a,length:l}=o;n.push({type:V.HorizontalMove,step:a,length:l})}return n},Qr=(s,e)=>{var r;const t=(r=s.params)==null?void 0:r.range;if(!t)return[];const n=[],o=xe(le(t),le(e));if(!o)n.push({type:V.Delete});else{const{step:a,length:l}=o;n.push({type:V.VerticalMove,step:a,length:l})}return n},$l=(s,e)=>{const{range:t,order:n}=s.params||{};if(!t||!n)return[];if(i.Rectangle.contains(t,e)&&e.endRow===e.startRow){const o=[],r=e.startRow;for(const a in n)if(n[a]===r){const l=Number(a);return o.push({type:V.VerticalMove,step:l-r,length:0}),o}return[]}return[]},Qe=(s,e)=>{const t=be(s),n=be(e),o=r=>r.endColumn-r.startColumn+1;return t.startRow<=n.startRow&&t.endRow>=n.endRow?n.startColumn<t.startColumn&&n.endColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn<t.startColumn&&n.endColumn>=t.endColumn?{step:0,length:o(t)}:n.startColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn>=t.startColumn&&n.startColumn<=t.endColumn&&n.endColumn>t.endColumn||n.startColumn>=t.endColumn?{step:o(t),length:0}:{step:0,length:0}:{step:0,length:0}};function Bl(s,e,t){const n=[];if(i.Rectangle.contains(e,t)&&n.push({type:V.Delete}),i.Rectangle.contains(s,t)){n.push({type:V.Delete});const o=i.Rectangle.getRelativeRange(t,s),r=i.Rectangle.getPositionRange(o,e);return[{type:V.Set,range:r}]}return n}const ei=(s,e)=>{var l;const t=(l=s.params)==null?void 0:l.range;if(!t)return[];const n=[],o=Qe(le(t),le(e)),{step:r,length:a}=o;return n.push({type:V.VerticalMove,step:r,length:a}),n},ti=(s,e)=>{var l;const t=(l=s.params)==null?void 0:l.range;if(!t)return[];const n=[],o=Qe(t,e),{step:r,length:a}=o;return n.push({type:V.HorizontalMove,step:r,length:a}),n},ni=(s,e)=>{var l;const t=(l=s.params)==null?void 0:l.range;if(!t)return[];const n=[],o=Qe(le(t),le(e)),{step:r,length:a}=o;return n.push({type:V.VerticalMove,step:r,length:a}),n},Hl=(s,e)=>{var u;const t=(u=s.params)==null?void 0:u.range;if(!t)return[e];const n=t.endRow-t.startRow+1,o={...t,startRow:t.startRow,endRow:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(e,o),a=i.Rectangle.getIntersects(o,e);if(!a)return[e];const l=new i.ObjectMatrix;return r.forEach(d=>{i.Range.foreach(d,(c,m)=>{l.setValue(c,m,1)})}),a&&i.Range.foreach(a,(d,c)=>{l.setValue(d+n,c,1)}),i.queryObjectMatrix(l,d=>d===1)},si=(s,e)=>{var l;const t=(l=s.params)==null?void 0:l.range;if(!t)return[];const n=[],o=Qe(t,e),{step:r,length:a}=o;return n.push({type:V.HorizontalMove,step:r,length:a}),n},jl=(s,e)=>{var u;const t=(u=s.params)==null?void 0:u.range;if(!t)return[e];const n=t.endColumn-t.startColumn+1,o={...t,startColumn:t.startColumn,endColumn:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(e,o),a=i.Rectangle.getIntersects(o,e);if(!a)return[e];const l=new i.ObjectMatrix;return r.forEach(d=>{i.Range.foreach(d,(c,m)=>{l.setValue(c,m,1)})}),a&&i.Range.foreach(a,(d,c)=>{l.setValue(d,c+n,1)}),i.queryObjectMatrix(l,d=>d===1)},oi=(s,e)=>{var r;const t=(r=s.params)==null?void 0:r.range;if(!t)return[];const n=[],o=xe(t,e);if(!o)n.push({type:V.Delete});else{const{step:a,length:l}=o;n.push({type:V.HorizontalMove,step:a,length:l})}return n},Fl=(s,e)=>{var d;const t=(d=s.params)==null?void 0:d.range;if(!t)return[e];const n={startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn,endColumn:Number.POSITIVE_INFINITY},o=t.endColumn-t.startColumn+1,r=i.Rectangle.getIntersects(t,e),a=i.Rectangle.subtract(e,n),l=i.Rectangle.getIntersects(n,e);if(!r&&!l)return[e];const u=new i.ObjectMatrix;return l&&i.Range.foreach(l,(c,m)=>{u.setValue(c,m-o,1)}),r&&i.Range.foreach(r,(c,m)=>{u.setValue(c,m-o,0)}),a.forEach(c=>{i.Range.foreach(c,(m,h)=>{u.setValue(m,h,1)})}),i.queryObjectMatrix(u,c=>c===1)},ri=(s,e)=>{var r;const t=(r=s.params)==null?void 0:r.range;if(!t)return[];const n=[],o=xe(le(t),le(e));if(!o)n.push({type:V.Delete});else{const{step:a,length:l}=o;n.push({type:V.VerticalMove,step:a,length:l})}return n},Gl=(s,e)=>{var d;const t=(d=s.params)==null?void 0:d.range;if(!t)return[e];const n={...t,startRow:t.startRow,endRow:Number.POSITIVE_INFINITY},o=t.endRow-t.startRow+1,r=i.Rectangle.getIntersects(t,e),a=i.Rectangle.subtract(e,n),l=i.Rectangle.getIntersects(n,e);if(!r&&!l)return[e];const u=new i.ObjectMatrix;return l&&i.Range.foreach(l,(c,m)=>{u.setValue(c-o,m,1)}),r&&i.Range.foreach(r,(c,m)=>{u.setValue(c-o,m,0)}),a.forEach(c=>{i.Range.foreach(c,(m,h)=>{u.setValue(m,h,1)})}),i.queryObjectMatrix(u,c=>c===1)},zl=(s,e)=>{var o;const t=(o=s.ranges)!=null?o:[s.range],n=new i.ObjectMatrix;return i.Range.foreach(e,(r,a)=>{n.setValue(r,a,1)}),t.forEach(r=>{const a=r.startRow,u=r.endRow-a+1;n.removeRows(a,u)}),i.queryObjectMatrix(n,r=>r===1)},ql=(s,e)=>{const t=s.params,n=t.range.startRow,o=t.range.endRow-t.range.startRow+1;return e.startRow>=n?[{startRow:e.startRow+o,endRow:e.endRow+o,startColumn:e.startColumn,endColumn:e.endColumn}]:e.endRow<n?[e]:[{startRow:e.startRow,endRow:e.endRow+o,startColumn:e.startColumn,endColumn:e.endColumn}]},Yl=(s,e)=>{const t=s.params,n=t.range.startColumn,o=t.range.endColumn-t.range.startColumn+1;return e.startColumn>=n?[{startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn+o,endColumn:e.endColumn+o}]:e.endColumn<n?[e]:[{startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn,endColumn:e.endColumn+o}]},et=(s,e)=>{let t={...e};return s.forEach(n=>{switch(n.type){case V.Delete:{t=null;break}case V.HorizontalMove:{if(!t)return;t.startColumn+=n.step,t.endColumn+=n.step+(n.length||0);break}case V.VerticalMove:{if(!t)return;t.startRow+=n.step,t.endRow+=n.step+(n.length||0);break}case V.Set:{t=n.range;break}}}),t&&(t.endColumn<t.startColumn||t.endRow<t.startRow)?null:t},Fs=(s,e)=>{let t=[];switch(e.id){case D.DeleteRangeMoveLeftCommandId:{t=oi(e,s);break}case D.DeleteRangeMoveUpCommandId:{t=ri(e,s);break}case D.InsertColCommandId:{t=ti(e,s);break}case D.InsertRangeMoveDownCommandId:{t=ni(e,s);break}case D.InsertRangeMoveRightCommandId:{t=si(e,s);break}case D.InsertRowCommandId:{t=ei(e,s);break}case D.MoveColsCommandId:{t=Hs(e,s);break}case D.MoveRangeCommandId:{t=xr(e,s);break}case D.MoveRowsCommandId:{t=Bs(e,s);break}case D.RemoveColCommandId:{t=js(e,s);break}case D.RemoveRowCommandId:{t=Qr(e,s);break}case D.ReorderRangeCommandId:{t=$l(e,s);break}}return et(t,s)},Kl=(s,e,t)=>[Ye.id,Ke.id].includes(e.id)||ai(e,t).some(r=>i.Rectangle.intersects(r,s))?Fs(s,e):s,Gs=(s,e)=>{let t=[];switch(e.id){case D.DeleteRangeMoveLeftCommandId:return Fl(e,s);case D.DeleteRangeMoveUpCommandId:return Gl(e,s);case D.InsertRangeMoveDownCommandId:return Hl(e,s);case D.InsertRangeMoveRightCommandId:return jl(e,s);case D.InsertColCommandId:return Yl(e,s);case D.InsertRowCommandId:return ql(e,s);case D.MoveColsCommandId:return Vl(e,s);case D.MoveRangeCommandId:return Ll(e,s);case D.MoveRowsCommandId:return Al(e,s);case D.ReorderRangeCommandId:return Wl(e,s);case D.RemoveColCommandId:{t=js(e,s);break}case D.RemoveRowCommandId:return zl(e.params,s)}const n=et(t,s);return n?[n]:[]},Jl=(s,e,t)=>[Ye.id,Ke.id,at.id,cs].includes(e.id)||ai(e,t).some(r=>i.Rectangle.intersects(r,s))?Gs(s,e):s;function ii(s,e){const{id:t,params:n}=e;let o={length:0,step:0,type:V.Unknown};switch(t){case ze.id:o.type=V.Delete;break;case Ne.id:o=Gt({start:n.sourceRange.startRow,end:n.sourceRange.endRow},{start:n.targetRange.startRow,end:n.targetRange.endRow},{start:s.startRow,end:s.endRow}),o.type=V.VerticalMove;break;case De.id:o=Gt({start:n.sourceRange.startColumn,end:n.sourceRange.endColumn},{start:n.targetRange.startColumn,end:n.targetRange.endColumn},{start:s.startColumn,end:s.endColumn}),o.type=V.HorizontalMove;break;case re.id:o=xe(n.range,s),o?o.type=V.HorizontalMove:o={step:0,length:0,type:V.Delete};break;case fe.id:o=xe(le(n.range),le(s)),o?o.type=V.VerticalMove:o={step:0,length:0,type:V.Delete};break;case Ce.id:o=Qe(le(n.range),le(s)),o.type=V.VerticalMove;break;case de.id:o=Qe(n.range,s),o.type=V.HorizontalMove;break;case Le.id:{const r=n.fromRange||new i.ObjectMatrix(n.from).getRange(),a=n.toRange||new i.ObjectMatrix(n.to).getRange();o=Bl(r,a,s)}break}return o?Array.isArray(o)?et(o,s):et([o],s):s}function ai(s,e){var n,o,r,a,l,u;const{selectionManagerService:t}=e;switch(s.id){case D.MoveColsCommandId:{const d=s.params;return[d.fromRange,{...d.toRange,startColumn:d.toRange.startColumn-.5,endColumn:d.toRange.endColumn-.5}]}case D.MoveRowsCommandId:{const d=s.params;return[d.fromRange,{...d.toRange,startRow:d.toRange.startRow-.5,endRow:d.toRange.startRow-.5}]}case D.MoveRangeCommandId:{const d=s;return[d.params.fromRange,d.params.toRange]}case D.InsertRowCommandId:{const c=s.params.range;return[{...c,startRow:c.startRow-.5,endRow:c.endRow-.5}]}case D.InsertColCommandId:{const c=s.params.range;return[{...c,startColumn:c.startColumn-.5,endColumn:c.endColumn-.5}]}case D.RemoveRowCommandId:return[s.params.range];case D.RemoveColCommandId:return[s.params.range];case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const c=((n=s.params)==null?void 0:n.range)||((r=(o=t.getCurrentSelections())==null?void 0:o.map(m=>m.range))==null?void 0:r[0]);return c?[c]:[]}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const c=((a=s.params)==null?void 0:a.range)||((u=(l=t.getCurrentSelections())==null?void 0:l.map(m=>m.range))==null?void 0:u[0]);return c?[c]:[]}case D.ReorderRangeCommandId:{const d=s,{range:c,order:m}=d.params,h=[];for(let R=c.startRow;R<=c.endRow;R++)R in m&&h.push({startRow:R,endRow:R,startColumn:c.startColumn,endColumn:c.endColumn});return h}}}function Xl(s){switch(s.id){case De.id:{const e=s.params;return[e.sourceRange,{...e.targetRange,startColumn:e.targetRange.startColumn-.5,endColumn:e.targetRange.startColumn-.5}]}case Ne.id:{const e=s.params;return[e.sourceRange,{...e.targetRange,startRow:e.targetRange.startRow-.5,endRow:e.targetRange.startRow-.5}]}case Le.id:{const e=s.params;return[new i.ObjectMatrix(e.from.value).getRange(),new i.ObjectMatrix(e.to.value).getRange()]}case de.id:{const t=s.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.startColumn-.5}]}case Ce.id:{const t=s.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.startRow-.5}]}case re.id:return[s.params.range];case fe.id:return[s.params.range]}}function Zl(s,e){var o,r,a,l,u,d;const t=s.get(i.IUniverInstanceService),n=s.get(g.SheetsSelectionsService);switch(e.id){case D.MoveColsCommandId:{const c=e.params,m=T(t,{unitId:c.unitId,subUnitId:c.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,{...c.toRange,startColumn:c.fromRange.startColumn<c.toRange.startColumn?c.fromRange.endColumn+1:c.toRange.startColumn,endColumn:c.fromRange.startColumn<c.toRange.startColumn?c.toRange.endColumn-1:c.fromRange.startColumn-1}]}}case D.MoveRowsCommandId:{const c=e.params,m=T(t,{unitId:c.unitId,subUnitId:c.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,{...c.toRange,startRow:c.fromRange.startRow<c.toRange.startRow?c.fromRange.endRow+1:c.toRange.startRow,endRow:c.fromRange.startRow<c.toRange.startRow?c.toRange.endRow-1:c.fromRange.startRow-1}]}}case D.MoveRangeCommandId:{const c=e.params,m=T(t);return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,c.toRange]}}case D.InsertRowCommandId:{const c=e.params,m=c.range;return{unitId:c.unitId,subUnitId:c.subUnitId,ranges:[...m.startRow>0?[{...m,startRow:m.startRow-1,endRow:m.endRow-1}]:[],{...m,startRow:m.startRow,endRow:Number.MAX_SAFE_INTEGER}]}}case D.InsertColCommandId:{const c=e.params,m=c.range;return{unitId:c.unitId,subUnitId:c.subUnitId,ranges:[...m.startColumn>0?[{...m,startColumn:m.startColumn-1,endColumn:m.endColumn-1}]:[],{...m,startColumn:m.startColumn,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.RemoveRowCommandId:{const m=e.params.range,h=T(t);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startRow:m.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}}case D.RemoveColCommandId:{const m=e.params.range,h=T(t);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const c=e,m=T(t),h=((o=c.params)==null?void 0:o.range)||((a=(r=n.getCurrentSelections())==null?void 0:r.map(R=>R.range))==null?void 0:a[0]);return h?{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[h,{...h,startRow:h.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}:{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[]}}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const m=((l=e.params)==null?void 0:l.range)||((d=(u=n.getCurrentSelections())==null?void 0:u.map(R=>R.range))==null?void 0:d[0]),h=T(t);return m?{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}:{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[]}}case D.ReorderRangeCommandId:{const c=e,{range:m,order:h}=c.params,R=[];for(let C=m.startRow;C<=m.endRow;C++)C in h&&R.push({startRow:C,endRow:C,startColumn:m.startColumn,endColumn:m.endColumn});const S=T(t);return{unitId:S.unitId,subUnitId:S.subUnitId,ranges:R}}}}var xl=Object.getOwnPropertyDescriptor,Ql=(s,e,t,n)=>{for(var o=n>1?void 0:n?xl(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},_n=(s,e)=>(t,n)=>e(t,n,s);const eu=i.createInterceptorKey("MERGE_REDO"),tu=i.createInterceptorKey("MERGE_UNDO"),li=Math.floor(Number.MAX_SAFE_INTEGER/10);class nu extends i.Disposable{constructor(e,t,n,o,r=!1){super(),this._unitId=e,this._subUnitId=t,this._range=n,this._callback=o,this._skipIntersects=r}onMutation(e){var o,r;if(((o=e.params)==null?void 0:o.unitId)!==this._unitId)return;if(e.id===Le.id){const a=e.params;if(a.from.subUnitId!==this._subUnitId||a.to.subUnitId!==this._subUnitId)return}else if(((r=e.params)==null?void 0:r.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(e.id===ze.id)return;const a=Xl(e);if(a!=null&&a.some(l=>i.Rectangle.intersects(l,this._range)))return}const t=ii(this._range,e);if(t&&i.Rectangle.equals(t,this._range))return!1;const n=this._range;this._range=t,this._callback(n,t)}}g.RefRangeService=class extends i.Disposable{constructor(t,n,o,r){super();f(this,"interceptor",new i.InterceptorManager({MERGE_REDO:eu,MERGE_UNDO:tu}));f(this,"_watchRanges",new Set);f(this,"_refRangeManagerMap",new Map);f(this,"_serializer",su());f(this,"_onRefRangeChange",()=>{this._sheetInterceptorService.interceptCommand({getMutations:t=>{const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),o=ui(this._univerInstanceService),r=di(this._univerInstanceService);if(!n||!o||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};const u=((()=>{switch(t.id){case D.MoveColsCommandId:{const R=t.params,S=Math.min(R.fromRange.startColumn,R.toRange.startColumn);return this._checkRange([{...R.fromRange,startColumn:S,endColumn:n.getColumnCount()-1}],o,r)}case D.MoveRowsCommandId:{const R=t.params,S=Math.min(R.fromRange.startRow,R.toRange.startRow);return this._checkRange([{...R.fromRange,startRow:S,endRow:n.getRowCount()-1}],o,r)}case D.MoveRangeCommandId:{const R=t;return this._checkRange([R.params.fromRange,R.params.toRange],o,r)}case D.InsertRowCommandId:{const C={startRow:t.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],o,r)}case D.InsertColCommandId:{const S=t.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:S,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],o,r)}case D.RemoveRowCommandId:{const C={startRow:t.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],o,r)}case D.RemoveColCommandId:{const S=t.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:S,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],o,r)}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const S=t.params.range||ci(this._selectionManagerService)[0],C={startRow:S.startRow,startColumn:S.startColumn,endColumn:S.endColumn,endRow:li};return this._checkRange([C],o,r)}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const S=t.params.range||ci(this._selectionManagerService)[0],C={startRow:S.startRow,startColumn:S.startColumn,endColumn:li,endRow:S.endRow};return this._checkRange([C],o,r)}case D.ReorderRangeCommandId:{const R=t,{range:S,order:C}=R.params,I=[];for(let v=S.startRow;v<=S.endRow;v++)v in C&&I.push({startRow:v,endRow:v,startColumn:S.startColumn,endColumn:S.endColumn});return this._checkRange(I,o,r)}}})()||[]).reduce((R,S)=>{const C=S(t);return R.push(C),R},[]).reduce((R,S)=>{var C,I;return R.redos.push(...S.redos),R.undos.push(...S.undos),R.preRedos.push(...(C=S.preRedos)!=null?C:[]),R.preUndos.push(...(I=S.preUndos)!=null?I:[]),R},{redos:[],undos:[],preUndos:[],preRedos:[]}),d=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(u.preRedos,null)||[],c=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(u.redos,null)||[],m=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(u.preUndos,null)||[],h=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(u.undos,null)||[];return{redos:c,undos:h,preRedos:d,preUndos:m}}})});f(this,"_checkRange",(t,n,o)=>{const r=mi(n,o),a=this._refRangeManagerMap.get(r);if(a){const l=new Set;return[...a.keys()].forEach(d=>{const c=a.get(d),m=this._serializer.deserialize(d),h={...m,startRow:+m.startRow,endRow:+m.endRow,startColumn:+m.startColumn,endColumn:+m.endColumn,rangeType:m.rangeType&&+m.rangeType};t.some(R=>i.Rectangle.intersects(R,h))&&c&&c.forEach(R=>{l.add(R)})}),[...l]}return[]});f(this,"registerRefRange",(t,n,o,r)=>{const a=o||ui(this._univerInstanceService),l=r||di(this._univerInstanceService);if(!a||!l)return i.toDisposable(()=>{});const u=mi(a,l),d=this._serializer.serialize(t);let c=this._refRangeManagerMap.get(u);c||(c=new Map,this._refRangeManagerMap.set(u,c));const m=c.get(d);return m?m.add(n):c.set(d,new Set([n])),i.toDisposable(()=>{const h=c.get(d);h&&(h.delete(n),h.size||(c.delete(d),c.size||this._refRangeManagerMap.delete(u)))})});this._commandService=t,this._sheetInterceptorService=n,this._univerInstanceService=o,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:a=>a}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:a=>a})}watchRange(t,n,o,r,a){let l;this._watchRanges.size===0&&(l=this._commandService.onCommandExecuted(m=>{if(m.type!==i.CommandType.MUTATION)return!1;for(const h of this._watchRanges)h.onMutation(m)}));const u=new nu(t,n,o,r,a);this._watchRanges.add(u);const d=i.toDisposable(()=>{this._watchRanges.delete(u),this._watchRanges.size===0&&(l==null||l.dispose(),l=null)}),c=this.disposeWithMe(d);return i.toDisposable(()=>{c.dispose(),d.dispose()})}},g.RefRangeService=Ql([_n(0,i.ICommandService),_n(1,i.Inject(g.SheetInterceptorService)),_n(2,i.Inject(i.IUniverInstanceService)),_n(3,i.Inject(g.SheetsSelectionsService))],g.RefRangeService);function ui(s){return s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()}function di(s){var e;return(e=s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId()}function ci(s){var e;return((e=s.getCurrentSelections())==null?void 0:e.map(t=>t.range))||[]}function mi(s,e){return`${s}_${e}`}function su(){const s=["startRow","startColumn","endRow","endColumn","rangeType"],e="_";return{deserialize:t=>{const n=s.reduce((r,a,l)=>(r[String(l)]=a,r),{});return t.split(e).reduce((r,a,l)=>{const u=String(l);return a&&n[u]&&(r[n[u]]=a),r},{})},serialize:t=>s.reduce((n,o,r)=>{const a=t[o];return a!==void 0?`${n}${r>0?e:""}${a}`:`${n}`},"")}}var ou=Object.getOwnPropertyDescriptor,ru=(s,e,t,n)=>{for(var o=n>1?void 0:n?ou(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},yt=(s,e)=>(t,n)=>e(t,n,s);const iu=[de.id,Ce.id,re.id,fe.id],au=[Ne.id,De.id];function zs(s,e){let t=s;if(e!==void 0){const n=[];for(let o=0;o<t.length;o++){const{startRow:r,endRow:a,startColumn:l,endColumn:u}=t[o];if(e===i.Dimension.ROWS)for(let d=r;d<=a;d++){const c={startRow:d,endRow:d,startColumn:l,endColumn:u};n.push(c)}else if(e===i.Dimension.COLUMNS)for(let d=l;d<=u;d++){const c={startRow:r,endRow:a,startColumn:d,endColumn:d};n.push(c)}}t=n}return t}const hi=i.createInterceptorKey("mergeCellPermissionCheck");g.MergeCellController=class extends i.Disposable{constructor(t,n,o,r,a,l){super();f(this,"disposableCollection",new i.DisposableCollection);f(this,"interceptor",new i.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:hi}));this._commandService=t,this._refRangeService=n,this._univerInstanceService=o,this._injector=r,this._sheetInterceptorService=a,this._selectionManagerService=l,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){const t=this;this._sheetInterceptorService.interceptCommand({getMutations(n){var o;switch(n.id){case xt.id:case en.id:{const r=t._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=r.getUnitId(),l=r==null?void 0:r.getActiveSheet();if(!l)return{redos:[],undos:[]};const u=l.getSheetId(),d=l.getConfig().mergeData,c=(o=t._selectionManagerService.getCurrentSelections())==null?void 0:o.map(m=>m.range);if(c&&c.length>0&&c.some(h=>d.some(R=>i.Rectangle.intersects(R,h)))){const h={unitId:a,subUnitId:u,ranges:c},R=ne(t._injector,h),S=[{id:G.id,params:h}],C=[{id:F.id,params:R}];return{redos:S,undos:C}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:({unitId:n,subUnitId:o,ranges:r})=>{const a=[],l=[],u={redos:a,undos:l};if(!r||!r.length)return u;const d=T(this._univerInstanceService,{unitId:n,subUnitId:o});if(!d)return u;const{worksheet:c}=d,h=c.getMergeData().filter(R=>r.some(S=>i.Rectangle.intersects(R,S)));return h.length?(a.push({id:G.id,params:{unitId:n,subUnitId:o,ranges:h}}),l.push({id:F.id,params:{unitId:n,subUnitId:o,ranges:h}}),{undos:l,redos:a}):u}})}refRangeHandle(t,n,o){switch(t.id){case D.MoveColsCommandId:{const r=t.params;return this._handleMoveColsCommand(r,n,o)}case D.MoveRowsCommandId:{const r=t.params;return this._handleMoveRowsCommand(r,n,o)}case ye.id:{const r=t.params,a=r.unitId||n,l=r.subUnitId||o;return this._handleInsertRowCommand(r,a,l)}case _e.id:{const r=t.params,a=r.unitId||n,l=r.subUnitId||o;return this._handleInsertColCommand(r,a,l)}case Wt.id:{const r=t.params;return this._handleRemoveColCommand(r,n,o)}case At.id:{const r=t.params;return this._handleRemoveRowCommand(r,n,o)}case qe.id:{const r=t.params;return this._handleMoveRangeCommand(r,n,o)}case Ot.id:{const r=t.params;return this._handleInsertRangeMoveRightCommand(r,n,o)}case at.id:{const r=t.params;return this._handleInsertRangeMoveDownCommand(r,n,o)}case Ke.id:{const r=t.params;return this._handleDeleteRangeMoveUpCommand(r,n,o)}case Ye.id:{const r=t.params;return this._handleDeleteRangeMoveLeftCommand(r,n,o)}}return{redos:[],undos:[]}}_onRefRangeChange(){const t=(n,o)=>{const r=this._univerInstanceService.getUniverSheetInstance(n);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(o);if(!a)return;this.disposableCollection.dispose();const l=a.getMergeData(),u=d=>this.refRangeHandle(d,n,o);l.forEach(d=>{this.disposableCollection.add(this._refRangeService.registerRefRange(d,u,n,o))})};this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===Ct.id){const o=n.params,r=o.subUnitId,a=o.unitId;if(!r||!a)return;t(a,r)}if(n.id===F.id){const o=n.params,r=o.subUnitId,a=o.unitId;if(!r||!a)return;t(o.unitId,o.subUnitId)}})),this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(A.first(n=>!!n)).subscribe(n=>{const o=n.getActiveSheet();o&&t(n.getUnitId(),o.getSheetId())})}_handleMoveRowsCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=[...a.getMergeData()],u={unitId:n,subUnitId:o,ranges:[]},d={unitId:n,subUnitId:o,ranges:[]},{fromRange:c}=t,{startRow:m,endRow:h}=c;if(l.forEach(C=>{if(m<=C.startRow&&h>=C.endRow){u.ranges.push(C);const I=Bs({id:D.MoveRowsCommandId,params:t},C),v=et(I,C);v&&d.ranges.push(v)}}),u.ranges.length===0)return this._handleNull();const R=ne(this._injector,u),S=he(this._injector,d);return{preRedos:[{id:G.id,params:u}],redos:[{id:F.id,params:d}],preUndos:[{id:G.id,params:S}],undos:[{id:F.id,params:R}]}}_handleMoveColsCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=[...a.getMergeData()],u={unitId:n,subUnitId:o,ranges:[]},d={unitId:n,subUnitId:o,ranges:[]},{fromRange:c}=t,{startColumn:m,endColumn:h}=c;if(l.forEach(C=>{if(m<=C.startColumn&&h>=C.endColumn){u.ranges.push(C);const I=Hs({id:D.MoveColsCommandId,params:t},C),v=et(I,C);v&&d.ranges.push(v)}}),u.ranges.length===0)return this._handleNull();const R=ne(this._injector,u),S=he(this._injector,d);return{preRedos:[{id:G.id,params:u}],redos:[{id:F.id,params:d}],preUndos:[{id:G.id,params:S}],undos:[{id:F.id,params:R}]}}_handleMoveRangeCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=a.getMergeData(),u=l.filter(S=>i.Rectangle.intersects(S,t.fromRange)),d=l.filter(S=>i.Rectangle.intersects(S,t.toRange)),c=u.map(S=>i.Rectangle.getRelativeRange(S,t.fromRange)).map(S=>i.Rectangle.getPositionRange(S,t.toRange)),m=zs(c).filter(S=>!l.some(C=>i.Rectangle.equals(S,C))),h=[{id:G.id,params:{unitId:n,subUnitId:o,ranges:u}},{id:G.id,params:{unitId:n,subUnitId:o,ranges:d}},{id:F.id,params:{unitId:n,subUnitId:o,ranges:m}}],R=[{id:G.id,params:{unitId:n,subUnitId:o,ranges:m}},{id:F.id,params:{unitId:n,subUnitId:o,ranges:d}},{id:F.id,params:{unitId:n,subUnitId:o,ranges:u}}];return{redos:h,undos:R}}_handleInsertRowCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const{range:l}=t,{startRow:u,endRow:d}=l,c=i.Tools.deepClone(a.getMergeData()).reduce((w,p)=>(u>p.startRow&&u<=p.endRow&&w.push(p),w),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((w,p)=>{if(u>p.startRow&&u<=p.endRow){const M=d-u+1;p.endRow+=M,this._checkIsMergeCell(p)&&w.push(p)}return w},[]),h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h},{id:F.id,params:S}],v=[{id:G.id,params:C},{id:F.id,params:R}];return{redos:I,undos:v}}_handleInsertColCommand(t,n,o){const{range:r}=t,a=Ie(this._univerInstanceService,n);if(!a)return this._handleNull();const l=ve(a,o);if(!l)return this._handleNull();const{startColumn:u,endColumn:d}=r,c=i.Tools.deepClone(l.getMergeData()).reduce((w,p)=>(u>p.startColumn&&u<=p.endColumn&&w.push(p),w),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(l.getMergeData()).reduce((w,p)=>{if(u>p.startColumn&&u<=p.endColumn){const M=d-u+1;p.endColumn+=M,this._checkIsMergeCell(p)&&w.push(p)}return w},[]),h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h},{id:F.id,params:S}],v=[{id:G.id,params:C},{id:F.id,params:R}];return{redos:I,undos:v}}_handleRemoveColCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const{range:l}=t,{startColumn:u,endColumn:d}=l,c=i.Tools.deepClone(a.getMergeData()).reduce((M,y)=>(i.Rectangle.intersects(l,y)&&M.push(y),M),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((M,y)=>{if(i.Rectangle.intersects(l,y)){if(u<=y.startColumn&&d>=y.endColumn)return M;u>=y.startColumn&&d<=y.endColumn?y.endColumn-=d-u+1:u<y.startColumn?(y.startColumn=u,y.endColumn-=d-u+1):d>y.endColumn&&(y.endColumn=u-1),this._checkIsMergeCell(y)&&M.push(y)}return M},[]),h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h}],v=[{id:F.id,params:S}],w=[{id:G.id,params:C}],p=[{id:F.id,params:R}];return{preUndos:w,undos:p,preRedos:I,redos:v}}_handleRemoveRowCommand(t,n,o){const{range:r}=t,a=Ie(this._univerInstanceService,n);if(!a)return this._handleNull();const l=ve(a,o);if(!l)return this._handleNull();const{startRow:u,endRow:d}=r,c=i.Tools.deepClone(l.getMergeData()).reduce((M,y)=>(i.Rectangle.intersects(r,y)&&M.push(y),M),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(l.getMergeData()).reduce((M,y)=>{if(i.Rectangle.intersects(r,y)){if(u<=y.startRow&&d>=y.endRow)return M;u>=y.startRow&&d<=y.endRow?y.endRow-=d-u+1:u<y.startRow?(y.startRow=u,y.endRow-=d-u+1):d>y.endRow&&(y.endRow=u-1),this._checkIsMergeCell(y)&&M.push(y)}return M},[]),h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h}],v=[{id:F.id,params:S}],w=[{id:G.id,params:C}],p=[{id:F.id,params:R}];return{preUndos:w,undos:p,preRedos:I,redos:v}}_handleInsertRangeMoveRightCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=t.range,u=a.getMaxColumns()-1,d=a.getMergeData(),c=[],m=[];d.forEach(I=>{const{startRow:v,endRow:w,startColumn:p,endColumn:M}=l;if(i.Rectangle.intersects({startRow:v,startColumn:p,endRow:w,endColumn:u},I)&&(c.push(I),i.Rectangle.contains({startRow:v,startColumn:p,endRow:w,endColumn:u},I))){const k=M-p+1;m.push({startRow:I.startRow,startColumn:I.startColumn+k,endRow:I.endRow,endColumn:I.endColumn+k})}});const h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S);return{preRedos:[{id:G.id,params:h}],redos:[{id:F.id,params:S}],preUndos:[{id:G.id,params:C}],undos:[{id:F.id,params:R}]}}_handleInsertRangeMoveDownCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=t.range,u=a.getMaxRows()-1,d=a.getMergeData(),c=[],m=[];d.forEach(M=>{const{startRow:y,startColumn:b,endColumn:k,endRow:U}=l;if(i.Rectangle.intersects({startRow:y,startColumn:b,endRow:u,endColumn:k},M)&&(c.push(M),i.Rectangle.contains({startRow:y,startColumn:b,endRow:u,endColumn:k},M))){const O=U-y+1;m.push({startRow:M.startRow+O,startColumn:M.startColumn,endRow:M.endRow+O,endColumn:M.endColumn})}});const h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h}],v=[{id:F.id,params:S}],w=[{id:G.id,params:C}],p=[{id:F.id,params:R}];return{redos:v,undos:p,preRedos:I,preUndos:w}}_handleDeleteRangeMoveUpCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=t.range,u=a.getMaxRows()-1,d=a.getMergeData(),c=[],m=[];d.forEach(M=>{const{startRow:y,startColumn:b,endColumn:k,endRow:U}=l;if(i.Rectangle.intersects({startRow:y,startColumn:b,endRow:u,endColumn:k},M)&&(c.push(M),i.Rectangle.contains({startRow:y,startColumn:b,endRow:u,endColumn:k},M))){const O=U-y+1,W=i.Rectangle.moveVertical(M,-O);m.push(W)}});const h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S),I=[{id:G.id,params:h}],v=[{id:F.id,params:S}],w=[{id:G.id,params:C}],p=[{id:F.id,params:R}];return{redos:v,undos:p,preRedos:I,preUndos:w}}_handleDeleteRangeMoveLeftCommand(t,n,o){const r=Ie(this._univerInstanceService,n);if(!r)return this._handleNull();const a=ve(r,o);if(!a)return this._handleNull();const l=t.range,u=a.getMaxColumns()-1,d=a.getMergeData(),c=[],m=[];d.forEach(I=>{const{startRow:v,endRow:w,startColumn:p,endColumn:M}=l;if(i.Rectangle.intersects({startRow:v,startColumn:p,endRow:w,endColumn:u},I)&&(c.push(I),i.Rectangle.contains({startRow:v,startColumn:p,endRow:w,endColumn:u},I))){const k=M-p+1;m.push({startRow:I.startRow,startColumn:I.startColumn-k,endRow:I.endRow,endColumn:I.endColumn-k})}});const h={unitId:n,subUnitId:o,ranges:c},R=ne(this._injector,h),S={unitId:n,subUnitId:o,ranges:m},C=he(this._injector,S);return{preRedos:[{id:G.id,params:h}],redos:[{id:F.id,params:S}],undos:[{id:F.id,params:R}],preUndos:[{id:G.id,params:C}]}}_checkIsMergeCell(t){return!(t.startRow===t.endRow&&t.startColumn===t.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(au.includes(t.id)){if(!t.params)return;const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const o=n.getSheetBySheetId(t.params.subUnitId);if(!o)return;const{sourceRange:r,targetRange:a}=t.params,l=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,u=l?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,d=l?r.startRow:r.startColumn,c=l?a.startRow:a.startColumn,m=o.getConfig().mergeData,h=[];m.forEach(I=>{let{startRow:v,endRow:w,startColumn:p,endColumn:M,rangeType:y}=I;i.Rectangle.intersects(I,r)||(l?d<v&&c>w?(v-=u,w-=u):d>w&&c<=v&&(v+=u,w+=u):d<p&&c>M?(p-=u,M-=u):d>M&&c<=p&&(p+=u,M+=u)),I.startRow===I.endRow&&I.startColumn===I.endColumn||h.push({startRow:v,endRow:w,startColumn:p,endColumn:M,rangeType:y})}),o.setMergeData(h),this.disposableCollection.dispose();const{unitId:R,subUnitId:S}=t.params,C=I=>this.refRangeHandle(I,R,S);h.forEach(I=>{this.disposableCollection.add(this._refRangeService.registerRefRange(I,C,R,S))})}if(iu.includes(t.id)){const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const o=n.getSheetBySheetId(t.params.subUnitId);if(!o)return;const r=o.getConfig().mergeData,a=t.params;if(!a)return;const{range:l}=a,u=t.id.includes("row"),d=t.id.includes("insert"),c=u?l.startRow:l.startColumn,m=u?l.endRow:l.endColumn,h=m-c+1,R=[];r.forEach(v=>{let{startRow:w,endRow:p,startColumn:M,endColumn:y,rangeType:b}=v;d?u?c<=w&&(w+=h,p+=h):c<=M&&(M+=h,y+=h):u?m<w&&(w-=h,p-=h):m<M&&(M-=h,y-=h),v.startRow===v.endRow&&v.startColumn===v.endColumn||R.push({startRow:w,endRow:p,startColumn:M,endColumn:y,rangeType:b})}),o.setMergeData(R),this.disposableCollection.dispose();const{unitId:S,subUnitId:C}=t.params,I=v=>this.refRangeHandle(v,S,C);R.forEach(v=>{this.disposableCollection.add(this._refRangeService.registerRefRange(v,I,S,C))})}}))}},g.MergeCellController=ru([yt(0,i.Inject(i.ICommandService)),yt(1,i.Inject(g.RefRangeService)),yt(2,i.Inject(i.IUniverInstanceService)),yt(3,i.Inject(i.Injector)),yt(4,i.Inject(g.SheetInterceptorService)),yt(5,i.Inject(g.SheetsSelectionsService))],g.MergeCellController);function Ie(s,e){return e?s.getUniverSheetInstance(e):s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET)}function ve(s,e){return e?s.getSheetBySheetId(e):s.getActiveSheet()}var lu=Object.getOwnPropertyDescriptor,uu=(s,e,t,n)=>{for(var o=n>1?void 0:n?lu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},du=(s,e)=>(t,n)=>e(t,n,s);let bn=class extends i.Disposable{constructor(s){super(),this._sheetInterceptorService=s,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(Pe.CELL_CONTENT,{priority:11,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s,e,t)=>{var o;const n=e.workbook.getStyles().getStyleByCell(s);return(o=n==null?void 0:n.n)!=null&&o.pattern?t({...s}):(s==null?void 0:s.t)===i.CellValueType.NUMBER&&s.v!==void 0&&s.v!==null&&i.isRealNum(s.v)?t({...s,v:z.stripErrorMargin(Number(s.v))}):t({...s})}}))}};bn=uu([du(0,i.Inject(g.SheetInterceptorService))],bn);var cu=Object.getOwnPropertyDescriptor,mu=(s,e,t,n)=>{for(var o=n>1?void 0:n?cu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ee=(s,e)=>(t,n)=>e(t,n,s);g.SheetPermissionCheckController=class extends i.Disposable{constructor(t,n,o,r,a,l,u,d,c,m){super();f(this,"disposableCollection",new i.DisposableCollection);f(this,"_triggerPermissionUIEvent$",new A.Subject);f(this,"triggerPermissionUIEvent$",this._triggerPermissionUIEvent$.asObservable());this._commandService=t,this._univerInstanceService=n,this._permissionService=o,this._selectionManagerService=r,this._rangeProtectionRuleModel=a,this._worksheetProtectionRuleModel=l,this._localeService=u,this._lexerTreeBuilder=d,this._contextService=c,this._definedNamesService=m,this._initialize()}blockExecuteWithoutPermission(t){throw this._triggerPermissionUIEvent$.next(t),new i.CustomCommandExecutionError("have no permission")}_getPermissionCheck(t,n){let o=!0,r="";switch(t){case it.id:i.isICellData(n.value)&&n.value.f?(o=this._permissionCheckWithFormula(n),r=this._localeService.t("permission.dialog.formulaErr")):o=this._permissionCheckBySetRangeValue({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[Pt,me]},n);break;case Qt.id:o=this.permissionCheckWithRanges({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[Pt,me]}),r=this._localeService.t("permission.dialog.editErr");break;case hn.id:case Ht.id:o=this.permissionCheckWithoutRange({worksheetTypes:[ot]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Cn.id:case fn.id:case In.id:o=this.permissionCheckWithoutRange({worksheetTypes:[rt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Dt.id:case Nt.id:o=this._permissionCheckByMoveCommand(n),r=this._localeService.t("permission.dialog.moveRowColErr");break;case qe.id:o=this._permissionCheckByMoveRangeCommand(n),r=this._localeService.t("permission.dialog.moveRangeErr");break;case Ps.id:o=this._permissionCheckByWorksheetCommand([ae,an]),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case gn.id:o=this._permissionCheckByWorksheetCommand([ae,ln]),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case As.id:{const{unitId:a,subUnitId:l}=n;o=this._permissionCheckByWorksheetCommand([ae,on],a,l),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder()}break;case Lt.id:o=this.permissionCheckWithRanges({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[me,ot]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case $t.id:o=this.permissionCheckWithRanges({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[me,rt]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case vs.id:o=this.permissionCheckWithRanges({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[me,ot]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case ys.id:o=this.permissionCheckWithRanges({workbookTypes:[ae],rangeTypes:[ce],worksheetTypes:[me,rt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Ot.id:o=this._permissionCheckWithInsertRangeMove("right"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case at.id:o=this._permissionCheckWithInsertRangeMove("bottom"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Ye.id:o=this._permissionCheckWithInsertRangeMove("left"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Ke.id:o=this._permissionCheckWithInsertRangeMove("top"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break}o||this.blockExecuteWithoutPermission(r)}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(t=>{this._getPermissionCheck(t.id,t==null?void 0:t.params)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var n;if(t.id===jt.id){const o=t.params,{unitId:r=(n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId(),subUnitId:a}=o;if(!r||!a)return;const l=this._worksheetProtectionRuleModel.getRule(r,a),u=this._rangeProtectionRuleModel.getSubunitRuleList(r,a);l&&this._worksheetProtectionRuleModel.ruleRefresh(l.permissionId),u.length&&this._rangeProtectionRuleModel.ruleRefresh(a)}}))}_permissionCheckWithInsertRangeMove(t){var c;const n=T(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,l=i.Tools.deepClone((c=this._selectionManagerService.getCurrentLastSelection())==null?void 0:c.range);return!(!l||(t==="top"||t==="bottom"?l.endRow=o.getRowCount()-1:(t==="left"||t==="right")&&(l.endColumn=o.getColumnCount()-1),this._rangeProtectionRuleModel.getSubunitRuleList(r,a).map(m=>m.ranges).flat().some(m=>i.Rectangle.getIntersects(l,m))))}_permissionCheckByWorksheetCommand(t,n,o){var c,m;const r=T(this._univerInstanceService,{unitId:n,subUnitId:o});if(!r)return!1;const{unitId:a,subUnitId:l}=r,u=this._worksheetProtectionRuleModel.getRule(a,l),d=this._rangeProtectionRuleModel.getSubunitRuleList(a,l).length>0;return u||d?(m=(c=this._permissionService.getPermissionPoint(new rn(a).id))==null?void 0:c.value)!=null?m:!1:this._permissionService.composePermission(t.map(h=>new h(a).id)).every(h=>h.value)}permissionCheckWithoutRange(t){var R,S,C,I;const n=T(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,l=this._selectionManagerService.getCurrentLastSelection();if(!l)return!0;const u=(S=(R=l==null?void 0:l.primary)==null?void 0:R.actualRow)!=null?S:0,d=(I=(C=l==null?void 0:l.primary)==null?void 0:C.actualColumn)!=null?I:0,{workbookTypes:c,worksheetTypes:m,rangeTypes:h}=t;return!(c&&c.some(w=>{var y,b;const p=new w(r);return((b=(y=this._permissionService.getPermissionPoint(p.id))==null?void 0:y.value)!=null?b:!1)===!1})===!0||m&&m.some(w=>{var y,b;const p=new w(r,a);return((b=(y=this._permissionService.getPermissionPoint(p.id))==null?void 0:y.value)!=null?b:!1)===!1})===!0||h&&h.some(w=>{var k,U,P,E,O;const p=(U=(k=o.getCell(u,d))==null?void 0:k.selectionProtection)==null?void 0:U[0];if(!(p!=null&&p.ruleId))return!1;const M=(P=this._rangeProtectionRuleModel.getRule(r,a,p.ruleId))==null?void 0:P.permissionId;if(!M)return!1;const y=new w(r,a,M);return((O=(E=this._permissionService.getPermissionPoint(y.id))==null?void 0:E.value)!=null?O:!1)===!1})===!0)}permissionCheckWithRanges(t,n,o,r){var S;const a=T(this._univerInstanceService);if(!a)return!1;const{workbook:l,worksheet:u}=a;o||(o=l.getUnitId()),r||(r=u.getSheetId());const d=n!=null?n:(S=this._selectionManagerService.getCurrentSelections())==null?void 0:S.map(C=>C.range);if(!d)return!1;const{workbookTypes:c,worksheetTypes:m,rangeTypes:h}=t,R=[];return c&&R.push(...c.map(C=>new C(o).id)),m&&R.push(...m.map(C=>new C(o,r).id)),h&&this._rangeProtectionRuleModel.getSubunitRuleList(o,r).forEach(C=>{d.some(v=>C.ranges.some(w=>i.Rectangle.intersects(w,v)))&&R.push(...h.map(v=>new v(o,r,C.permissionId).id))}),R.length?this._permissionService.composePermission(R).every(C=>C.value):!0}_permissionCheckByMoveCommand(t){const n=T(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,l=t.toRange;l.endRow===o.getRowCount()-1?l.endColumn=l.startColumn:l.endRow=l.startRow;const u=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((d,c)=>[...d,...c.ranges],[]).filter(d=>i.Rectangle.intersects(d,l));return u.length>0?!1:(u.forEach(d=>{var c,m;for(let h=d.startRow;h<=d.endRow;h++)for(let R=d.startColumn;R<=d.endColumn;R++){const S=(m=(c=o.getCell(h,R))==null?void 0:c.selectionProtection)==null?void 0:m[0];if((S==null?void 0:S[_.Edit])===!1)return!1}}),!0)}_permissionCheckByMoveRangeCommand(t){const n=T(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,l=t.toRange,u=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((d,c)=>[...d,...c.ranges],[]).filter(d=>i.Rectangle.intersects(d,l));return u.length>0?!1:(u.forEach(d=>{var c,m;for(let h=d.startRow;h<=d.endRow;h++)for(let R=d.startColumn;R<=d.endColumn;R++){const S=(m=(c=o.getCell(h,R))==null?void 0:c.selectionProtection)==null?void 0:m[0];if((S==null?void 0:S[_.Edit])===!1)return!1}}),!0)}_permissionCheckBySetRangeValue(t,n){let o=[];n.range?o=[n.range]:o=[new i.ObjectMatrix(n.value).getDataRange()];const{unitId:r,subUnitId:a}=n;return this.permissionCheckWithRanges(t,o,r,a)}_permissionCheckWithFormula(t){var a,l,u,d,c;const n=t.value,o=t.range,r=n.f;if(r){const m=r.substring(1),h=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),R=(a=t.unitId)!=null?a:h.getUnitId(),S=this._definedNamesService.getValueByName(R,m);if(S){let C=S.formulaOrRefString;C.startsWith(z.operatorToken.EQUALS)&&(C=C.slice(1));const I=C.split(",");for(let v=0;v<I.length;v++){const w=I[v],p=z.deserializeRangeWithSheet(w);if(p.sheetName){const M=h.getSheetBySheetName(p.sheetName);if(!M)return!0;const{startRow:y,endRow:b,startColumn:k,endColumn:U}=p.range;for(let P=y;P<=b;P++)for(let E=k;E<=U;E++){const O=(u=(l=M.getCell(P,E))==null?void 0:l.selectionProtection)==null?void 0:u[0];if((O==null?void 0:O[_.View])===!1)return!1}}}return!0}else{const C=this._lexerTreeBuilder.sequenceNodesBuilder(r);if(!C)return!0;for(let I=0;I<C.length;I++){const v=C[I];if(typeof v=="string"||v.nodeType!==z.sequenceNodeType.REFERENCE)continue;const{token:w}=v,p=z.deserializeRangeWithSheetWithCache(w),M=p.unitId?this._univerInstanceService.getUnit(p.unitId):this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!M)return!0;let y=p.sheetName?M.getSheetBySheetName(p.sheetName):M.getActiveSheet();const b=M.getUnitId();if(p.sheetName){if(y=M.getSheetBySheetName(p.sheetName),!y)return!0;const O=y==null?void 0:y.getSheetId();if(!this._permissionService.getPermissionPoint(new kt(b,O).id))return!1}if(!y)return!0;const{startRow:k,endRow:U,startColumn:P,endColumn:E}=p.range;for(let O=k;O<=U;O++)for(let W=P;W<=E;W++){const L=(c=(d=y.getCell(O,W))==null?void 0:d.selectionProtection)==null?void 0:c[0];if((L==null?void 0:L[_.View])===!1)return!1}}return!0}}if(o){const m=T(this._univerInstanceService);if(!m)return!1;const h=t.unitId||m.unitId,R=t.subUnitId||m.subUnitId,C=this._rangeProtectionRuleModel.getSubunitRuleList(h,R).filter(v=>v.ranges.some(w=>i.Rectangle.intersects(w,o))).map(v=>new ce(h,R,v.permissionId).id);if(!this._permissionService.composePermission(C).every(v=>v.value))return!1}return!0}},g.SheetPermissionCheckController=mu([Ee(0,i.ICommandService),Ee(1,i.IUniverInstanceService),Ee(2,i.IPermissionService),Ee(3,i.Inject(g.SheetsSelectionsService)),Ee(4,i.Inject(J)),Ee(5,i.Inject(we)),Ee(6,i.Inject(i.LocaleService)),Ee(7,i.Inject(z.LexerTreeBuilder)),Ee(8,i.IContextService),Ee(9,z.IDefinedNamesService)],g.SheetPermissionCheckController);var hu=Object.getOwnPropertyDescriptor,gu=(s,e,t,n)=>{for(var o=n>1?void 0:n?hu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},zt=(s,e)=>(t,n)=>e(t,n,s);g.WorkbookPermissionService=class extends i.Disposable{constructor(t,n,o,r,a){super();f(this,"_unitPermissionInitStateChange",new A.BehaviorSubject(!1));f(this,"unitPermissionInitStateChange$",this._unitPermissionInitStateChange.asObservable());this._permissionService=t,this._univerInstanceService=n,this._rangeProtectionRuleModel=o,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointModel=a,this._init()}_init(){const t=n=>{const o=n.getUnitId();pt().forEach(r=>{const a=new r(o);this._permissionService.addPermissionPoint(a)})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{t(n)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{t(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{const o=n.getUnitId();n.getSheets().forEach(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(o,a).forEach(u=>{[...se()].forEach(d=>{const c=new d(o,a,u.permissionId);this._permissionService.deletePermissionPoint(c.id)})}),[...oe(),...ge()].forEach(u=>{const d=new u(o,a);this._permissionService.deletePermissionPoint(d.id)})}),pt().forEach(r=>{const a=new r(o);this._permissionService.deletePermissionPoint(a.id)}),this._rangeProtectionRuleModel.deleteUnitModel(o),this._worksheetProtectionPointModel.deleteUnitModel(o),this._worksheetProtectionRuleModel.deleteUnitModel(o)}))}changeUnitInitState(t){this._unitPermissionInitStateChange.next(t)}},g.WorkbookPermissionService=gu([zt(0,i.Inject(i.IPermissionService)),zt(1,i.Inject(i.IUniverInstanceService)),zt(2,i.Inject(J)),zt(3,i.Inject(we)),zt(4,i.Inject(vt))],g.WorkbookPermissionService);var Ru=Object.getOwnPropertyDescriptor,Su=(s,e,t,n)=>{for(var o=n>1?void 0:n?Ru(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Te=(s,e)=>(t,n)=>e(t,n,s);g.SheetPermissionInitController=class extends i.Disposable{constructor(e,t,n,o,r,a,l,u,d,c){super(),this._univerInstanceService=e,this._permissionService=t,this._authzIoService=n,this._rangeProtectionRuleModel=o,this._worksheetProtectionRuleModel=r,this._userManagerService=a,this._worksheetProtectionPointRuleModel=l,this._workbookPermissionService=u,this._undoRedoService=d,this._commandService=c}initPermission(){this._initRangePermissionFromSnapshot(),this._initRangePermissionChange(),this._initWorksheetPermissionFromSnapshot(),this._initWorksheetPermissionChange(),this._initWorksheetPermissionPointsChange(),this._initWorkbookPermissionFromSnapshot(),this._initUserChange(),this._refreshPermissionByCollaCreate()}async _initRangePermissionFromSnapshot(){const e=async t=>{const n=[],o=t.getUnitId(),r=t.getSheets(),a=new Map;if(r.forEach(l=>{const u=l.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(o,u).forEach(d=>{a.set(d.permissionId,d),n.push({objectID:d.permissionId,unitID:o,objectType:N.SelectRange,actions:He})})}),!n.length){this._rangeProtectionRuleModel.changeRuleInitState(!0);return}this._authzIoService.batchAllowed(n).then(l=>{l.forEach(u=>{const d=a.get(u.objectID);d&&se().forEach(c=>{const m=new c(o,d.subUnitId,u.objectID),h=m.subType,R=u.actions.find(S=>S.action===h);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(m.id,R.allowed)})}),this._rangeProtectionRuleModel.changeRuleInitState(!0)})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(t=>e(t))),this._rangeProtectionRuleModel.changeRuleInitState(!0)}_initRangePermissionChange(){this.disposeWithMe(this._rangeProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.SelectRange,actions:He}).then(t=>{se().forEach(n=>{if(e.type==="set"){const{rule:u,oldRule:d}=e;if(u.permissionId===(d==null?void 0:d.permissionId))return}const o=e.rule,r=new n(o.unitId,o.subUnitId,o.permissionId),a=r.subType,l=t.find(u=>u.action===a);l&&this._permissionService.updatePermissionPoint(r.id,l.allowed)}),this._rangeProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):this._rangeProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId).length===0&&(this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId),[...ge()].forEach(n=>{const o=new n(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(o.id,o.value)}))}))}async initWorkbookPermissionChange(e){var n;const t=e||((n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId());if(t)return this._authzIoService.allowed({objectID:t,objectType:N.Workbook,unitID:t,actions:Er}).then(o=>{pt().forEach(r=>{const a=new r(t),l=a.subType,u=o.find(d=>d.action===l);u&&this._permissionService.updatePermissionPoint(a.id,u.allowed)})})}async _initWorkbookPermissionFromSnapshot(){await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(e=>this.initWorkbookPermissionChange(e.getUnitId()))),this._workbookPermissionService.changeUnitInitState(!0)}_initWorksheetPermissionChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:He}).then(t=>{oe().forEach(n=>{const o=new n(e.unitId,e.subUnitId),r=o.subType,a=t.find(l=>l.action===r);a&&this._permissionService.updatePermissionPoint(o.id,a.allowed)}),this._worksheetProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):([...oe(),...ge()].forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId))}))}_initWorksheetPermissionPointsChange(){this.disposeWithMe(this._worksheetProtectionPointRuleModel.pointChange$.subscribe(e=>{this._authzIoService.allowed({objectID:e.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:Rn}).then(t=>{ge().forEach(n=>{const o=new n(e.unitId,e.subUnitId),r=o.subType,a=t.find(l=>l.action===r);a&&this._permissionService.updatePermissionPoint(o.id,a.allowed)})})}))}async _initWorksheetPermissionFromSnapshot(){const e=async t=>{const n=[],o=t.getUnitId(),r=t.getSheets(),a=new Map;if(r.forEach(l=>{const u=l.getSheetId(),d=this._worksheetProtectionRuleModel.getRule(o,u);d&&(a.set(d.permissionId,d),n.push({objectID:d.permissionId,unitID:o,objectType:N.Worksheet,actions:He}));const c=this._worksheetProtectionPointRuleModel.getRule(o,u);c&&(a.set(c.permissionId,c),n.push({objectID:c.permissionId,unitID:o,objectType:N.Worksheet,actions:Rn}))}),!n.length){this._worksheetProtectionRuleModel.changeRuleInitState(!0);return}this._authzIoService.batchAllowed(n).then(l=>{l.forEach(u=>{const d=a.get(u.objectID);d&&[...oe(),...ge()].forEach(c=>{const m=new c(o,d.subUnitId),h=m.subType,R=u.actions.find(S=>S.action===h);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(m.id,R.allowed)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(t=>e(t))),this._worksheetProtectionRuleModel.changeRuleInitState(!0)}_initUserChange(){this.disposeWithMe(this._userManagerService.currentUser$.pipe(A.skip(1)).subscribe(()=>{const e=this._permissionService.getAllPermissionPoint();this._permissionService.clearPermissionMap(),this._worksheetProtectionRuleModel.changeRuleInitState(!1),this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{const o=n.getUnitId();pt().forEach(r=>{let a=new r(o);e.has(a.id)&&(a=e.get(a.id)),this._permissionService.addPermissionPoint(a)}),n.getSheets().forEach(r=>{const a=r.getSheetId();[...oe(),...ge()].forEach(u=>{let d=new u(o,a);e.has(d.id)&&(d=e.get(d.id)),this._permissionService.addPermissionPoint(d)}),this._rangeProtectionRuleModel.getSubunitRuleList(o,a).forEach(u=>{se().forEach(d=>{let c=new d(o,a,u.permissionId);e.has(c.id)&&(c=e.get(c.id)),this._permissionService.addPermissionPoint(c)})})}),this._initWorkbookPermissionFromSnapshot(),this._initWorksheetPermissionFromSnapshot(),this._initRangePermissionFromSnapshot()})}))}refreshPermission(e,t){const n=this._worksheetProtectionRuleModel.getTargetByPermissionId(e,t);let o=!1;if(n){const[l,u]=n;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.Worksheet,actions:He}).then(d=>{let c="";oe().forEach(m=>{var C;const h=new m(e,u),R=h.subType,S=d.find(I=>I.action===R);S&&(((C=this._permissionService.getPermissionPoint(h.id))==null?void 0:C.value)!==S.allowed&&(o=!0),this._permissionService.updatePermissionPoint(h.id,S.allowed),c+=`${S.action}_${S.allowed}`)}),this._worksheetProtectionRuleModel.ruleRefresh(`${t}_${c}`),o&&this._undoRedoService.clearUndoRedo(e)})}const r=this._worksheetProtectionPointRuleModel.getTargetByPermissionId(e,t);if(r){const[l,u]=r;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.Worksheet,actions:Rn}).then(d=>{ge().forEach(c=>{var S;const m=new c(e,u),h=m.subType,R=d.find(C=>C.action===h);R&&(((S=this._permissionService.getPermissionPoint(m.id))==null?void 0:S.value)!==R.allowed&&(o=!0),this._permissionService.updatePermissionPoint(m.id,R.allowed))}),o&&this._undoRedoService.clearUndoRedo(e)})}const a=this._rangeProtectionRuleModel.getTargetByPermissionId(e,t);if(a){const[l,u]=a;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.SelectRange,actions:He}).then(d=>{let c="";se().forEach(m=>{var C;const h=new m(e,u,t),R=h.subType,S=d.find(I=>I.action===R);S&&(((C=this._permissionService.getPermissionPoint(h.id))==null?void 0:C.value)!==S.allowed&&(o=!0),this._permissionService.updatePermissionPoint(h.id,S.allowed),c+=`${S.action}_${S.allowed}`)}),this._rangeProtectionRuleModel.ruleRefresh(`${t}_${c}`),o&&this._undoRedoService.clearUndoRedo(e)})}}_refreshPermissionByCollaCreate(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{if(t!=null&&t.fromCollab&&(e.id===ue.id||e.id===Ve.id||e.id===Sn.id)){const n=e.params;this._undoRedoService.clearUndoRedo(n.unitId)}}))}},g.SheetPermissionInitController=Su([Te(0,i.IUniverInstanceService),Te(1,i.IPermissionService),Te(2,i.IAuthzIoService),Te(3,i.Inject(J)),Te(4,i.Inject(we)),Te(5,i.Inject(i.UserManagerService)),Te(6,i.Inject(vt)),Te(7,i.Inject(g.WorkbookPermissionService)),Te(8,i.Inject(i.IUndoRedoService)),Te(9,i.Inject(i.ICommandService))],g.SheetPermissionInitController);var Cu=Object.getOwnPropertyDescriptor,fu=(s,e,t,n)=>{for(var o=n>1?void 0:n?Cu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},qs=(s,e)=>(t,n)=>e(t,n,s);g.RangeProtectionCache=class extends i.Disposable{constructor(t,n,o){super();f(this,"_cellRuleCache",new Map);f(this,"_permissionIdCache",new Map);f(this,"_cellInfoCache",new Map);f(this,"_rowInfoCache",new Map);f(this,"_colInfoCache",new Map);this._ruleModel=t,this._permissionService=n,this._univerInstanceService=o,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(t=>{t.getSheets().forEach(n=>{const o=t.getUnitId(),r=n.getSheetId();this.reBuildCache(o,r)})})}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe(A.filter(t=>t.type===N.SelectRange),A.map(t=>t)).subscribe(t=>{const{subUnitId:n,unitId:o,permissionId:r}=t,a=this._permissionIdCache.get(r);if(!a)return;const l=this._ruleModel.getRule(o,n,a);if(!l)return;const u=this._ensureCellInfoMap(o,n);l.ranges.forEach(d=>{const{startRow:c,endRow:m,startColumn:h,endColumn:R}=d;for(let S=c;S<=m;S++)for(let C=h;C<=R;C++)u.delete(`${S}-${C}`)})}),this._ruleModel.ruleChange$.subscribe(t=>{var a;const{unitId:n,subUnitId:o}=t,r=this._ensureCellInfoMap(n,o);t.rule.ranges.forEach(l=>{i.Range.foreach(l,(u,d)=>{r.delete(`${u}-${d}`)})}),t.type==="set"&&((a=t.oldRule)==null||a.ranges.forEach(l=>{i.Range.foreach(l,(u,d)=>{this._cellInfoCache.delete(`${u}-${d}`)})}))})}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe(t=>{const{type:n}=t;n==="add"?this._addCellRuleCache(t):n==="delete"?this._deleteCellRuleCache(t):(this._deleteCellRuleCache({...t,rule:t.oldRule}),this._addCellRuleCache(t))})}_ensureRuleMap(t,n){let o=this._cellRuleCache.get(t);o||(o=new Map,this._cellRuleCache.set(t,o));let r=o.get(n);return r||(r=new Map,o.set(n,r)),r}_ensureCellInfoMap(t,n){let o=this._cellInfoCache.get(t);o||(o=new Map,this._cellInfoCache.set(t,o));let r=o.get(n);return r||(r=new Map,o.set(n,r)),r}_ensureRowColInfoMap(t,n,o){let r=o==="row"?this._rowInfoCache.get(t):this._colInfoCache.get(t);r||(r=new Map,o==="row"?this._rowInfoCache.set(t,r):this._colInfoCache.set(t,r));let a=r.get(n);return a||(a=new Map,r.set(n,a)),a}_addCellRuleCache(t){const{subUnitId:n,unitId:o,rule:r}=t,a=this._ensureRuleMap(o,n);r.ranges.forEach(l=>{const{startRow:u,endRow:d,startColumn:c,endColumn:m}=l;for(let h=u;h<=d;h++)for(let R=c;R<=m;R++)a.set(`${h}-${R}`,r.id)}),this._permissionIdCache.set(r.permissionId,r.id)}_deleteCellRuleCache(t){const{subUnitId:n,unitId:o,rule:r}=t,a=this._ensureRuleMap(o,n),l=this._ensureCellInfoMap(o,n);r.ranges.forEach(u=>{const{startRow:d,endRow:c,startColumn:m,endColumn:h}=u;for(let R=d;R<=c;R++)for(let S=m;S<=h;S++)a.delete(`${R}-${S}`),l.delete(`${R}-${S}`)}),this._permissionIdCache.delete(r.permissionId)}_getSelectionActions(t,n,o){var c,m,h,R,S,C,I,v,w,p,M,y;const r=(h=(m=this._permissionService.getPermissionPoint((c=new ce(t,n,o.permissionId))==null?void 0:c.id))==null?void 0:m.value)!=null?h:!0,a=(C=(S=this._permissionService.getPermissionPoint((R=new sn(t,n,o.permissionId))==null?void 0:R.id))==null?void 0:S.value)!=null?C:!0,l=(w=(v=this._permissionService.getPermissionPoint((I=new Os(t,n,o.permissionId))==null?void 0:I.id))==null?void 0:v.value)!=null?w:!1,u=(y=(M=this._permissionService.getPermissionPoint((p=new ks(t,n,o.permissionId))==null?void 0:p.id))==null?void 0:M.value)!=null?y:!1;return{[_.Edit]:r,[_.View]:a,[_.ManageCollaborator]:l,[_.Delete]:u}}reBuildCache(t,n){const o=this._ensureRuleMap(t,n),r=this._ensureCellInfoMap(t,n);o.clear(),r.clear();const a=this._ensureRowColInfoMap(t,n,"row"),l=this._ensureRowColInfoMap(t,n,"col");a.clear(),l.clear(),this._ruleModel.getSubunitRuleList(t,n).forEach(u=>{const d=this._getSelectionActions(t,n,u),c={...d,ruleId:u.id,ranges:u.ranges};u.ranges.forEach(m=>{const{startRow:h,endRow:R,startColumn:S,endColumn:C}=m;for(let I=h;I<=R;I++){const v=a.get(`${I}`);v?v.set(u.id,d):a.set(`${I}`,new Map([[u.id,d]]));for(let w=S;w<=C;w++){o.set(`${I}-${w}`,u.id),r.set(`${I}-${w}`,c);const p=l.get(`${w}`);p?p.set(u.id,d):l.set(`${w}`,new Map([[u.id,d]]))}}}),this._permissionIdCache.set(u.permissionId,u.id)})}getRowPermissionInfo(t,n,o,r){var u;const a=(u=this._rowInfoCache.get(t))==null?void 0:u.get(n);if(!a)return!0;const l=a.get(`${o}`);return l?r.every(d=>{for(const c of l.values())if(c[d]===!1)return!1;return!0}):!0}getColPermissionInfo(t,n,o,r){var u;const a=(u=this._colInfoCache.get(t))==null?void 0:u.get(n);if(!a)return!0;const l=a.get(`${o}`);return l?r.every(d=>{for(const c of l.values())if(c[d]===!1)return!1;return!0}):!0}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe(A.filter(t=>t.type===N.SelectRange),A.map(t=>t)).subscribe({next:t=>{const{subUnitId:n,unitId:o,permissionId:r}=t,a=this._permissionIdCache.get(r);if(!a)return;const l=this._ruleModel.getRule(o,n,a);if(!l)return;const u=this._ensureRowColInfoMap(o,n,"row"),d=this._ensureRowColInfoMap(o,n,"col"),c=this._getSelectionActions(o,n,l);l.ranges.forEach(m=>{const{startRow:h,endRow:R,startColumn:S,endColumn:C}=m;for(let I=h;I<=R;I++){const v=u.get(`${I}`);v?v.set(a,c):u.set(`${I}`,new Map([[a,c]]));for(let w=S;w<=C;w++){const p=d.get(`${w}`);p?p.set(a,c):d.set(`${w}`,new Map([[a,c]]))}}})}}),this._ruleModel.ruleChange$.subscribe(t=>{if(t.type==="delete"){const{unitId:n,subUnitId:o,rule:r}=t,a=this._ensureRowColInfoMap(n,o,"row"),l=this._ensureRowColInfoMap(n,o,"col");r.ranges.forEach(u=>{const{startRow:d,endRow:c,startColumn:m,endColumn:h}=u;for(let R=d;R<=c;R++){const S=a.get(`${R}`);S==null||S.delete(r.id);for(let C=m;C<=h;C++){const I=l.get(`${C}`);I==null||I.delete(r.id)}}})}})}getCellInfo(t,n,o,r){var c,m;const a=this._ensureCellInfoMap(t,n),l=a.get(`${o}-${r}`);if(l)return l;const u=(m=(c=this._cellRuleCache.get(t))==null?void 0:c.get(n))==null?void 0:m.get(`${o}-${r}`);if(!u)return;const d=this._ruleModel.getRule(t,n,u);if(d){const R={...this._getSelectionActions(t,n,d),ruleId:u,ranges:d.ranges};return a.set(`${o}-${r}`,R),R}}deleteUnit(t){this._cellRuleCache.delete(t),this._cellInfoCache.delete(t),this._rowInfoCache.delete(t),this._colInfoCache.delete(t);const n=this._univerInstanceService.getUnit(t);n==null||n.getSheets().forEach(o=>{const r=o.getSheetId();this._ruleModel.getSubunitRuleList(t,r).forEach(a=>{this._permissionIdCache.delete(a.permissionId)})})}},g.RangeProtectionCache=fu([qs(0,i.Inject(J)),qs(1,i.Inject(i.IPermissionService)),qs(2,i.Inject(i.IUniverInstanceService))],g.RangeProtectionCache);var Iu=Object.getOwnPropertyDescriptor,vu=(s,e,t,n)=>{for(var o=n>1?void 0:n?Iu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},En=(s,e)=>(t,n)=>e(t,n,s);let Tn=class extends i.Disposable{constructor(s,e,t,n){super(),this._permissionService=s,this._worksheetProtectionRuleModel=e,this._sheetInterceptorService=t,this._rangeProtectionCache=n,this._initViewModelByRangeInterceptor(),this._initViewModelBySheetInterceptor()}_initViewModelByRangeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Pe.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s={},e,t)=>{const{unitId:n,subUnitId:o,row:r,col:a}=e,l=this._rangeProtectionCache.getCellInfo(n,o,r,a);if(l){const u=l[_.View]===!1,d={...s,selectionProtection:[l]};return u?(delete d.s,delete d.v,delete d.p,d):t(d)}return t(s)}}))}_initViewModelBySheetInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Pe.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s={},e,t)=>{var a,l,u,d,c;const{unitId:n,subUnitId:o}=e,r=this._worksheetProtectionRuleModel.getRule(n,o);if(r!=null&&r.permissionId){const m=[{[_.View]:(l=(a=this._permissionService.getPermissionPoint(new kt(n,o).id))==null?void 0:a.value)!=null?l:!1,[_.Edit]:(d=(u=this._permissionService.getPermissionPoint(new me(n,o).id))==null?void 0:u.value)!=null?d:!1}],h=!((c=m[0])!=null&&c[_.View]),R={...s,hasWorksheetRule:!0,selectionProtection:m};return h?(delete R.s,delete R.v,delete R.p,R):t(R)}return t(s)}}))}};Tn=vu([En(0,i.IPermissionService),En(1,i.Inject(we)),En(2,i.Inject(g.SheetInterceptorService)),En(3,i.Inject(g.RangeProtectionCache))],Tn);var pu=Object.getOwnPropertyDescriptor,wu=(s,e,t,n)=>{for(var o=n>1?void 0:n?pu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},gi=(s,e)=>(t,n)=>e(t,n,s);g.RangeProtectionRenderModel=class{constructor(e,t){f(this,"_cache",new i.LRUMap(1e4));this._selectionProtectionRuleModel=e,this._permissionService=t,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe(bt.filter(e=>e.type===N.SelectRange),bt.filter(e=>se().some(t=>e instanceof t)),bt.map(e=>e)).subscribe(e=>{const t=this._selectionProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId);for(const n of t)n.permissionId===e.permissionId&&n.ranges.forEach(o=>{i.Range.foreach(o,(r,a)=>{const l=this._createKey(e.unitId,e.subUnitId,r,a);this._cache.delete(l)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{var t;e.rule.ranges.forEach(n=>{i.Range.foreach(n,(o,r)=>{const a=this._createKey(e.unitId,e.subUnitId,o,r);this._cache.delete(a)})}),e.type==="set"&&((t=e.oldRule)==null||t.ranges.forEach(n=>{i.Range.foreach(n,(o,r)=>{const a=this._createKey(e.unitId,e.subUnitId,o,r);this._cache.delete(a)})}))})}_createKey(e,t,n,o){return`${e}_${t}_${n}_${o}`}getCellInfo(e,t,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(e,t),a=[];if(!r||!r.length)return a;const l=this._createKey(e,t,n,o),u=this._cache.get(l);if(u)return u;const d=[];for(const c of r)if(c.ranges.some(m=>m.startRow<=n&&m.endRow>=n&&m.startColumn<=o&&m.endColumn>=o)){const m=se().reduce((h,R)=>{var I;const S=new R(e,t,c.permissionId),C=this._permissionService.getPermissionPoint(S.id);return h[S.subType]=(I=C==null?void 0:C.value)!=null?I:S.value,h},{});d.push({...m,ruleId:c.id,ranges:c.ranges})}return this._cache.set(l,d),d}clear(){this._cache.clear()}},g.RangeProtectionRenderModel=wu([gi(0,i.Inject(J)),gi(1,i.Inject(i.IPermissionService))],g.RangeProtectionRenderModel);const Ys=i.createIdentifier("univer.exclusive-range-service");class Ri extends i.Disposable{constructor(){super(...arguments);f(this,"_exclusiveRanges",new Map);f(this,"_exclusiveRangesChange$",new A.Subject);f(this,"exclusiveRangesChange$",this._exclusiveRangesChange$.asObservable())}_ensureUnitMap(t){return this._exclusiveRanges.has(t)||this._exclusiveRanges.set(t,new Map),this._exclusiveRanges.get(t)}_ensureSubunitMap(t,n){const o=this._ensureUnitMap(t);return o.has(n)||o.set(n,new Map),o.get(n)}_ensureFeature(t,n,o){const r=this._ensureSubunitMap(t,n);return r.has(o)||r.set(o,[]),r.get(o)}addExclusiveRange(t,n,o,r){const a=this._ensureFeature(t,n,o);a.push(...r),this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:a.map(l=>l.range)})}getExclusiveRanges(t,n,o){var r,a;return(a=(r=this._exclusiveRanges.get(t))==null?void 0:r.get(n))==null?void 0:a.get(o)}clearExclusiveRanges(t,n,o){const r=this.getExclusiveRanges(t,n,o);this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:(r==null?void 0:r.map(a=>a.range))||[]}),this._ensureFeature(t,n,o),this._exclusiveRanges.get(t).get(n).set(o,[])}clearExclusiveRangesByGroupId(t,n,o,r){const a=this.getExclusiveRanges(t,n,o);this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:(a==null?void 0:a.map(u=>u.range))||[]});const l=this.getExclusiveRanges(t,n,o);if(l){const u=l.filter(d=>d.groupId!==r);this._exclusiveRanges.get(t).get(n).set(o,u)}}getInterestGroupId(t){const n=[];return t.forEach(o=>{var d;const r=o.range,{unitId:a,sheetId:l}=r;if(!a||!l)return;const u=(d=this._exclusiveRanges.get(a))==null?void 0:d.get(l);if(u)for(const c of u.keys()){const m=u.get(c);if(m){for(const h of m)if(i.Rectangle.intersects(r,h.range)){n.push(c);break}}}}),n}}var Mu=Object.getOwnPropertyDescriptor,yu=(s,e,t,n)=>{for(var o=n>1?void 0:n?Mu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ks=(s,e)=>(t,n)=>e(t,n,s);g.NumfmtService=class extends i.Disposable{constructor(e,t,n){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._logService=n}getValue(e,t,n,o){const r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(t);if(!a)return;const l=r.getStyles(),u=a.getCellRaw(n,o);if(u!=null&&u.s){const d=l.get(u.s);if(d!=null&&d.n)return d.n}return null}deleteValues(e,t,n){const o=this._univerInstanceService.getUniverSheetInstance(e);if(!o)return;const r=o==null?void 0:o.getSheetBySheetId(t);if(!r)return;const a=o.getStyles();n.forEach(l=>{i.Range.foreach(l,(u,d)=>{const c=r.getCellRaw(u,d);if(!c)return;const m=c==null?void 0:c.s,R={...m&&a.get(m)||{}};delete R.n;const S=a.setValue(R);c.s=S})})}setValues(e,t,n){const o=this._univerInstanceService.getUniverSheetInstance(e);if(!o)return;const r=o==null?void 0:o.getSheetBySheetId(t);if(!r)return;const a=o.getStyles(),l=r.getCellMatrix();n.forEach(u=>{u.ranges.forEach(d=>{i.Range.foreach(d,(c,m)=>{const h=r.getCellRaw(c,m);if(h){const S={...a.getStyleByCell(h)||{},n:{pattern:u.pattern}},C=a.setValue(S);h.s=C}else{const R={n:{pattern:u.pattern}},S=a.setValue(R);S&&l.setValue(c,m,{s:S})}})})})}},g.NumfmtService=yu([Ks(0,i.IResourceManagerService),Ks(1,i.IUniverInstanceService),Ks(2,i.ILogService)],g.NumfmtService);var _u=Object.getOwnPropertyDescriptor,bu=(s,e,t,n)=>{for(var o=n>1?void 0:n?_u(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Fe=(s,e)=>(t,n)=>e(t,n,s);const Si=[de.id,Ce.id,re.id,fe.id],Ci=[Ne.id,De.id];g.RangeProtectionRefRangeService=class extends i.Disposable{constructor(t,n,o,r,a,l,u,d){super();f(this,"disposableCollection",new i.DisposableCollection);this._selectionProtectionRuleModel=t,this._univerInstanceService=n,this._commandService=o,this._refRangeService=r,this._selectionProtectionRenderModel=a,this._rangeProtectionCache=l,this._sheetInterceptorService=u,this._rangeProtectionRuleModel=d,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){const t=(o,r)=>{const a=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!a||!(a==null?void 0:a.getSheetBySheetId(r)))return;this.disposableCollection.dispose();const u=c=>this.refRangeHandle(c,o,r);this._selectionProtectionRuleModel.getSubunitRuleList(o,r).reduce((c,m)=>[...c,...m.ranges],[]).forEach(c=>{this.disposableCollection.add(this._refRangeService.registerRefRange(c,u,o,r))})};this.disposeWithMe(this._commandService.onCommandExecuted(o=>{if(o.id===Ts.id){const r=o.params,a=r.subUnitId,l=r.unitId;if(!a||!l)return;t(l,a)}if(o.id===x.id||o.id===ue.id){const r=o.params,a=r.subUnitId,l=r.unitId;if(!a||!l)return;t(l,a)}}));const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(n){const o=n.getActiveSheet();if(!o)return;t(n.getUnitId(),o.getSheetId())}}refRangeHandle(t,n,o){switch(t.id){case Nt.id:return this._getRefRangeMutationsByMoveRows(t.params,n,o);case Dt.id:return this._getRefRangeMutationsByMoveCols(t.params,n,o);case ye.id:return this._getRefRangeMutationsByInsertRows(t.params,n,o);case _e.id:return this._getRefRangeMutationsByInsertCols(t.params,n,o);case Wt.id:return this._getRefRangeMutationsByDeleteCols(t.params,n,o);case At.id:return this._getRefRangeMutationsByDeleteRows(t.params,n,o)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(t,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(l=>l.ranges.some(u=>i.Rectangle.intersects(u,t.range))),a=t.range;if(r.length){const l=[],u=[];return r.forEach(d=>{const c=i.Tools.deepClone(d),m=c.ranges.reduce((h,R)=>{if(i.Rectangle.intersects(R,a)){const S=i.Tools.deepClone(R),{startColumn:C,endColumn:I}=a;if(C<=S.startColumn&&I>=S.endColumn)return h;C>=S.startColumn&&I<=S.endColumn?S.endColumn-=I-C+1:C<S.startColumn?(S.startColumn=C,S.endColumn-=I-C+1):I>S.endColumn&&(S.endColumn=C-1),this._checkIsRightRange(S)&&h.push(S)}return h},[]);c.ranges=m,c.ranges.length?(l.push({id:x.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:d.id}}),u.push({id:x.id,params:{unitId:n,subUnitId:o,rule:d,ruleId:d.id}})):(l.push({id:pe.id,params:{unitId:n,subUnitId:o,ruleIds:[d.id]}}),u.push({id:ue.id,params:{unitId:n,subUnitId:o,name:"",rules:[d]}}))}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(t,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(l=>l.ranges.some(u=>i.Rectangle.intersects(u,t.range))),a=t.range;if(r.length){const l=[],u=[];return r.forEach(d=>{const c=i.Tools.deepClone(d),m=c.ranges.reduce((h,R)=>{if(i.Rectangle.intersects(R,a)){const S=i.Tools.deepClone(R),{startRow:C,endRow:I}=a;if(C<=S.startRow&&I>=S.endRow)return h;C>=S.startRow&&I<=S.endRow?S.endRow-=I-C+1:C<S.startRow?(S.startRow=C,S.endRow-=I-C+1):I>S.endRow&&(S.endRow=C-1),this._checkIsRightRange(S)&&h.push(S)}return h},[]);c.ranges=m,l.push({id:x.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:d.id}}),u.push({id:x.id,params:{unitId:n,subUnitId:o,rule:d,ruleId:d.id}})}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(t,n,o){const r=t.range.startColumn,a=t.range.endColumn-t.range.startColumn+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(u=>u.ranges.some(d=>r>d.startColumn&&r<=d.endColumn));if(l.length){const u=[],d=[];return l.forEach(c=>{const m=i.Tools.deepClone(c);let h=!1;m.ranges.forEach(R=>{r>R.startColumn&&r<=R.endColumn&&(R.endColumn+=a,h=!0)}),h&&(u.push({id:x.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:c.id}}),d.push({id:x.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:c.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(t,n,o){const r=t.range.startRow,a=t.range.endRow-t.range.startRow+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(u=>u.ranges.some(d=>r>d.startRow&&r<=d.endRow));if(l.length){const u=[],d=[];return l.forEach(c=>{const m=i.Tools.deepClone(c);let h=!1;m.ranges.forEach(R=>{r>R.startRow&&r<=R.endRow&&(R.endRow+=a,h=!0)}),h&&(u.push({id:x.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:c.id}}),d.push({id:x.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:c.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(t,n,o){const r=t.toRange,a=r.startRow,l=r.endRow-r.startRow+1,u=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(d=>d.ranges.some(c=>a>c.startRow&&a<=c.endRow));if(u.length){const d=[],c=[];return u.forEach(m=>{const h=i.Tools.deepClone(m),S=t.fromRange.startRow;let C=!1;h.ranges.forEach(I=>{a>I.startRow&&a<=I.endRow&&(S<I.startRow&&(I.startRow=I.startRow-l,I.endRow=I.endRow-l),I.endRow+=l,C=!0)}),C&&(d.push({id:x.id,params:{unitId:n,subUnitId:o,rule:h,ruleId:m.id}}),c.push({id:x.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:m.id}}))}),{redos:d,undos:c}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(t,n,o){const r=t.toRange,a=r.startColumn,l=r.endColumn-r.startColumn+1,u=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(d=>d.ranges.some(c=>a>c.startColumn&&a<=c.endColumn));if(u.length){const d=[],c=[];return u.forEach(m=>{const h=i.Tools.deepClone(m),S=t.fromRange.startColumn;let C=!1;h.ranges.forEach(I=>{a>I.startColumn&&a<=I.endColumn&&(S<I.startColumn&&(I.startColumn=I.startColumn-l,I.endColumn=I.endColumn-l),I.endColumn+=l,C=!0)}),C&&(d.push({id:x.id,params:{unitId:n,subUnitId:o,rule:h,ruleId:m.id}}),c.push({id:x.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:m.id}}))}),{redos:d,undos:c}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(Ci.includes(t.id)){if(!t.params)return;const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!n)return;const o=n.getSheetBySheetId(t.params.subUnitId);if(!o)return;const{sourceRange:r,targetRange:a}=t.params,l=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,u=l?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,d=l?r.startRow:r.startColumn,c=l?a.startRow:a.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),o.getSheetId()).forEach(I=>{I.ranges.forEach(w=>{let{startRow:p,endRow:M,startColumn:y,endColumn:b}=w;i.Rectangle.intersects(w,r)||(l?d<p&&c>M?(p-=u,M-=u):d>M&&c<=p&&(p+=u,M+=u):d<y&&c>b?(y-=u,b-=u):d>b&&c<=y&&(y+=u,b+=u)),this._checkIsRightRange({startRow:p,endRow:M,startColumn:y,endColumn:b})&&(w.startColumn=y,w.endColumn=b,w.startRow=p,w.endRow=M)})}),this.disposableCollection.dispose();const{unitId:h,subUnitId:R}=t.params,S=I=>this.refRangeHandle(I,h,R);this._selectionProtectionRuleModel.getSubunitRuleList(h,R).reduce((I,v)=>[...I,...v.ranges],[]).forEach(I=>{this.disposableCollection.add(this._refRangeService.registerRefRange(I,S,h,R))}),this._selectionProtectionRenderModel.clear()}if(Si.includes(t.id)){const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const o=n.getSheetBySheetId(t.params.subUnitId);if(!o)return;const r=t.params;if(!r)return;const{range:a}=r,l=t.id.includes("row"),u=t.id.includes("insert"),d=l?a.startRow:a.startColumn,c=l?a.endRow:a.endColumn,m=c-d+1;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),o.getSheetId()).forEach(v=>{v.ranges.forEach(p=>{let{startRow:M,endRow:y,startColumn:b,endColumn:k}=p;u?l?d<=M&&(M+=m,y+=m):d<=b&&(b+=m,k+=m):l?c<M&&(M-=m,y-=m):c<b&&(b-=m,k-=m),this._checkIsRightRange({startRow:M,endRow:y,startColumn:b,endColumn:k})&&(p.startColumn=b,p.endColumn=k,p.startRow=M,p.endRow=y)})}),this.disposableCollection.dispose();const{unitId:R,subUnitId:S}=t.params,C=v=>this.refRangeHandle(v,R,S);this._selectionProtectionRuleModel.getSubunitRuleList(R,S).reduce((v,w)=>[...v,...w.ranges],[]).forEach(v=>{this.disposableCollection.add(this._refRangeService.registerRefRange(v,C,R,S))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(t){return t.startRow<=t.endRow&&t.startColumn<=t.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(Si.includes(t.id)||Ci.includes(t.id)){const{unitId:n,subUnitId:o}=t.params;this._rangeProtectionCache.reBuildCache(n,o)}}))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:t=>{const n=[],o=[],r=[],a=[];if(t.id===dn.id){const l=t.params,u=[],d=[];this._rangeProtectionRuleModel.getSubunitRuleList(l.unitId,l.subUnitId).forEach(c=>{u.push(c.id),d.push(c)}),u.length&&d.length&&(r.push({id:pe.id,params:{unitId:l.unitId,subUnitId:l.subUnitId,ruleIds:u}}),n.push({id:ue.id,params:{unitId:l.unitId,subUnitId:l.subUnitId,name:"",rules:d}}))}return{redos:o,undos:n,preRedos:r,preUndos:a}}})}},g.RangeProtectionRefRangeService=bu([Fe(0,i.Inject(J)),Fe(1,i.Inject(i.IUniverInstanceService)),Fe(2,i.ICommandService),Fe(3,i.Inject(g.RefRangeService)),Fe(4,i.Inject(g.RangeProtectionRenderModel)),Fe(5,i.Inject(g.RangeProtectionCache)),Fe(6,i.Inject(g.SheetInterceptorService)),Fe(7,i.Inject(J))],g.RangeProtectionRefRangeService);var Eu=Object.getOwnPropertyDescriptor,Tu=(s,e,t,n)=>{for(var o=n>1?void 0:n?Eu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},qt=(s,e)=>(t,n)=>e(t,n,s);const Uu="SHEET_RANGE_PROTECTION_PLUGIN";g.RangeProtectionService=class extends i.Disposable{constructor(e,t,n,o,r){super(),this._selectionProtectionRuleModel=e,this._permissionService=t,this._resourceManagerService=n,this._selectionProtectionCache=o,this._univerInstanceService=r,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":{se().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(n)});break}case"delete":{se().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break}case"set":{e.oldRule.permissionId!==e.rule.permissionId&&se().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);const o=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(o)});break}}}))}_initSnapshot(){const e=n=>{const r=this._selectionProtectionRuleModel.toObject()[n];return r?JSON.stringify(r):""},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:Uu,businesses:[nn.UNIVER_SHEET],onLoad:(n,o)=>{const r=this._selectionProtectionRuleModel.toObject();r[n]=o,this._selectionProtectionRuleModel.fromObject(r);const a=[];Object.keys(o).forEach(l=>{const u=o[l];this._selectionProtectionRuleModel.getSubunitRuleList(n,l).forEach(d=>{a.push({objectID:d.permissionId,unitID:n,objectType:N.SelectRange,actions:He})}),u.forEach(d=>{se().forEach(c=>{const m=new c(n,l,d.permissionId);m.value=!1,this._permissionService.addPermissionPoint(m)})}),this._selectionProtectionCache.reBuildCache(n,l)})},onUnLoad:n=>{this._selectionProtectionCache.deleteUnit(n)}}))}},g.RangeProtectionService=Tu([qt(0,i.Inject(J)),qt(1,i.Inject(i.IPermissionService)),qt(2,i.Inject(i.IResourceManagerService)),qt(3,i.Inject(g.RangeProtectionCache)),qt(4,i.Inject(i.IUniverInstanceService))],g.RangeProtectionService);var Pu=Object.getOwnPropertyDescriptor,ku=(s,e,t,n)=>{for(var o=n>1?void 0:n?Pu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ou=(s,e)=>(t,n)=>e(t,n,s);g.SheetRangeThemeService=class extends i.Disposable{constructor(e){super(),this._sheetRangeThemeModel=e}registerRangeTheme(e,t){this._sheetRangeThemeModel.registerRangeThemeStyle(e,t)}removeRangeThemeRule(e,t){this._sheetRangeThemeModel.removeRangeThemeRule(e,t)}getALLRegisterThemes(e){return this._sheetRangeThemeModel.getALLRegisteredTheme(e)}registerRangeThemeStyle(e,t){this._sheetRangeThemeModel.registerRangeThemeRule(e,t)}getAppliedRangeThemeStyle(e){return this._sheetRangeThemeModel.getRegisteredRangeThemeStyle(e)}getRegisteredRangeThemes(){return this._sheetRangeThemeModel.getRegisteredRangeThemes()}},g.SheetRangeThemeService=ku([Ou(0,i.Inject(g.SheetRangeThemeModel))],g.SheetRangeThemeService);var Nu=Object.getOwnPropertyDescriptor,Du=(s,e,t,n)=>{for(var o=n>1?void 0:n?Nu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Au=(s,e)=>(t,n)=>e(t,n,s);g.SheetSkeletonService=class extends i.Disposable{constructor(t){super();f(this,"_sheetSkeletonStore",new Map);this._injector=t,this.disposeWithMe(()=>{this._sheetSkeletonStore=new Map})}getSkeleton(t,n){if(this._sheetSkeletonStore.has(t))return this._sheetSkeletonStore.get(t).get(n)}setSkeleton(t,n,o){this._sheetSkeletonStore.has(t)||this._sheetSkeletonStore.set(t,new Map),this._sheetSkeletonStore.get(t).set(n,o)}deleteSkeleton(t,n){this._sheetSkeletonStore.has(t)&&this._sheetSkeletonStore.get(t).delete(n)}},g.SheetSkeletonService=Du([Au(0,i.Inject(i.Injector))],g.SheetSkeletonService);var Wu=Object.defineProperty,Vu=Object.getOwnPropertyDescriptor,Lu=(s,e,t)=>e in s?Wu(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$u=(s,e,t,n)=>{for(var o=n>1?void 0:n?Vu(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},fi=(s,e)=>(t,n)=>e(t,n,s),Ii=(s,e,t)=>Lu(s,typeof e!="symbol"?e+"":e,t);const Bu="SHEET_PLUGIN";g.UniverSheetsPlugin=class extends i.Plugin{constructor(e=Xr,t,n){super(),this._config=e,this._injector=t,this._configService=n;const{...o}=i.merge({},Xr,this._config);this._configService.setConfig(Pl,o),this._initConfig(),this._initDependencies()}_initConfig(){var e,t,n;(e=this._config)!=null&&e.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(Gr,!0),(t=this._config)!=null&&t.isRowStylePrecedeColumnStyle&&this._configService.setConfig(i.IS_ROW_STYLE_PRECEDE_COLUMN_STYLE,!0),(n=this._config)!=null&&n.autoHeightForMergedCells&&this._configService.setConfig(i.AUTO_HEIGHT_FOR_MERGED_CELLS,!0)}_initDependencies(){var t;const e=[[Je],[g.SheetsSelectionsService],[g.RefRangeService],[g.WorkbookPermissionService],[Ze,{useClass:g.NumfmtService}],[g.SheetInterceptorService],[g.SheetRangeThemeService],[g.SheetSkeletonService],[wn],[g.MergeCellController],[bn],[g.DefinedNameDataController],[g.WorksheetPermissionService],[we],[vt],[Tn],[g.SheetPermissionInitController],[g.SheetPermissionCheckController],[g.SheetRangeThemeModel],[g.RangeProtectionRenderModel],[J],[g.RangeProtectionCache],[g.RangeProtectionRefRangeService],[g.RangeProtectionService],[Ys,{useClass:Ri,deps:[g.SheetsSelectionsService]}]];(t=this._config)!=null&&t.notExecuteFormula||e.push([Mn]),i.registerDependencies(this._injector,i.mergeOverrideWithDependencies(e,this._config.override)),i.touchDependencies(this._injector,[[g.SheetInterceptorService],[g.RangeProtectionService],[Ys],[g.SheetPermissionInitController]])}onStarting(){i.touchDependencies(this._injector,[[wn],[g.MergeCellController],[g.WorkbookPermissionService],[g.WorksheetPermissionService],[Tn],[g.SheetSkeletonService]])}onRendered(){i.touchDependencies(this._injector,[[Ze]])}onReady(){i.touchDependencies(this._injector,[[Mn],[g.DefinedNameDataController],[g.SheetRangeThemeModel],[bn],[g.RangeProtectionRenderModel],[g.RangeProtectionRefRangeService],[g.RefRangeService],[g.SheetPermissionCheckController]])}},Ii(g.UniverSheetsPlugin,"pluginName",Bu),Ii(g.UniverSheetsPlugin,"type",i.UniverInstanceType.UNIVER_SHEET),g.UniverSheetsPlugin=$u([i.DependentOn(z.UniverFormulaEnginePlugin),fi(1,i.Inject(i.Injector)),fi(2,i.IConfigService)],g.UniverSheetsPlugin);var vi=(s=>(s.SET_WORKSHEET_ROW_HEIGHT="sheet.mutation.set-worksheet-row-height",s.SET_WORKSHEET_ROW_IS_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-is-auto-height",s.SET_WORKSHEET_ROW_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-auto-height",s.SET_WORKSHEET_COL_WIDTH="sheet.mutation.set-worksheet-col-width",s.SET_WORKSHEET_ACTIVE="sheet.operation.set-worksheet-active",s.MOVE_ROWS="sheet.mutation.move-rows",s.MOVE_COLUMNS="sheet.mutation.move-columns",s.SET_COL_HIDDEN="sheet.mutation.set-col-hidden",s.SET_COL_VISIBLE="sheet.mutation.set-col-visible",s.SET_ROW_HIDDEN="sheet.mutation.set-row-hidden",s.SET_ROW_VISIBLE="sheet.mutation.set-row-visible",s.INSERT_COL="sheet.mutation.insert-col",s.INSERT_ROW="sheet.mutation.insert-row",s.REMOVE_COL="sheet.mutation.remove-col",s.REMOVE_ROW="sheet.mutation.remove-rows",s.TOGGLE_GRIDLINES="sheet.mutation.toggle-gridlines",s.SET_GRIDLINES_COLOR="sheet.mutation.set-gridlines-color",s))(vi||{}),pi=(s=>(s.SET_RANGE_VALUES="sheet.mutation.set-range-values",s.MOVE_RANGE="sheet.mutation.move-range",s.REMOVE_WORKSHEET_MERGE="sheet.mutation.remove-worksheet-merge",s.ADD_WORKSHEET_MERGE="sheet.mutation.add-worksheet-merge",s.REORDER_RANGE="sheet.mutation.reorder-range",s.SET_WORKSHEET_DEFAULT_STYLE="sheet.mutation.set-worksheet-default-style",s.SET_ROW_DATA="sheet.mutation.set-row-data",s.SET_COL_DATA="sheet.mutation.set-col-data",s.SET_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.set-worksheet-range-theme-style",s.DELETE_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.delete-worksheet-range-theme-style",s))(pi||{});const Hu=[We.id,Re.id,Ds.id,Ae.id,Ct.id,Ne.id,De.id,ct.id,mt.id,St.id,Rt.id,de.id,Ce.id,re.id,fe.id,Mt.id,ht.id,wt.id,ft.id],ju=[B.id,Le.id,G.id,F.id,Vt.id,It.id,gt.id,dt.id,tt.id,nt.id];function Fu(s){switch(s.id){case"sheet.mutation.set-range-values":{const e=s.params,t=new i.ObjectMatrix(e.cellValue).getDataRange();return t.endRow===-1?[]:e.cellValue?[{unitId:e.unitId,subUnitId:e.subUnitId,range:t}]:[]}case"sheet.mutation.move-range":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.from.subUnitId,range:new i.ObjectMatrix(e.from.value).getRange()},{unitId:e.unitId,subUnitId:e.to.subUnitId,range:new i.ObjectMatrix(e.to.value).getRange()}]}case"sheet.mutation.remove-worksheet-merge":{const e=s.params;return e.ranges.map(t=>({unitId:e.unitId,subUnitId:e.subUnitId,range:t}))}case"sheet.mutation.add-worksheet-merge":{const e=s.params;return e.ranges.map(t=>({unitId:e.unitId,subUnitId:e.subUnitId,range:t}))}case"sheet.mutation.reorder-range":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}]}case"sheet.mutation.set-worksheet-default-style":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-row-data":{const e=s.params,t=Object.keys(e.rowData).map(Number);return t.length===0?[]:[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:Math.min(...t),endRow:Math.max(...t),startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-col-data":{const e=s.params,t=Object.keys(e.columnData).map(Number);return t.length===0?[]:[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:Math.min(...t),endColumn:Math.max(...t)}}]}case"sheet.mutation.set-worksheet-range-theme-style":case"sheet.mutation.delete-worksheet-range-theme-style":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}]}default:return[]}}function Gu(s,e){switch(s.id){case"sheet.mutation.set-worksheet-row-height":case"sheet.mutation.set-worksheet-row-is-auto-height":{const t=s.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-row-auto-height":{const t=s.params;return t.rowsAutoHeightInfo.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:n.row,endRow:n.row,startColumn:0,endColumn:e-1,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-col-width":{const t=s.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.move-rows":case"sheet.mutation.move-columns":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.targetRange},{unitId:t.unitId,subUnitId:t.subUnitId,range:t.sourceRange}]}case"sheet.mutation.set-col-hidden":case"sheet.mutation.set-col-visible":{const t=s.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.set-row-hidden":case"sheet.mutation.set-row-visible":{const t=s.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.insert-col":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.insert-row":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.remove-col":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.remove-rows":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.toggle-gridlines":case"sheet.mutation.set-gridlines-color":return[];default:return[]}}const zu=1.5,qu="rgba(255, 255, 255, 0.01)";function Yu(s){const{rangeWithCoord:e,primaryWithCoord:t,style:n}=s,o={range:{startRow:e.startRow,startColumn:e.startColumn,endRow:e.endRow,endColumn:e.endColumn,rangeType:e.rangeType,unitId:e.unitId,sheetId:e.sheetId},primary:null,style:n};return t!=null&&(o.primary=wi(t)),o}function wi(s){const{actualRow:e,actualColumn:t,isMerged:n,isMergedMainCell:o}=s,{startRow:r,startColumn:a,endRow:l,endColumn:u}=s.mergeInfo;return{actualRow:e,actualColumn:t,isMerged:n,isMergedMainCell:o,startRow:r,startColumn:a,endRow:l,endColumn:u}}const Ku=(s,e,t)=>{const o=s.get(g.SheetsSelectionsService).getCurrentSelections(),{value:r,selections:a,unitId:l,subUnitId:u}=e;if(o){const c=o[(o==null?void 0:o.length)-1].primary;if(c){const{actualColumn:m,actualRow:h}=c;let{startRow:R,startColumn:S,endRow:C,endColumn:I}=a[a.length-1];if(r===i.Dimension.COLUMNS){const M=t.find(y=>y.startColumn===m&&y.endColumn===m&&h===y.startRow);M&&(I=M.endColumn,R=M.startRow,C=M.endRow)}else if(r===i.Dimension.ROWS){const M=t.find(y=>y.startRow===h&&y.endRow===h&&m===y.startColumn);M&&(C=M.endRow,S=M.startColumn,I=M.endColumn)}const v={startRow:R,startColumn:S,endRow:C,endColumn:I,actualRow:h,actualColumn:m,isMerged:!0,isMergedMainCell:R===h&&S===m},w=o.map((M,y,b)=>({range:M.range,style:null,primary:y===b.length-1?v:null})),p={unitId:l,subUnitId:u,type:ee.ONLY_SET,selections:w};return{id:q.id,params:p}}return null}return null},Ju=(s,e)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections(),{unitId:o,subUnitId:r}=e;if(n&&n[(n==null?void 0:n.length)-1].primary){const u={unitId:o,subUnitId:r,type:ee.ONLY_SET,selections:[...n]};return{id:q.id,params:u}}return null};function Mi(s){return s==null?!1:s.v!==void 0&&s.v!==null&&s.v!==""||s.p!==void 0}function Un(s,e){return s&&s.spanAnchor?Mi(e.getValue(s.spanAnchor.startRow,s.spanAnchor.startColumn)):Mi(s)}function Xu(s,e,t,n,o){const r=s.getCellMatrix(),a=s.getSpanModel().getMergedCellRange(e,t,n,o),l=new i.ObjectMatrix;return r.forValue((u,d)=>{const c=r.getValue(u,d);c&&l.setValue(u,d,c)}),a.forEach(u=>{const{startColumn:d,startRow:c,endColumn:m,endRow:h}=u;i.createRowColIter(c,h,d,m).forEach((R,S)=>{R===c&&S===d&&l.setValue(R,S,{...r.getValue(R,S),spanAnchor:{startRow:c,endRow:h,startColumn:d,endColumn:m}}),(R!==c||S!==d)&&(l.realDeleteValue(R,S),l.setValue(R,S,{spanAnchor:{startRow:c,endRow:h,startColumn:d,endColumn:m}}))})}),l}function Zu(s,e,t,n){const{startRow:o,startColumn:r,endRow:a}=s;let l=null,u=!1;for(let d=o;d<=a;d++){const c=e.getValue(d,r-t);if(u=u||Un(c,e),!n&&u)break;c&&c.spanAnchor&&(l?l={startRow:Math.min(c.spanAnchor.startRow,l.startRow),startColumn:Math.min(c.spanAnchor.startColumn,l.startColumn),endRow:Math.max(c.spanAnchor.endRow,l.endRow),endColumn:Math.max(c.spanAnchor.endColumn,l.endColumn)}:l={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return u?(s.startColumn=s.startColumn-t,{spanAnchor:l,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function xu(s,e,t,n){const{startRow:o,endColumn:r,endRow:a}=s;let l=null,u=!1;for(let d=o;d<=a;d++){const c=e.getValue(d,r+t);if(u=u||Un(c,e),!n&&u)break;c&&c.spanAnchor&&(l?l={startRow:Math.min(c.spanAnchor.startRow,l.startRow),startColumn:Math.min(c.spanAnchor.startColumn,l.startColumn),endRow:Math.max(c.spanAnchor.endRow,l.endRow),endColumn:Math.max(c.spanAnchor.endColumn,l.endColumn)}:l={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return u?(s.endColumn=s.endColumn+t,{spanAnchor:l,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function Qu(s,e,t,n){const{startRow:o,startColumn:r,endColumn:a}=s;let l=null,u=!1;for(let d=r;d<=a;d++){const c=e.getValue(o-t,d);if(u=u||Un(c,e),!n&&u)break;c&&c.spanAnchor&&(l?l={startRow:Math.min(c.spanAnchor.startRow,l.startRow),startColumn:Math.min(c.spanAnchor.startColumn,l.startColumn),endRow:Math.max(c.spanAnchor.endRow,l.endRow),endColumn:Math.max(c.spanAnchor.endColumn,l.endColumn)}:l={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return u?(s.startRow=s.startRow-t,{spanAnchor:l,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function ed(s,e,t,n){const{startColumn:o,endColumn:r,endRow:a}=s;let l=null,u=!1;for(let d=o;d<=r;d++){const c=e.getValue(a+t,d);if(u=u||Un(c,e),!n&&u)break;c&&c.spanAnchor&&(l?l={startRow:Math.min(c.spanAnchor.startRow,l.startRow),startColumn:Math.min(c.spanAnchor.startColumn,l.startColumn),endRow:Math.max(c.spanAnchor.endRow,l.endRow),endColumn:Math.max(c.spanAnchor.endColumn,l.endColumn)}:l={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return u?(s.endRow=s.endRow+t,{spanAnchor:l,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function td(s,e,t){const n=t.getMaxRows(),o=t.getMaxColumns(),r=Xu(t,0,0,n-1,o-1),a=t.getSnapshot().mergeData.length>0,{left:l,right:u,up:d,down:c}=e;let m=!0,h={...s};const R=[];for(;m;){if(m=!1,d&&h.startRow!==0){const{hasValue:S,range:C,spanAnchor:I}=Qu(h,r,1,a);if(I&&R.push(I),S){h=C,m=!0;continue}}if(c&&h.endRow!==n-1){const{hasValue:S,range:C,spanAnchor:I}=ed(h,r,1,a);if(I&&R.push(I),S){h=C,m=!0;continue}}if(l&&h.startColumn!==0){const{hasValue:S,range:C,spanAnchor:I}=Zu(h,r,1,a);if(I&&R.push(I),S){h=C,m=!0;continue}}if(u&&h.endColumn!==o-1){const{hasValue:S,range:C,spanAnchor:I}=xu(h,r,1,a);if(I&&R.push(I),S){h=C,m=!0;continue}}}return R.length>0&&(h=i.Rectangle.union(h,...R)),h}const yi=(s,e,t,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,e),{startRow:l,endRow:u}=a;let d=t.startRow-n,c=e.getMergedCell(d,t.startColumn),m=!c||c.startRow===d&&c.startColumn===t.startColumn;for(;!e.getRowVisible(d)||!m;)d--,c=e.getMergedCell(d,t.startColumn),m=!c||c.startRow===d&&c.startColumn===t.startColumn;if(d>=l)return{...t,startRow:d,endRow:d};if(r){const h={...t,startRow:u,endRow:u};return bi(s,e,h,n,o,!1)}},_i=(s,e,t,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,e),{startRow:l,endRow:u}=a;let d=t.endRow+n,c=e.getMergedCell(d,t.startColumn),m=!c||c.startRow===d&&c.startColumn===t.startColumn;for(;!e.getRowVisible(d)||!m;)d++,c=e.getMergedCell(d,t.startColumn),m=!c||c.startRow===d&&c.startColumn===t.startColumn;if(d<=u)return{...t,startRow:d,endRow:d};if(r){const h={...t,startRow:l,endRow:l};return Ei(s,e,h,n,o,!1)}},bi=(s,e,t,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,e),{startColumn:l,endColumn:u}=a;let d=t.startColumn-n,c=e.getMergedCell(t.startRow,d),m=!c||c.startRow===t.startRow&&c.startColumn===d;for(;!e.getColVisible(d)||!m;)d--,c=e.getMergedCell(t.startRow,d),m=!c||c.startRow===t.startRow&&c.startColumn===d;if(d>=l)return{...t,startColumn:d,endColumn:d};if(r){const h={...t,startColumn:u,endColumn:u};return yi(s,e,h,n,o,!1)}},Ei=(s,e,t,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,e),{startColumn:l,endColumn:u}=a;let d=t.endColumn+n,c=e.getMergedCell(t.startRow,d),m=!c||c.startRow===t.startRow&&c.startColumn===d;for(;!e.getColVisible(d)||!m;)d++,c=e.getMergedCell(t.startRow,d),m=!c||c.startRow===t.startRow&&c.startColumn===d;if(d<=u)return{...t,endColumn:d,startColumn:d};if(r){const h={...t,startColumn:l,endColumn:l};return _i(s,e,h,n,o,!1)}};function Pn(s,e,t){let n=null;return t.getMatrixWithMergedCells(s,e,s,e).forValue((r,a,l)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:l.rowSpan!==void 0||l.colSpan!==void 0,isMergedMainCell:l.rowSpan!==void 0&&l.colSpan!==void 0,endRow:r+(l.rowSpan!==void 0?l.rowSpan-1:0),endColumn:a+(l.colSpan!==void 0?l.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:e,actualRow:s,startRow:s,startColumn:e,endRow:s,endColumn:e,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}const nd=(s,e,t,n,o=1)=>{switch(n){case i.Direction.UP:return yi(s,e,t,o);case i.Direction.DOWN:return _i(s,e,t,o);case i.Direction.LEFT:return bi(s,e,t,o);case i.Direction.RIGHT:return Ei(s,e,t,o)}},sd=(s,e,t)=>{let n,o=-1,r;for(let v=0;v<s.length;v++)if(s[v].primary){n=s[v],o=v,r=n.primary;break}if(o===-1)return null;const a=e===i.Direction.LEFT||e===i.Direction.UP,l=a?o-1>=0?o-1:s.length-1:o+1<s.length?o+1:0,u=s[l];if(!n||!r)return null;const d={...r},{startRow:c,startColumn:m,endRow:h,endColumn:R}=n.range,S=a?d.startRow===c&&d.startColumn===m:d.endRow===h&&d.endColumn===R,C=S&&a;if(!i.Rectangle.equals(n.range,d)){const v=S?u.range:nd(n.range,t,d,e);if(!v)return null;const w=C?Pn(v.endRow,v.endColumn,t):Pn(v.startRow,v.startColumn,t);return{startRow:w.startRow,startColumn:w.startColumn,endRow:w.endRow,endColumn:w.endColumn}}const I=C?Pn(u.range.endRow,u.range.endColumn,t):Pn(u.range.startRow,u.range.startColumn,t);return{startRow:I.startRow,startColumn:I.startColumn,endRow:I.endRow,endColumn:I.endColumn}},od={WorkbookCommentPermission:Ln,WorkbookCopyPermission:$n,WorkbookCreateProtectPermission:Bn,WorkbookCreateSheetPermission:Hn,WorkbookDeleteSheetPermission:jn,WorkbookDuplicatePermission:Fn,WorkbookEditablePermission:ae,WorkbookExportPermission:Gn,WorkbookHideSheetPermission:on,WorkbookHistoryPermission:_o,WorkbookManageCollaboratorPermission:rn,WorkbookMoveSheetPermission:an,WorkbookPrintPermission:zn,WorkbookRecoverHistoryPermission:qn,WorkbookRenameSheetPermission:ln,WorkbookSharePermission:Yn,WorkbookViewHistoryPermission:Jn,WorkbookViewPermission:Kn,WorksheetCopyPermission:Xn,WorksheetDeleteColumnPermission:Zn,WorksheetDeleteProtectionPermission:xn,WorksheetDeleteRowPermission:Qn,WorksheetEditExtraObjectPermission:es,WorksheetEditPermission:me,WorksheetFilterPermission:ts,WorksheetInsertColumnPermission:ns,WorksheetInsertHyperlinkPermission:ss,WorksheetInsertRowPermission:os,WorksheetManageCollaboratorPermission:rs,WorksheetPivotTablePermission:is,WorksheetSetCellStylePermission:as,WorksheetSetCellValuePermission:Pt,WorksheetSetColumnStylePermission:ot,WorksheetSetRowStylePermission:rt,WorksheetSortPermission:ls,WorksheetViewPermission:kt,RangeProtectionPermissionEditPoint:ce,RangeProtectionPermissionViewPoint:sn},rd=(s,e,t,n)=>{const o=s.get(i.IPermissionService),r=s.get(J),a=o.getPermissionPoint(new ae(e).id);if(!(a!=null&&a.value))return!1;const l=o.getPermissionPoint(new me(e,t).id);if(!(l!=null&&l.value))return!1;const d=r.getSubunitRuleList(e,t).filter(c=>c.ranges.some(m=>n.some(h=>i.Rectangle.intersects(m,h))));return d.length?d.every(c=>{const m=c.permissionId,h=o.getPermissionPoint(new ce(e,t,m).id);return!!(h!=null&&h.value)}):!0};function id(s,e){return e.some(t=>ad(s,t))}function ad(s,e){const{startRow:t,startColumn:n,endColumn:o,endRow:r}=e,a=s.getMatrixWithMergedCells(t,n,r,o);let l=!1;return a.forValue((u,d,c)=>{if(c&&(u!==t||d!==n)&&s.cellHasValue(c))return l=!0,!1}),l}function ld(s,e,t,n){const o=[],r=[],a=t.getSheetId();return n.forEach(l=>{const u=ud(t,l),d={unitId:e,subUnitId:a,cellValue:u.getData()},c=ie(s,d);o.push({id:B.id,params:c}),r.push({id:B.id,params:d})}),{undos:o,redos:r}}function ud(s,e){const{startRow:t,startColumn:n,endColumn:o,endRow:r}=e,a=s.getMatrixWithMergedCells(t,n,r,o,i.CellModeEnum.Raw),l=new i.ObjectMatrix;return a.forValue((u,d,c)=>{c&&(u!==t||d!==n)&&l.setValue(u,d,null)}),l}const Yt={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=e.unitId,a=e.subUnitId,l=e.selections,u=zs(l,e.value),d=o.getUniverSheetInstance(r).getSheetBySheetId(a),c=[],m=[],h=id(d,u),R={unitId:r,subUnitId:a,ranges:u},S={unitId:r,subUnitId:a,ranges:u};c.push({id:G.id,params:R}),c.push({id:F.id,params:S});const C=ne(s,R),I=he(s,S);if(m.push({id:G.id,params:I}),m.push({id:F.id,params:C}),h){const w=ld(s,r,d,u);c.unshift(...w.redos),m.push(...w.undos)}return i.sequenceExecute(c,t).result?(n.pushUndoRedo({unitID:r,undoMutations:m,redoMutations:c}),!0):!1}},dd={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:async s=>{var d;const e=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const l=r.getUnitId(),u=a.getSheetId();return e.executeCommand(Yt.id,{selections:n,unitId:l,subUnitId:u})}},cd={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:async s=>{var d;const e=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const l=r.getUnitId(),u=a.getSheetId();return e.executeCommand(Yt.id,{value:i.Dimension.COLUMNS,selections:n,unitId:l,subUnitId:u})}},md={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:async s=>{var d;const e=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const l=r.getUnitId(),u=a.getSheetId();return e.executeCommand(Yt.id,{value:i.Dimension.ROWS,selections:n,unitId:l,subUnitId:u})}};function hd(s,e,t,n,o){const r=s.get(i.IUniverInstanceService),a=T(r,{unitId:e,subUnitId:t});if(!a)return;const{worksheet:l}=a;if(l.getMergeData().some(m=>n.some(h=>i.Rectangle.intersects(h,m))))throw new Error("The ranges to be merged overlap with the existing merged cells");s.get(i.ICommandService).executeCommand(Yt.id,{unitId:e,subUnitId:t,selections:n,defaultMerge:o})}const gd=(s,e)=>{const r=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId).getSheetBySheetId(e.subUnitId).getConfig().rightToLeft;return{...i.Tools.deepClone(e),rightToLeft:r}},kn={id:"sheet.mutation.set-worksheet-right-to-left",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getSheetBySheetId(e.subUnitId);if(!n)return!1;const o=n.getConfig();return o.rightToLeft=e.rightToLeft,!0}},Rd={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-right-to-left",handler:async(s,e)=>{var m;const t=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=T(s.get(i.IUniverInstanceService),e);if(!o)return!1;const{unitId:r,subUnitId:a}=o;let l=i.BooleanNumber.FALSE;e&&(l=(m=e.rightToLeft)!=null?m:i.BooleanNumber.FALSE);const u={rightToLeft:l,unitId:r,subUnitId:a},d=gd(s,u);return t.syncExecuteCommand(kn.id,u)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:kn.id,params:d}],redoMutations:[{id:kn.id,params:u}]}),!0):!1}};g.AFTER_CELL_EDIT=Kt,g.AddMergeRedoSelectionsOperationFactory=Ku,g.AddMergeUndoMutationFactory=he,g.AddMergeUndoSelectionsOperationFactory=Ju,g.AddRangeProtectionCommand=Zs,g.AddRangeProtectionMutation=ue,g.AddRangeThemeMutation=Kr,g.AddWorksheetMergeAllCommand=dd,g.AddWorksheetMergeCommand=Yt,g.AddWorksheetMergeHorizontalCommand=md,g.AddWorksheetMergeMutation=F,g.AddWorksheetMergeVerticalCommand=cd,g.AddWorksheetProtectionCommand=xs,g.AddWorksheetProtectionMutation=Ve,g.AppendRowCommand=ho,g.BEFORE_CELL_EDIT=Nn,g.BorderStyleManagerService=Je,g.COMMAND_LISTENER_SKELETON_CHANGE=Hu,g.COMMAND_LISTENER_VALUE_CHANGE=ju,g.CancelFrozenCommand=ir,g.ClearSelectionAllCommand=xt,g.ClearSelectionContentCommand=Qt,g.ClearSelectionFormatCommand=en,g.CopySheetCommand=Vn,g.DISABLE_NORMAL_SELECTIONS=Sa,g.DeleteRangeMoveLeftCommand=Ye,g.DeleteRangeMoveUpCommand=Ke,g.DeleteRangeProtectionCommand=To,g.DeleteRangeProtectionMutation=pe,g.DeleteWorksheetProtectionCommand=Uo,g.DeleteWorksheetProtectionMutation=Ge,g.DeleteWorksheetRangeThemeStyleCommand=Po,g.DeleteWorksheetRangeThemeStyleMutation=nt,g.DeleteWorksheetRangeThemeStyleMutationFactory=ao,g.DeltaColumnWidthCommand=hn,g.DeltaRowHeightCommand=Cn,g.EditStateEnum=Xs,g.EffectRefRangId=D,g.EmptyMutation=$r,g.ExclusiveRangeService=Ri,g.FactoryAddRangeProtectionMutation=Pi,g.FactoryDeleteRangeProtectionMutation=Ui,g.FactorySetRangeProtectionMutation=Ya,g.IExclusiveRangeService=Ys,g.INTERCEPTOR_POINT=Pe,g.INumfmtService=Ze,g.IRefSelectionsService=vo,g.InsertColAfterCommand=$o,g.InsertColBeforeCommand=Lo,g.InsertColByRangeCommand=hs,g.InsertColCommand=_e,g.InsertColMutation=de,g.InsertColMutationUndoFactory=Et,g.InsertDefinedNameCommand=ko,g.InsertMultiColsLeftCommand=Bo,g.InsertMultiColsRightCommand=Ho,g.InsertMultiRowsAboveCommand=Ao,g.InsertMultiRowsAfterCommand=Wo,g.InsertRangeMoveDownCommand=at,g.InsertRangeMoveRightCommand=Ot,g.InsertRowAfterCommand=Do,g.InsertRowBeforeCommand=No,g.InsertRowByRangeCommand=ms,g.InsertRowCommand=ye,g.InsertRowMutation=Ce,g.InsertRowMutationUndoFactory=Xt,g.InsertSheetCommand=jo,g.InsertSheetMutation=st,g.InsertSheetUndoMutationFactory=Wn,g.InterceptCellContentPriority=Qs,g.MAX_CELL_PER_SHEET_KEY=zr,g.MERGE_CELL_INTERCEPTOR_CHECK=hi,g.MoveColsCommand=Dt,g.MoveColsMutation=De,g.MoveColsMutationUndoFactory=Go,g.MoveRangeCommand=qe,g.MoveRangeMutation=Le,g.MoveRowsCommand=Nt,g.MoveRowsMutation=Ne,g.MoveRowsMutationUndoFactory=Fo,g.OperatorType=V,g.PermissionPointsDefinitions=od,g.REF_SELECTIONS_ENABLED=Co,g.RangeMergeUtil=wl,g.RangeProtectionPermissionDeleteProtectionPoint=ks,g.RangeProtectionPermissionEditPoint=ce,g.RangeProtectionPermissionManageCollaPoint=Os,g.RangeProtectionPermissionViewPoint=sn,g.RangeProtectionRuleModel=J,g.RangeThemeStyle=ke,g.RegisterWorksheetRangeThemeStyleCommand=Ko,g.RegisterWorksheetRangeThemeStyleMutation=lt,g.RemoveColByRangeCommand=fs,g.RemoveColCommand=Wt,g.RemoveColMutation=re,g.RemoveDefinedNameCommand=gs,g.RemoveMergeUndoMutationFactory=ne,g.RemoveNumfmtMutation=Ls,g.RemoveRangeThemeMutation=Yr,g.RemoveRowByRangeCommand=Ss,g.RemoveRowCommand=At,g.RemoveRowMutation=fe,g.RemoveSheetCommand=dn,g.RemoveSheetMutation=ze,g.RemoveSheetUndoMutationFactory=fo,g.RemoveWorksheetMergeCommand=Jo,g.RemoveWorksheetMergeMutation=G,g.ReorderRangeCommand=cn,g.ReorderRangeMutation=Vt,g.ReorderRangeUndoMutationFactory=Xo,g.ResetBackgroundColorCommand=Rr,g.ResetTextColorCommand=hr,g.SCOPE_WORKBOOK_VALUE_DEFINED_NAME=Dl,g.SELECTIONS_ENABLED=Ca,g.SELECTION_CONTROL_BORDER_BUFFER_COLOR=qu,g.SELECTION_CONTROL_BORDER_BUFFER_WIDTH=zu,g.ScrollToCellOperation=Fr,g.SelectRangeCommand=wo,g.SelectionMoveType=ee,g.SetBackgroundColorCommand=gr,g.SetBoldCommand=xa,g.SetBorderBasicCommand=tr,g.SetBorderColorCommand=er,g.SetBorderCommand=ut,g.SetBorderPositionCommand=xo,g.SetBorderStyleCommand=Qo,g.SetColDataCommand=sr,g.SetColDataMutation=dt,g.SetColDataMutationFactory=nr,g.SetColHiddenCommand=ps,g.SetColHiddenMutation=ct,g.SetColVisibleMutation=mt,g.SetColWidthCommand=Ht,g.SetDefinedNameCommand=ws,g.SetFontFamilyCommand=sl,g.SetFontSizeCommand=ol,g.SetFrozenCommand=rr,g.SetFrozenMutation=$e,g.SetFrozenMutationFactory=Ms,g.SetGridlinesColorCommand=ar,g.SetGridlinesColorMutation=ht,g.SetHorizontalTextAlignCommand=Cr,g.SetItalicCommand=Qa,g.SetNumfmtMutation=vn,g.SetOverlineCommand=nl,g.SetProtectionCommand=lr,g.SetRangeProtectionMutation=x,g.SetRangeThemeMutation=qr,g.SetRangeValuesCommand=it,g.SetRangeValuesMutation=B,g.SetRangeValuesUndoMutationFactory=ie,g.SetRowDataCommand=dr,g.SetRowDataMutation=gt,g.SetRowDataMutationFactory=ur,g.SetRowHeightCommand=fn,g.SetRowHiddenCommand=_s,g.SetRowHiddenMutation=St,g.SetRowVisibleMutation=Rt,g.SetSelectedColsVisibleCommand=vs,g.SetSelectedRowsVisibleCommand=ys,g.SetSelectionsOperation=q,g.SetSpecificColsVisibleCommand=Lt,g.SetSpecificRowsVisibleCommand=$t,g.SetStrikeThroughCommand=tl,g.SetStyleCommand=Q,g.SetTabColorCommand=vr,g.SetTabColorMutation=Bt,g.SetTextColorCommand=mr,g.SetTextRotationCommand=Ir,g.SetTextWrapCommand=fr,g.SetUnderlineCommand=el,g.SetVerticalTextAlignCommand=Sr,g.SetWorkbookNameCommand=Es,g.SetWorkbookNameMutation=bs,g.SetWorksheetActivateCommand=Ts,g.SetWorksheetActiveOperation=Ct,g.SetWorksheetColWidthMutation=Ae,g.SetWorksheetColWidthMutationFactory=Us,g.SetWorksheetColumnCountCommand=wr,g.SetWorksheetColumnCountMutation=ft,g.SetWorksheetColumnCountUndoMutationFactory=pr,g.SetWorksheetDefaultStyleCommand=yr,g.SetWorksheetDefaultStyleMutation=It,g.SetWorksheetDefaultStyleMutationFactory=Mr,g.SetWorksheetHideCommand=br,g.SetWorksheetHideMutation=Be,g.SetWorksheetNameCommand=gn,g.SetWorksheetNameMutation=jt,g.SetWorksheetOrderCommand=Ps,g.SetWorksheetOrderMutation=Ft,g.SetWorksheetPermissionPointsCommand=Tr,g.SetWorksheetPermissionPointsMutation=Sn,g.SetWorksheetProtectionCommand=Ur,g.SetWorksheetProtectionMutation=Xe,g.SetWorksheetRangeThemeStyleCommand=lo,g.SetWorksheetRangeThemeStyleMutation=tt,g.SetWorksheetRangeThemeStyleMutationFactory=io,g.SetWorksheetRightToLeftCommand=Rd,g.SetWorksheetRightToLeftMutation=kn,g.SetWorksheetRowAutoHeightMutation=Ds,g.SetWorksheetRowAutoHeightMutationFactory=Rl,g.SetWorksheetRowCountCommand=kr,g.SetWorksheetRowCountMutation=wt,g.SetWorksheetRowCountUndoMutationFactory=Pr,g.SetWorksheetRowHeightMutation=We,g.SetWorksheetRowIsAutoHeightCommand=In,g.SetWorksheetRowIsAutoHeightMutation=Re,g.SetWorksheetShowCommand=As,g.SheetSkeletonChangeType=vi,g.SheetValueChangeType=pi,g.SplitDelimiterEnum=Nr,g.SplitTextToColumnsCommand=Ar,g.ToggleCellCheckboxCommand=Wr,g.ToggleGridlinesCommand=Vr,g.ToggleGridlinesMutation=Mt,g.UnitAction=_,g.UnitObject=N,g.UnregisterWorksheetRangeThemeStyleCommand=Lr,g.UnregisterWorksheetRangeThemeStyleMutation=un,g.VALIDATE_CELL=Jt,g.ViewStateEnum=Js,g.WorkbookCommentPermission=Ln,g.WorkbookCopyPermission=$n,g.WorkbookCopySheetPermission=yo,g.WorkbookCreateProtectPermission=Bn,g.WorkbookCreateSheetPermission=Hn,g.WorkbookDeleteSheetPermission=jn,g.WorkbookDuplicatePermission=Fn,g.WorkbookEditablePermission=ae,g.WorkbookExportPermission=Gn,g.WorkbookHideSheetPermission=on,g.WorkbookHistoryPermission=_o,g.WorkbookManageCollaboratorPermission=rn,g.WorkbookMoveSheetPermission=an,g.WorkbookPrintPermission=zn,g.WorkbookRecoverHistoryPermission=qn,g.WorkbookRenameSheetPermission=ln,g.WorkbookSelectionModel=So,g.WorkbookSharePermission=Yn,g.WorkbookViewHistoryPermission=Jn,g.WorkbookViewPermission=Kn,g.WorksheetCopyPermission=Xn,g.WorksheetDeleteColumnPermission=Zn,g.WorksheetDeleteProtectionPermission=xn,g.WorksheetDeleteRowPermission=Qn,g.WorksheetEditExtraObjectPermission=es,g.WorksheetEditPermission=me,g.WorksheetFilterPermission=ts,g.WorksheetInsertColumnPermission=ns,g.WorksheetInsertHyperlinkPermission=ss,g.WorksheetInsertRowPermission=os,g.WorksheetManageCollaboratorPermission=rs,g.WorksheetPivotTablePermission=is,g.WorksheetProtectionPointModel=vt,g.WorksheetProtectionRuleModel=we,g.WorksheetSelectProtectedCellsPermission=Ea,g.WorksheetSelectUnProtectedCellsPermission=Ta,g.WorksheetSetCellStylePermission=as,g.WorksheetSetCellValuePermission=Pt,g.WorksheetSetColumnStylePermission=ot,g.WorksheetSetRowStylePermission=rt,g.WorksheetSortPermission=ls,g.WorksheetViewPermission=kt,g.addMergeCellsUtil=hd,g.adjustRangeOnMutation=ii,g.alignToMergedCellsBorders=Ut,g.baseProtectionActions=He,g.checkCellValueType=Dn,g.checkRangesEditablePermission=rd,g.convertPrimaryWithCoordToPrimary=wi,g.convertSelectionDataToRange=Yu,g.copyRangeStyles=Oe,g.createTopMatrixFromMatrix=Hr,g.createTopMatrixFromRanges=Br,g.defaultWorkbookPermissionPoints=Er,g.defaultWorksheetPermissionPoint=Rn,g.expandToContinuousRange=td,g.factoryRemoveNumfmtUndoMutation=yl,g.factorySetNumfmtUndoMutation=Ml,g.findAllRectangle=Ws,g.followSelectionOperation=Me,g.generateNullCell=An,g.generateNullCellValue=go,g.getAddMergeMutationRangeByType=zs,g.getAllRangePermissionPoint=se,g.getAllWorkbookPermissionPoint=pt,g.getAllWorksheetPermissionPoint=oe,g.getAllWorksheetPermissionPointByPointPanel=ge,g.getCellAtRowCol=Ia,g.getDefaultRangePermission=ul,g.getInsertRangeMutations=us,g.getMoveRangeUndoRedoMutations=tn,g.getNextPrimaryCell=sd,g.getPrimaryForRange=te,g.getRemoveRangeMutations=ds,g.getSelectionsService=po,g.getSeparateEffectedRangesOnCommand=Zl,g.getSheetCommandTarget=T,g.getSheetCommandTargetWorkbook=ro,g.getSheetMutationTarget=Se,g.getSkeletonChangedEffectedRange=Gu,g.getValueChangedEffectedRange=Fu,g.getVisibleRanges=Tt,g.handleBaseInsertRange=Qe,g.handleBaseMoveRowsCols=Gt,g.handleBaseRemoveRange=xe,g.handleCommonDefaultRangeChangeWithEffectRefCommands=Gs,g.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests=Jl,g.handleDefaultRangeChangeWithEffectRefCommands=Fs,g.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests=Kl,g.handleDeleteRangeMoveLeft=oi,g.handleDeleteRangeMoveUp=ri,g.handleDeleteRangeMutation=Pa,g.handleIRemoveCol=js,g.handleIRemoveRow=Qr,g.handleInsertCol=ti,g.handleInsertRangeMoveDown=ni,g.handleInsertRangeMoveRight=si,g.handleInsertRangeMutation=Ua,g.handleInsertRow=ei,g.handleMoveCols=Hs,g.handleMoveRange=xr,g.handleMoveRows=Bs,g.isSingleCellSelection=pa,g.rangeMerge=Vs,g.rangeToDiscreteRange=Ro,g.rotateRange=le,g.runRefRangeMutations=et,g.setEndForRange=va,g.splitRangeText=Dr,g.transformCellsToRange=pn,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
